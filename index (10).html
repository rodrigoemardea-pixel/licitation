<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDR6IIRzs2NPutCi2S8LTs8HTAq49zI9KE",
    authDomain: "licitationbiznis.firebaseapp.com",
    projectId: "licitationbiznis",
    storageBucket: "licitationbiznis.firebasestorage.app",
    messagingSenderId: "913302404751",
    appId: "1:913302404751:web:edf4925f479d2f811abafa"
  };
  firebase.initializeApp(firebaseConfig);
  const fbAuth = firebase.auth();
  const fbDB  = firebase.firestore();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LicitationBiznis ¬∑ Gest√£o de Licita√ß√µes</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: #f0f3f8;
    color: #1a2639;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background-color 0.3s, color 0.3s;
  }

  /* Vari√°veis - TEMA CLARO (padr√£o) */
  body[data-theme="light"] {
    --bg-primary: #f0f3f8;
    --bg-surface: #ffffff;
    --bg-surface-hover: #f8fafd;
    --bg-surface-soft: #f1f4f9;
    --bg-inset: #eef2f6;
    
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-focus: #3b82f6;
    
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-tertiary: #64748b;
    --text-placeholder: #94a3b8;
    
    --accent-primary: #2563eb;
    --accent-secondary: #3b82f6;
    --accent-gradient: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
    
    --success: #059669;
    --success-soft: rgba(5, 150, 105, 0.1);
    --warning: #d97706;
    --warning-soft: rgba(217, 119, 6, 0.1);
    --danger: #dc2626;
    --danger-soft: rgba(220, 38, 38, 0.1);
    --info: #2563eb;
    --info-soft: rgba(37, 99, 235, 0.1);
    --purple: #7c3aed;
    --purple-soft: rgba(124, 58, 237, 0.1);
    
    --chart-1: #2563eb;
    --chart-2: #7c3aed;
    --chart-3: #059669;
    --chart-4: #d97706;
    --chart-5: #dc2626;
    
    --sort-asc: #2563eb;
    --sort-desc: #dc2626;
  }

  /* Vari√°veis - TEMA ESCURO */
  body[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-surface: #1e293b;
    --bg-surface-hover: #2d3a4f;
    --bg-surface-soft: #334155;
    --bg-inset: #0f172a;
    
    --border-light: #334155;
    --border-medium: #475569;
    --border-focus: #60a5fa;
    
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #94a3b8;
    --text-placeholder: #64748b;
    
    --accent-primary: #3b82f6;
    --accent-secondary: #60a5fa;
    --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    
    --success: #10b981;
    --success-soft: rgba(16, 185, 129, 0.15);
    --warning: #f59e0b;
    --warning-soft: rgba(245, 158, 11, 0.15);
    --danger: #ef4444;
    --danger-soft: rgba(239, 68, 68, 0.15);
    --info: #3b82f6;
    --info-soft: rgba(59, 130, 246, 0.15);
    --purple: #8b5cf6;
    --purple-soft: rgba(139, 92, 246, 0.15);
    
    --chart-1: #3b82f6;
    --chart-2: #8b5cf6;
    --chart-3: #10b981;
    --chart-4: #f59e0b;
    --chart-5: #ef4444;
    
    --sort-asc: #3b82f6;
    --sort-desc: #ef4444;
  }

  :root {
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.02);
    --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.01);
    
    --nao-recebido-bg: #fff3cd;
    --nao-recebido-border: #ffc107;
    --nao-recebido-hover: #ffe69c;
  }

  body[data-theme="dark"] .nao-recebido {
    --nao-recebido-bg: #5f4c1a;
    --nao-recebido-border: #f59e0b;
    --nao-recebido-hover: #7a601f;
  }

  /* HEADER MODERNO */
  header {
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(226,232,240,0.6);
    padding: 0 24px;
    display: flex;
    align-items: center;
    gap: 24px;
    height: 64px;
    position: sticky;
    top: 0;
    z-index: 100;
    transition: background 0.3s;
  }

  body[data-theme="dark"] header {
    background: rgba(30, 41, 59, 0.8);
    border-bottom-color: rgba(51, 65, 85, 0.6);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: var(--accent-gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    box-shadow: 0 6px 12px -6px rgba(37,99,235,0.4);
  }

  .logo-text {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .logo-sub {
    font-size: 10px;
    color: var(--text-tertiary);
    letter-spacing: 0.3px;
    margin-top: 2px;
  }

  .spacer { flex: 1; }

  /* SELETOR DE TEMA */
  .theme-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-surface-soft);
    padding: 4px 12px;
    border-radius: 30px;
    border: 1px solid var(--border-light);
  }
  
  .theme-selector label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }
  
  .theme-selector select {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 20px;
    padding: 4px 24px 4px 10px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    outline: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }
  
  .theme-selector select:hover {
    border-color: var(--accent-primary);
  }

  /* SELETOR DE ANALISTA */
  .analista-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-surface-soft);
    padding: 4px 12px;
    border-radius: 30px;
    border: 1px solid var(--border-light);
  }
  
  .analista-selector label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }
  
  .analista-selector select {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 20px;
    padding: 4px 24px 4px 10px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    outline: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }
  
  .analista-selector select:hover {
    border-color: var(--accent-primary);
  }

  /* DICA DE ATALHOS */
  .shortcuts-hint {
    font-size: 11px;
    color: var(--text-tertiary);
    background: var(--bg-surface-soft);
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--border-light);
  }
  
  .shortcuts-hint kbd {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    margin: 0 2px;
  }

  .header-stats {
    display: flex;
    gap: 24px;
  }

  .hstat {
    text-align: right;
  }

  .hstat-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 600;
    color: var(--success);
  }

  .hstat-label {
    font-size: 10px;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* TABS */
  .tabs {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    padding: 0 24px;
    gap: 4px;
    transition: background 0.3s;
  }

  body[data-theme="dark"] .tabs {
    background: rgba(30, 41, 59, 0.7);
  }

  .tab-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    padding: 12px 16px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    letter-spacing: -0.2px;
  }

  .tab-btn:hover {
    color: var(--text-primary);
    background: rgba(0,0,0,0.02);
  }

  body[data-theme="dark"] .tab-btn:hover {
    background: rgba(255,255,255,0.05);
  }

  .tab-btn.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
    font-weight: 600;
  }

  .tab-badge {
    background: var(--bg-surface-soft);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 30px;
    font-weight: 500;
  }

  .tab-btn.active .tab-badge {
    background: var(--info-soft);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  /* CONTE√öDO PRINCIPAL */
  .content {
    flex: 1;
    padding: 20px 24px;
    width: 100%;
    max-width: 100%;
    margin: 0;
  }

  .tab-pane { display: none; }
  .tab-pane.active { display: block; }

  /* DASHBOARD */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  .chart-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-md);
  }

  .chart-card h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chart-card canvas {
    width: 100% !important;
    height: 250px !important;
  }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-top: 20px;
  }

  .stat-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 16px;
    text-align: center;
  }

  .stat-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent-primary);
    font-family: 'JetBrains Mono', monospace;
  }

  .stat-card .label {
    font-size: 11px;
    color: var(--text-tertiary);
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* TOOLBAR COMPACTA */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    background: var(--bg-surface);
    padding: 10px 16px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
  }

  .quick-entry-btn {
    background: var(--success-soft);
    color: var(--success);
    border: 1px solid var(--success);
  }
  .quick-entry-btn:hover {
    background: var(--success);
    color: white;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-surface-soft);
    padding: 4px 10px;
    border-radius: 30px;
    border: 1px solid var(--border-light);
  }
  
  .filter-group label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }
  
  .filter-group select {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 20px;
    padding: 4px 24px 4px 8px;
    font-size: 11px;
    color: var(--text-primary);
    cursor: pointer;
    outline: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
  }
  
  .filter-group select:hover {
    border-color: var(--accent-primary);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: var(--radius-md);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s ease;
    letter-spacing: -0.2px;
  }

  .btn-primary {
    background: var(--accent-primary);
    color: white;
    box-shadow: 0 2px 4px rgba(37,99,235,0.2);
  }
  .btn-primary:hover { background: var(--accent-secondary); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(37,99,235,0.3); }

  .btn-ghost {
    background: var(--bg-surface);
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
  }
  .btn-ghost:hover { background: var(--bg-surface-hover); border-color: var(--border-medium); color: var(--text-primary); }

  .btn-danger {
    background: var(--danger-soft);
    color: var(--danger);
    border: 1px solid rgba(220,38,38,0.2);
  }
  .btn-danger:hover { background: rgba(220,38,38,0.15); }

  .btn-sm {
    padding: 4px 8px;
    font-size: 11px;
    gap: 4px;
  }

  .search-box {
    flex: 1;
    min-width: 240px;
    max-width: 320px;
    position: relative;
  }

  .search-box input {
    width: 100%;
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 30px;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    padding: 8px 14px 8px 38px;
    outline: none;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }

  .search-box input:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  .search-box::before {
    content: 'üîç';
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 13px;
    pointer-events: none;
    opacity: 0.6;
  }

  /* CARDS DE RESUMO */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 16px;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }

  .card:hover {
    border-color: var(--border-medium);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .card-label {
    font-size: 11px;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .card-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 600;
    line-height: 1.2;
  }

  .cv-green { color: var(--success); }
  .cv-yellow { color: var(--warning); }
  .cv-red { color: var(--danger); }
  .cv-blue { color: var(--accent-primary); }
  .cv-purple { color: var(--purple); }

  /* TABELA */
  .table-wrapper {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow-x: auto;
    box-shadow: var(--shadow-md);
    width: 100%;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: auto;
    min-width: 100%;
  }

  thead {
    background: var(--bg-surface-soft);
    border-bottom: 1px solid var(--border-light);
  }

  th {
    padding: 12px 8px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--text-tertiary);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    position: relative;
    transition: color 0.2s;
  }

  th:hover {
    color: var(--text-primary);
    background: var(--bg-surface-hover);
  }

  th.sort-asc::after {
    content: ' ‚Üë';
    color: var(--sort-asc);
    font-weight: bold;
  }

  th.sort-desc::after {
    content: ' ‚Üì';
    color: var(--sort-desc);
    font-weight: bold;
  }

  td {
    padding: 10px 8px;
    border-bottom: 1px solid var(--border-light);
    vertical-align: middle;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--bg-surface-hover); color: var(--text-primary); }

  td.mono { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
  td.hi { color: var(--text-primary); font-weight: 500; }

  /* Tooltip para observa√ß√µes */
  td.has-tooltip {
    position: relative;
    cursor: help;
    border-bottom: 1px dashed var(--text-tertiary);
  }

  .tooltip-content {
    visibility: hidden;
    position: absolute;
    z-index: 1000;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 11px;
    color: var(--text-primary);
    white-space: normal;
    max-width: 250px;
    word-wrap: break-word;
    box-shadow: var(--shadow-lg);
    margin-bottom: 8px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: var(--border-light) transparent transparent transparent;
  }

  td.has-tooltip:hover .tooltip-content {
    visibility: visible;
    opacity: 1;
  }

  /* Destaque para empenhos n√£o recebidos */
  tr.nao-recebido {
    background-color: var(--nao-recebido-bg);
    border-left: 3px solid var(--nao-recebido-border);
  }

  tr.nao-recebido:hover td {
    background-color: var(--nao-recebido-hover);
  }

  /* BADGES */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    border-radius: 30px;
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    letter-spacing: 0.2px;
  }

  .bg { background: var(--success-soft); color: var(--success); border: 1px solid rgba(5,150,105,0.2); }
  .bb { background: var(--info-soft); color: var(--accent-primary); border: 1px solid rgba(37,99,235,0.2); }
  .by { background: var(--warning-soft); color: var(--warning); border: 1px solid rgba(217,119,6,0.2); }
  .br { background: var(--danger-soft); color: var(--danger); border: 1px solid rgba(220,38,38,0.2); }
  .bp { background: var(--purple-soft); color: var(--purple); border: 1px solid rgba(124,58,237,0.2); }
  .bx { background: var(--bg-surface-soft); color: var(--text-secondary); border: 1px solid var(--border-light); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 20px;
    width: 98%;
    max-width: 1300px;
    max-height: 95vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 18px 24px 14px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .modal-close {
    background: var(--bg-surface-soft);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    width: 30px;
    height: 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .modal-close:hover { color: var(--danger); border-color: var(--danger); }

  .modal-body { padding: 20px 24px; }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: var(--bg-surface-soft);
    border-radius: 0 0 20px 20px;
  }

  /* FORMUL√ÅRIO */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
  }
  .form-grid .full { grid-column: 1 / -1; }
  .form-grid .half { grid-column: span 2; }

  .fg {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .fl {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* CAIXA ALTA EM TODOS OS CAMPOS */
  input[type="text"].fc,
  input[type="text"].fc-aliq,
  textarea.fc,
  .fc[type="text"],
  input.fc:not([type="date"]):not([type="number"]):not([type="url"]):not([type="email"]) {
    text-transform: uppercase;
  }
  textarea.fc {
    text-transform: uppercase;
  }

  .fc {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    padding: 8px 12px;
    outline: none;
    transition: all 0.2s;
    width: 100%;
  }

  .fc:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  textarea.fc {
    resize: vertical;
    min-height: 80px;
  }

  select.fc {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
  }

  .fc-aliq {
    background: var(--bg-surface);
    border: 1px solid var(--warning);
    border-radius: 8px;
    color: var(--warning);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    padding: 8px 12px;
    outline: none;
    width: 100%;
    font-weight: 500;
  }
  .fc-aliq:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

  .fc-auto { 
    background: var(--bg-surface-soft); 
    color: var(--success); 
    border: 1px dashed var(--success); 
    cursor: not-allowed; 
    padding: 8px 12px; 
    border-radius: 8px; 
    width: 100%; 
    font-size: 12px; 
    display: block;
  }
  
  .fc-manual { 
    border: 1px solid var(--warning); 
    background: var(--warning-soft); 
    color: var(--warning); 
    padding: 8px 12px; 
    border-radius: 8px; 
    width: 100%; 
    font-size: 12px; 
    display: none;
  }

  /* SWITCH */
  .master-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    padding: 10px 14px;
    background: var(--bg-surface-soft);
    border: 1px solid var(--border-light);
    border-radius: 12px;
  }
  .sw { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
  .sw input { opacity: 0; width: 0; height: 0; }
  .sw-sl {
    position: absolute; cursor: pointer; inset: 0;
    background: var(--border-light);
    border-radius: 30px;
    transition: 0.2s;
  }
  .sw-sl:before {
    content: ''; position: absolute; width: 16px; height: 16px; left: 2px; top: 2px;
    background: white; border-radius: 50%; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  input:checked + .sw-sl { background: var(--warning); }
  input:checked + .sw-sl:before { transform: translateX(16px); background: white; }

  .mtg {
    display: inline-flex; align-items: center; gap: 3px; font-size: 8px; font-weight: 700;
    padding: 2px 6px; border-radius: 30px; border: 1px solid var(--border-light);
    color: var(--text-tertiary); background: white; cursor: pointer; text-transform: uppercase;
  }
  .mtg.on { background: var(--warning-soft); border-color: var(--warning); color: var(--warning); }
  .mtg .dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }

  .empty-state {
    text-align: center; padding: 40px 20px; color: var(--text-tertiary);
  }
  .empty-state .icon { font-size: 40px; margin-bottom: 10px; opacity: 0.6; }

  .toast-container {
    position: fixed; bottom: 20px; right: 20px; z-index: 9999;
    display: flex; flex-direction: column; gap: 8px;
  }
  .toast {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 12px;
    color: var(--text-primary);
    box-shadow: var(--shadow-lg);
    animation: tIn 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 220px;
  }
  .toast.success { border-left: 4px solid var(--success); }
  .toast.info { border-left: 4px solid var(--accent-primary); }

  @keyframes tIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @media (max-width: 1100px) {
    .form-grid { grid-template-columns: repeat(3, 1fr); }
    .dashboard-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 900px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 700px) {
    .form-grid { grid-template-columns: 1fr; }
    .header-stats { display: none; }
    .theme-selector, .analista-selector, .shortcuts-hint { display: none; }
  }

  .estado-badge { font-size: 10px; background: var(--bg-surface-soft); padding: 2px 6px; border-radius: 20px; color: var(--text-secondary); font-weight: 500; display: inline-block; }
  .fsec { font-size: 13px; font-weight: 600; color: var(--text-primary); margin: 12px 0 8px; border-bottom: 1px solid var(--border-light); padding-bottom: 4px; }

  /* ===== DETAIL POPUP ===== */
  .detail-popup-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    z-index: 8000; align-items: center; justify-content: center;
  }
  .detail-popup-overlay.open { display: flex; }
  .detail-popup {
    background: var(--bg-surface); border-radius: 20px;
    padding: 28px; max-width: 1100px; width: 97%;
    max-height: 95vh; overflow-y: auto;
    box-shadow: 0 25px 60px rgba(0,0,0,0.35);
    border: 1px solid var(--border-light);
  }
  .detail-popup-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 20px; gap: 12px;
  }
  .detail-popup-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
  .detail-popup-sub { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
  .detail-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-tertiary); padding: 4px; line-height: 1; }
  .detail-close:hover { color: var(--danger); }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .detail-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .detail-field { }
  .detail-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 3px; }
  .detail-field-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
  .detail-section { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary); letter-spacing: 0.8px; border-bottom: 1px solid var(--border-light); padding-bottom: 6px; margin: 16px 0 12px; }
  .detail-actions { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }
  .lotes-status-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .lotes-status-table th { background: var(--bg-surface-soft); padding: 7px 10px; text-align: left; font-weight: 700; font-size: 10px; text-transform: uppercase; color: var(--text-tertiary); border-bottom: 2px solid var(--border-light); }
  .lotes-status-table td { padding: 8px 10px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
  .lotes-status-table tr:last-child td { border-bottom: none; }
  .saldo-ok { color: var(--success); font-weight: 700; }
  .saldo-zero { color: var(--text-tertiary); }
  .saldo-parcial { color: var(--warning); font-weight: 700; }
  .progress-bar-wrap { background: var(--bg-inset); border-radius: 20px; height: 6px; width: 100px; display: inline-block; vertical-align: middle; }
  .progress-bar-fill { height: 6px; border-radius: 20px; background: var(--success); }
  .empenho-mini-list { margin-top: 8px; }
  .empenho-mini-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: var(--bg-surface-soft); border-radius: 8px; margin-bottom: 4px; font-size: 11px; }
  .empenho-mini-item:hover { background: var(--bg-inset); }

  /* ===== LOTE SELECTOR IN EMPENHO ===== */
  .lote-selector-card {
    border: 2px solid var(--border-light); border-radius: 10px; padding: 12px;
    cursor: pointer; transition: all 0.15s; margin-bottom: 8px;
    display: grid; grid-template-columns: auto 1fr auto auto auto;
    gap: 12px; align-items: center;
  }
  .lote-selector-card:hover { border-color: var(--accent-primary); background: rgba(37,99,235,0.04); }
  .lote-selector-card.selected { border-color: var(--accent-primary); background: rgba(37,99,235,0.08); }
  .lote-selector-card.sem-saldo { opacity: 0.4; cursor: not-allowed; }
  .lote-saldo-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; }
  .lote-saldo-ok { background: var(--success-soft); color: var(--success); }
  .lote-saldo-zero { background: var(--bg-inset); color: var(--text-tertiary); }
  .lote-qtd-input-wrap { display: flex; align-items: center; gap: 6px; }
  .lote-qtd-input-wrap input { width: 70px; padding: 6px; border: 1px solid var(--border-light); border-radius: 6px; text-align: center; font-weight: 700; background: var(--bg-surface); color: var(--text-primary); }

  /* ===== ALERTAS DE PRAZO ===== */
  tr.alerta-30 td { background: rgba(245,158,11,0.07) !important; }
  tr.alerta-60 td { background: rgba(220,38,38,0.08) !important; }
  tr.alerta-90 td { background: rgba(139,0,0,0.12) !important; }
  body[data-theme="dark"] tr.alerta-30 td { background: rgba(245,158,11,0.12) !important; }
  body[data-theme="dark"] tr.alerta-60 td { background: rgba(220,38,38,0.15) !important; }
  body[data-theme="dark"] tr.alerta-90 td { background: rgba(220,38,38,0.22) !important; }

  .dias-badge {
    display: inline-block; padding: 2px 7px; border-radius: 20px;
    font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
  }
  .dias-ok { background: var(--success-soft); color: var(--success); }
  .dias-30 { background: var(--warning-soft); color: var(--warning); }
  .dias-60 { background: rgba(220,38,38,0.12); color: var(--danger); }
  .dias-90 { background: rgba(139,0,0,0.18); color: #b91c1c; font-size: 11px; animation: piscar 1.5s infinite; }
  @keyframes piscar { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .alerta-banner {
    background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(245,158,11,0.08));
    border: 1px solid rgba(220,38,38,0.25); border-radius: var(--radius-md);
    padding: 10px 16px; margin-bottom: 12px;
    display: flex; align-items: center; gap: 10px;
    font-size: 12px; color: var(--danger); font-weight: 600;
    cursor: pointer;
  }
  .alerta-banner:hover { background: rgba(220,38,38,0.15); }

  /* ===== LOTES DA DISPUTA ===== */
  .lotes-section { margin-top: 12px; }
  .lote-row {
    display: grid; grid-template-columns: 1fr 100px 100px 100px auto;
    gap: 8px; align-items: center; margin-bottom: 6px;
    background: var(--bg-surface-soft); padding: 8px 10px; border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
  }
  .lote-row input { padding: 5px 8px; border: 1px solid var(--border-light); border-radius: 6px; background: var(--bg-surface); color: var(--text-primary); font-size: 12px; width: 100%; text-transform: uppercase; }
  .lote-row input:focus { outline: none; border-color: var(--accent-primary); }
  .btn-lote-del { background: var(--danger-soft); color: var(--danger); border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
  .btn-lote-del:hover { background: var(--danger); color: white; }
  .lote-header { display: grid; grid-template-columns: 1fr 100px 100px 100px auto; gap: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary); padding: 0 10px; margin-bottom: 4px; }
  .lotes-totais { display: flex; gap: 16px; padding: 8px 10px; background: var(--bg-inset); border-radius: var(--radius-md); font-size: 12px; margin-top: 6px; }
  .lotes-totais span { color: var(--text-tertiary); }
  .lotes-totais strong { color: var(--text-primary); margin-left: 4px; }

  /* ===== LOGIN SCREEN ===== */
  .login-overlay {
    display: none; position: fixed; inset: 0;
    background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%);
    z-index: 10000; align-items: center; justify-content: center; flex-direction: column;
  }
  .login-overlay.open { display: flex; }
  .login-card {
    background: rgba(255,255,255,0.07); backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.15); border-radius: 24px;
    padding: 48px 40px; width: 380px; text-align: center;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5);
  }
  .login-logo { font-size: 48px; margin-bottom: 8px; }
  .login-title { font-size: 26px; font-weight: 700; color: white; margin-bottom: 4px; letter-spacing: -0.5px; }
  .login-sub { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 36px; }
  .login-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 1px; text-align: left; display: block; margin-bottom: 8px; }
  .login-select {
    width: 100%; padding: 14px 16px; border-radius: 12px; font-size: 15px; font-weight: 600;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: white; outline: none; cursor: pointer; margin-bottom: 24px;
    appearance: none;
  }
  .login-select option { background: #1e293b; color: white; }
  .login-select:focus { border-color: rgba(99,179,237,0.6); }
  .login-btn {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    background: linear-gradient(135deg, #2563eb, #7c3aed);
    color: white; font-size: 15px; font-weight: 700; cursor: pointer;
    box-shadow: 0 8px 24px rgba(37,99,235,0.4); transition: all 0.2s;
    letter-spacing: -0.2px;
  }
  .login-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(37,99,235,0.5); }
  .login-footer { margin-top: 20px; font-size: 11px; color: rgba(255,255,255,0.3); }
  .user-chip {
    display: flex; align-items: center; gap: 6px;
    background: var(--bg-surface-soft); border: 1px solid var(--border-light);
    border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 600;
    color: var(--text-primary); cursor: pointer;
  }
  .user-chip:hover { border-color: var(--danger); color: var(--danger); }
  .user-avatar {
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--accent-gradient); color: white;
    font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center;
  }

  /* ===== EXCEL ATTACHMENT ===== */
  .excel-drop-zone {
    border: 2px dashed var(--border-medium); border-radius: var(--radius-md);
    padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s;
    color: var(--text-tertiary); font-size: 12px;
  }
  .excel-drop-zone:hover, .excel-drop-zone.dragover { border-color: #10b981; background: rgba(16,185,129,0.05); color: #10b981; }
  .excel-preview { margin-top: 10px; overflow-x: auto; max-height: 200px; }
  .excel-preview table { width: 100%; font-size: 10px; border-collapse: collapse; }
  .excel-preview th { background: var(--bg-surface-soft); padding: 4px 8px; text-align: left; border: 1px solid var(--border-light); font-weight: 600; color: var(--text-secondary); }
  .excel-preview td { padding: 3px 8px; border: 1px solid var(--border-light); color: var(--text-primary); white-space: nowrap; }
  .excel-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(16,185,129,0.1); color: #10b981; border: 1px solid rgba(16,185,129,0.2); border-radius: 20px; padding: 2px 8px; font-size: 10px; font-weight: 600; cursor: pointer; }
  .excel-badge:hover { background: #10b981; color: white; }

  /* ===== DASHBOARD MELHORADO ===== */
  .dash-kpi-row { display: grid; grid-template-columns: repeat(6,1fr); gap: 12px; margin-bottom: 16px; }
  .dash-kpi { background: var(--bg-surface); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 14px 16px; }
  .dash-kpi .val { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-primary); }
  .dash-kpi .lbl { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
  .dash-kpi .sub { font-size: 10px; margin-top: 4px; }
  .sub-up { color: var(--success); }
  .sub-dn { color: var(--danger); }
  @media (max-width: 1100px) { .dash-kpi-row { grid-template-columns: repeat(3,1fr); } }

  /* Modal Empenhos da Disputa */
  .modal-emp-disp {
    max-width: 900px;
    width: 96%;
  }

  .emp-disp-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .emp-disp-table th {
    background: var(--bg-surface-soft);
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
  }

  .emp-disp-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
  }

  .emp-disp-table tr:hover td {
    background: var(--bg-surface-hover);
  }

  .emp-disp-table tr.pago td {
    opacity: 0.75;
  }

  .emp-disp-empty {
    text-align: center;
    padding: 32px;
    color: var(--text-tertiary);
    font-size: 13px;
  }

  .vinculo-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 20px;
    background: var(--purple-soft);
    color: var(--purple);
    border: 1px solid rgba(124,58,237,0.2);
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .vinculo-badge:hover {
    background: var(--purple);
    color: white;
  }

  .status-pago {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    background: var(--success-soft);
    color: var(--success);
    border: 1px solid rgba(5,150,105,0.2);
  }

  .status-pendente {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    background: var(--warning-soft);
    color: var(--warning);
    border: 1px solid rgba(217,119,6,0.2);
  }

  .disp-info-banner {
    background: var(--bg-surface-soft);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: 10px 14px;
    margin-bottom: 14px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 12px;
  }

  .disp-info-banner span {
    color: var(--text-tertiary);
  }

  .disp-info-banner strong {
    color: var(--text-primary);
    margin-left: 4px;
  }

  /* ===== COMPRAS INDIVIDUAIS ===== */
  .compra-item-card {
    border: 1px solid var(--border-light); border-radius: 10px; padding: 12px;
    margin-bottom: 10px; background: var(--bg-surface-soft);
  }
  .compra-item-header {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
    padding-bottom: 8px; border-bottom: 1px solid var(--border-light);
  }
  .compra-item-title { font-size: 13px; font-weight: 700; color: var(--accent-primary); }
  .compra-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
  .compra-status-pago { color: var(--success); font-weight: 700; font-size: 11px; }
  .compra-status-pendente { color: var(--warning); font-weight: 700; font-size: 11px; }
  .btn-add-compra {
    background: var(--success-soft); color: var(--success); border: 1px dashed var(--success);
    border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 12px; font-weight: 600;
    width: 100%; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-add-compra:hover { background: var(--success); color: white; }
  .compra-lote-select {
    display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px;
  }
  .compra-lote-btn {
    border: 2px solid var(--border-light); border-radius: 8px; padding: 8px 10px; cursor: pointer;
    font-size: 11px; text-align: center; transition: all 0.15s; background: var(--bg-surface);
  }
  .compra-lote-btn:hover { border-color: var(--accent-primary); }
  .compra-lote-btn.selected { border-color: var(--accent-primary); background: rgba(37,99,235,0.08); }
  .compra-lote-btn.sem-saldo { opacity: 0.45; cursor: not-allowed; }

  /* ===== WIZARD R√ÅPIDO ===== */
  .wizard-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    z-index: 3000;
    align-items: center;
    justify-content: center;
  }
  .wizard-overlay.open { display: flex; }

  .wizard {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 24px;
    width: 90%;
    max-width: 500px;
    padding: 24px;
    box-shadow: var(--shadow-xl);
    animation: modalIn 0.3s ease;
  }

  .wizard h2 {
    font-size: 20px;
    margin-bottom: 20px;
    color: var(--text-primary);
  }

  .wizard-step {
    margin-bottom: 20px;
  }

  .wizard-step label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 6px;
  }

  .wizard-step input, .wizard-step select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    background: var(--bg-surface);
    color: var(--text-primary);
    font-size: 14px;
  }

  .wizard-progress {
    display: flex;
    gap: 8px;
    margin: 20px 0;
  }

  .wizard-progress .step {
    flex: 1;
    height: 4px;
    background: var(--border-light);
    border-radius: 2px;
  }

  .wizard-progress .step.active {
    background: var(--accent-primary);
  }

  .wizard-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body data-theme="light">

<!-- TELA DE LOGIN -->
<div class="login-overlay open" id="login-screen">
  <div class="login-card">
    <div class="login-logo">üèÜ</div>
    <div class="login-title">LicitationBiznis</div>
    <div class="login-sub">Gest√£o de Licita√ß√µes</div>
    <label class="login-label">E-mail</label>
    <input type="email" id="login-email" class="login-select" placeholder="seu@email.com" style="margin-bottom:14px;" onkeydown="if(event.key==='Enter')fazerLogin()">
    <label class="login-label">Senha</label>
    <input type="password" id="login-senha" class="login-select" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-bottom:6px;" onkeydown="if(event.key==='Enter')fazerLogin()">
    <div id="login-erro" style="color:#f87171;font-size:12px;min-height:18px;margin-bottom:10px;text-align:center;"></div>
    <button class="login-btn" id="login-btn" onclick="fazerLogin()">Entrar ‚Üí</button>
    <div class="login-footer">Acesso restrito ¬∑ Dados em nuvem</div>
  </div>
</div>

<header>
  <div class="logo">
    <div class="logo-icon" style="font-size:28px;display:flex;align-items:center;justify-content:center;">üèÜ</div>
    <div>
      <div class="logo-text">LicitationBiznis</div>
      <div class="logo-sub">Porque biznis √© mode os licitaxions</div>
    </div>
  </div>
  <div class="spacer"></div>
  
  <!-- CONTROLES DO HEADER -->


  <!-- USU√ÅRIO LOGADO -->
  <div class="user-chip" id="user-chip" onclick="fazerLogout()" title="Clique para trocar usu√°rio">
    <div class="user-avatar" id="user-avatar">?</div>
    <span id="user-nome">‚Äî</span>
    <span style="font-size:10px;opacity:0.5">‚Ü©</span>
  </div>






</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('disputas',this)">üèÜ Disputas Vencidas <span class="tab-badge" id="badge-disputas">0</span></button>
  <button class="tab-btn" onclick="switchTab('empenhos',this)">üìÑ Empenhos <span class="tab-badge" id="badge-empenhos">0</span></button>
  <button class="tab-btn" onclick="switchTab('finalizadas',this)" style="color:var(--success);">‚úÖ Finalizadas <span class="tab-badge" id="badge-finalizadas" style="background:var(--success);">0</span></button>
</div>

<div class="content">

  <!-- TELA DE BOAS-VINDAS (aparece s√≥ quando n√£o h√° dados) -->
  <div id="tela-boasvindas" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:var(--bg-surface); border-radius:24px; padding:40px; max-width:480px; width:90%; text-align:center; box-shadow:0 25px 50px rgba(0,0,0,0.3); border:1px solid var(--border-light);">
      <div style="font-size:48px; margin-bottom:16px;">üì¶</div>
      <h2 style="font-size:22px; font-weight:700; color:var(--text-primary); margin-bottom:10px;">Nenhum dado encontrado</h2>
      <p style="color:var(--text-secondary); font-size:14px; line-height:1.6; margin-bottom:8px;">
        Este arquivo √© novo e ainda n√£o tem dados associados.
      </p>
      <p style="color:var(--text-tertiary); font-size:13px; margin-bottom:28px;">
        Se voc√™ j√° usava o sistema antes, importe seu backup JSON para restaurar todos os seus dados.
      </p>
      <label style="display:inline-flex; align-items:center; gap:10px; background:var(--accent-primary); color:white; border-radius:12px; padding:14px 28px; font-size:15px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(37,99,235,0.4); margin-bottom:12px;">
        ‚¨Ü Importar meu backup (.json)
        <input type="file" accept=".json" onchange="importarBackup(event)" style="display:none;">
      </label>
      <br>
      <button onclick="iniciarSemDados()" style="background:none; border:none; color:var(--text-tertiary); font-size:13px; cursor:pointer; margin-top:8px; text-decoration:underline;">
        Come√ßar do zero (sem importar)
      </button>
    </div>
  </div>
  <!-- DISPUTAS VENCIDAS -->
  <div class="tab-pane active" id="tab-disputas">
    <div class="summary-row" id="sum-disputas"></div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openModal('disputas')">Ôºã Nova Disputa</button>
      <button class="btn" onclick="abrirCalculadora()" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;font-weight:700;display:flex;align-items:center;gap:6px;" title="Calculadora de Custos e Lucros">üßÆ C√°lculo R√°pido</button>

      
      <div class="filter-group">
        <label>üë§ Analista:</label>
        <select id="filtro-analista-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="M√°rdea">M√°rdea</option>
          <option value="Rodrigo">Rodrigo</option>
        </select>
      </div>



      <div class="filter-group">
        <label>üìÑ Empenhos:</label>
        <select id="filtro-empenho-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="com-empenho">Com empenho</option>
          <option value="sem-empenho">Sem empenho</option>
        </select>
      </div>
      <div class="filter-group">
        <label>üèÅ Situa√ß√£o:</label>
        <select id="filtro-situacao-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todas</option>
          <option value="em-andamento">Em andamento</option>
          <option value="finalizada">Finalizadas</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üè¢ Empresa:</label>
        <select id="filtro-empresa-disputas" onchange="filtrarDisputas()">
          <option value="todas">Todas</option>
          <option value="Gadita">Gadita</option>
          <option value="Hamate">Hamate</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üìã Tipo:</label>
        <select id="filtro-tipo-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="Preg√£o Eletr√¥nico">Preg√£o Eletr√¥nico</option>
          <option value="Dispensa">Dispensa</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üîÅ RP:</label>
        <select id="filtro-rp-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="SIM">SIM</option>
          <option value="N√ÉO">N√ÉO</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üíª Sistema:</label>
        <select id="filtro-sistema-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="Licitar Digital">Licitar Digital</option>
          <option value="Licitanet">Licitanet</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üó∫Ô∏è UF:</label>
        <select id="filtro-estado-disputas" onchange="filtrarDisputas()">
          <option value="todos">Todos</option>
          <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option><option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option><option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option><option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option><option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option><option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option><option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option><option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
        </select>
      </div>
      
      <div class="search-box"><input type="text" id="search-disputas" placeholder="Pesquisar disputas..." oninput="filterTable('disputas',this.value)"></div>
      <button class="btn btn-ghost btn-sm" onclick="limparFiltrosDisputas()" title="Limpar filtros">‚úï Limpar</button>
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
        <button class="btn btn-danger btn-sm" id="btn-del-lote-disputas" style="display:none;" onclick="deletarSelecionados('disputas')">üóë Excluir selecionados (<span id="cnt-sel-disputas">0</span>)</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV('disputas')">‚¨á Exportar</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead><tr>
          <th style="width:36px;text-align:center;"><input type="checkbox" id="chk-all-disputas" title="Selecionar todos" onchange="toggleSelectAll('disputas',this.checked)" style="cursor:pointer;width:15px;height:15px;"></th>
          <th onclick="sort('disputas', 'data')" id="sort-disputas-data">Data</th>
          <th onclick="sort('disputas', 'orgao')" id="sort-disputas-orgao">√ìrg√£o / UF</th>
          <th>Analista</th>
          <th>A√ß√µes</th>
        </tr></thead>
        <tbody id="tbody-disputas"></tbody>
      </table>
    </div>
  </div>

  <!-- EMPENHOS -->
  <div class="tab-pane" id="tab-empenhos">
    <div id="alerta-empenhos-banner" style="display:none;" class="alerta-banner" onclick="filtrarAtraso60()">
      üö® <span id="alerta-empenhos-txt"></span> ‚Äî clique para filtrar
    </div>
    <div class="summary-row" id="sum-empenhos"></div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openModal('empenhos')">Ôºã Novo Empenho</button>

      
      <div class="filter-group">
        <label>üí∞ Status:</label>
        <select id="filtro-status-empenhos" onchange="filtrarEmpenhos()">
          <option value="todos">Todos</option>
          <option value="pagos">Pagos</option>
          <option value="nao-pagos">N√£o pagos</option>
        </select>
      </div>

      <div class="filter-group">
        <label>‚è±Ô∏è Atraso:</label>
        <select id="filtro-atraso-empenhos" onchange="filtrarEmpenhos()">
          <option value="todos">Todos</option>
          <option value="30">+30 dias</option>
          <option value="60">+60 dias</option>
          <option value="90">+90 dias</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üë§ Analista:</label>
        <select id="filtro-analista-empenhos" onchange="filtrarEmpenhos()">
          <option value="todos">Todos</option>
          <option value="M√°rdea">M√°rdea</option>
          <option value="Rodrigo">Rodrigo</option>
        </select>
      </div>

      <div class="filter-group">
        <label>üîó V√≠nculo:</label>
        <select id="filtro-vinculo-empenhos" onchange="filtrarEmpenhos()">
          <option value="todos">Todos</option>
          <option value="vinculados">Vinculados</option>
          <option value="sem-vinculo">Sem v√≠nculo</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>üõí Compras:</label>
        <select id="filtro-compras-empenhos" onchange="filtrarEmpenhos()">
          <option value="todos">Todos</option>
          <option value="com-compras">Com compras</option>
          <option value="sem-compras">Sem compras</option>
        </select>
      </div>

      <div class="search-box"><input type="text" id="search-empenhos" placeholder="Pesquisar empenhos..." oninput="filterTable('empenhos',this.value)"></div>
      <button class="btn btn-ghost btn-sm" onclick="limparFiltrosEmpenhos()" title="Limpar filtros">‚úï Limpar</button>
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
        <button class="btn btn-danger btn-sm" id="btn-del-lote-empenhos" style="display:none;" onclick="deletarSelecionados('empenhos')">üóë Excluir selecionados (<span id="cnt-sel-empenhos">0</span>)</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV('empenhos')">‚¨á Exportar</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead><tr>
          <th style="width:36px;text-align:center;"><input type="checkbox" id="chk-all-empenhos" title="Selecionar todos" onchange="toggleSelectAll('empenhos',this.checked)" style="cursor:pointer;width:15px;height:15px;"></th>
          <th onclick="sort('empenhos', 'num')" id="sort-empenhos-num">Empenho</th>
          <th onclick="sort('empenhos', 'orgao')" id="sort-empenhos-orgao">√ìrg√£o</th>
          <th>Analista</th>
          <th onclick="sort('empenhos', 'vem')" id="sort-empenhos-vem">Val. Empenho</th>
          <th>‚è±Ô∏è Dias</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr></thead>
        <tbody id="tbody-empenhos"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB FINALIZADAS -->
  <div class="tab-pane" id="tab-finalizadas">
    <div class="summary-row" id="sum-finalizadas"></div>
    <div class="toolbar">
      <div class="search-box"><input type="text" id="search-finalizadas" placeholder="Pesquisar finalizadas..." oninput="renderFinalizadas()"></div>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>√ìrg√£o / UF</th>
          <th>Analista</th>
          <th>Empresa</th>
          <th>Valor Contrato</th>
          <th>Lucro Recebido</th>
          <th>Finalizada em</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tbody-finalizadas"></tbody>
    </table>
  </div>

</div>

<!-- MODAL DISPUTAS (com campo Observa√ß√£o) -->
<div class="modal-overlay" id="modal-disputas">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="ttl-disputas">Nova Disputa Vencida</div>
      <button class="modal-close" onclick="closeModal('disputas')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="fg"><label class="fl">Data</label><input type="date" class="fc" id="d-data"></div>
        <div class="fg"><label class="fl">√ìrg√£o</label><input type="text" class="fc" id="d-orgao" placeholder="Prefeitura..."></div>
        <div class="fg"><label class="fl">Estado</label>
          <select class="fc" id="d-estado">
            <option value="">Selecione</option>
            <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option><option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option><option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option><option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option><option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option><option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option><option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option><option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Empresa</label>
          <select class="fc" id="d-empresa"><option value="">Selecione</option><option>Gadita</option><option selected>Hamate</option></select>
        </div>
        <div class="fg"><label class="fl">Tipo</label>
          <select class="fc" id="d-tipo"><option value="">Selecione</option><option selected>Preg√£o Eletr√¥nico</option><option>Dispensa</option></select>
        </div>
        <div class="fg"><label class="fl">RP?</label>
          <select class="fc" id="d-rp"><option value="">‚Äî</option><option>SIM</option><option selected>N√ÉO</option></select>
        </div>
        <div class="fg"><label class="fl">Processo</label><input type="text" class="fc" id="d-processo"></div>
        <div class="fg"><label class="fl">Sistema</label>
          <select class="fc" id="d-sistema"><option value="">Selecione</option><option>Licitar Digital</option><option selected>Licitanet</option></select>
        </div>
        <div class="fg"><label class="fl">Analista</label>
          <select class="fc" id="d-analista"><option value="">Selecione</option><option selected>M√°rdea</option><option>Rodrigo</option></select>
        </div>

        
        <!-- CAMPO OBSERVA√á√ÉO (200 caracteres) -->
        <div class="fg full">
          <label class="fl">Observa√ß√£o (max 200 caracteres)</label>
          <textarea class="fc" id="d-observacao" maxlength="200" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
        </div>
        


        <!-- LOTES / ITENS OBRIGAT√ìRIO -->
        <div class="full">
          <div class="fsec">üì¶ Itens / Lotes da Disputa <span style="color:var(--danger);font-size:10px;">* obrigat√≥rio</span></div>
          <div style="display:grid;grid-template-columns:1fr 70px 100px 100px 70px 70px 90px 30px;gap:4px;padding:0 4px;margin-bottom:4px;">
            <span style="font-size:9px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;">Descri√ß√£o</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;">Qtd Cont.</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;">Vl. Unit</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;">Vl. Total</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;">Enviado</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;">Restante</span>
            <span style="font-size:9px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;">Vl. Enviado</span>
            <span></span>
          </div>
          <div id="lotes-container"></div>
          <button type="button" class="btn btn-ghost btn-sm" onclick="adicionarLote()" style="margin-top:6px;">Ôºã Adicionar Item/Lote</button>
          <div class="lotes-totais" id="lotes-totais" style="display:none;margin-top:8px;">
            <span>Itens: <strong id="lt-count">0</strong></span>
            <span>Valor do Contrato: <strong id="lt-total" style="color:var(--accent-primary);">R$ 0,00</strong></span>
          </div>
          <div id="lotes-aviso" style="display:none;color:var(--danger);font-size:11px;margin-top:6px;">‚ö†Ô∏è Adicione pelo menos 1 item para salvar.</div>
        </div>

      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('disputas')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveD()">üíæ Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL EMPENHOS (com campo Observa√ß√£o) -->
<div class="modal-overlay" id="modal-empenhos">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="ttl-empenhos">Novo Empenho</div>
      <button class="modal-close" onclick="closeModal('empenhos')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="fg"><label class="fl">N¬∫ Empenho</label><input type="text" class="fc" id="e-num"></div>
        <div class="fg"><label class="fl">Data</label><input type="date" class="fc" id="e-data"></div>

        <!-- Analista vir√° automaticamente da disputa selecionada -->
        <input type="hidden" id="e-analista">

        <!-- √ìRG√ÉO = DISPUTA (campo √∫nico) -->
        <div class="fg full">
          <label class="fl">üè¢ √ìrg√£o / Disputa <span style="color:var(--danger);font-size:10px;">* obrigat√≥rio</span></label>
          <select class="fc" id="e-disputa-id" onchange="onDisputaSelecionada(this.value)" style="font-size:13px;">
            <option value="">‚Äî Selecione o √≥rg√£o ‚Äî</option>
          </select>
          <div style="font-size:10px;color:var(--text-tertiary);margin-top:3px;">Apenas √≥rg√£os com saldo de itens a empenhar s√£o listados</div>
        </div>

        <!-- SELETOR DE LOTE (aparece ap√≥s selecionar disputa) -->
        <div class="fg full" id="lote-selector-wrap" style="display:none;">
          <label class="fl">üì¶ Itens/Lotes do Empenho <span style="color:var(--text-tertiary);font-size:9px;">(selecione um ou mais)</span></label>
          <div id="lote-selector-container"></div>
          <div id="lote-aviso" style="display:none;color:var(--danger);font-size:11px;margin-top:4px;">‚ö†Ô∏è SELECIONE PELO MENOS UM LOTE PARA CONTINUAR.</div>
          <div id="lote-valor-total-wrap" style="margin-top:8px;padding:8px 12px;background:var(--info-soft);border-radius:8px;display:none;">
            <span style="font-size:11px;color:var(--text-tertiary);">VALOR TOTAL DO EMPENHO (CALCULADO): </span>
            <strong id="lote-valor-total-calc" style="color:var(--accent-primary);font-size:14px;"></strong>
          </div>
        </div>

        <!-- CAMPO OBSERVA√á√ÉO -->
        <div class="fg full">
          <label class="fl">Observa√ß√£o (max 200 caracteres)</label>
          <textarea class="fc" id="e-observacao" maxlength="200" rows="2" placeholder="Informa√ß√µes adicionais..."></textarea>
        </div>

        <!-- Campos ocultos necess√°rios para salvar (n√£o exibidos) -->
        <input type="hidden" id="e-dcomp">
        <input type="hidden" id="e-vunit" value="0">
        <input type="hidden" id="e-qtd" value="1">
        <input type="hidden" id="e-vem" value="0">
        <input type="hidden" id="e-aliq" value="13">
        <input type="hidden" id="e-recebido" value="0">
        <input type="hidden" id="e-dreceb">
        <input type="hidden" id="e-vem-a">
        <input type="hidden" id="e-tot-a"><input type="hidden" id="e-tot-m">
        <input type="hidden" id="e-imp-a"><input type="hidden" id="e-imp-m">
        <input type="hidden" id="e-luc-a"><input type="hidden" id="e-luc-m">
        <input type="hidden" id="e-pct-a"><input type="hidden" id="e-pct-m">
        <input type="hidden" id="e-rec-a"><input type="hidden" id="e-rec-m">
        <input type="hidden" id="e-all">
        <input type="hidden" id="tbtn-e-vem">
        <input type="hidden" id="tbtn-e-tot">
        <input type="hidden" id="tbtn-e-imp">
        <input type="hidden" id="tbtn-e-luc">
        <input type="hidden" id="tbtn-e-pct">
        <input type="hidden" id="tbtn-e-rec">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('empenhos')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveE()">üíæ Salvar</button>
    </div>
  </div>
</div>

<!-- WIZARD DE ENTRADA R√ÅPIDA -->
<div class="wizard-overlay" id="wizard-quick">
  <div class="wizard">
    <h2>‚ö° Entrada R√°pida</h2>
    <div class="wizard-progress">
      <div class="step active" id="wiz-step1"></div>
      <div class="step" id="wiz-step2"></div>
      <div class="step" id="wiz-step3"></div>
    </div>
    
    <div id="wizard-step-1" class="wizard-step">
      <label>Tipo de Registro</label>
      <select id="wizard-tipo">
        <option value="disputas">Disputa Vencida</option>
        <option value="empenhos">Empenho</option>
      </select>
    </div>
    
    <div id="wizard-step-2" class="wizard-step" style="display:none;">
      <label>√ìrg√£o</label>
      <input type="text" id="wizard-orgao" placeholder="Ex: Prefeitura Municipal...">
    </div>
    
    <div id="wizard-step-3" class="wizard-step" style="display:none;">
      <label>Processo / Empenho</label>
      <input type="text" id="wizard-processo" placeholder="N√∫mero do processo/empenho">
    </div>
    
    <div class="wizard-buttons">
      <button class="btn btn-ghost" onclick="closeWizard()">Cancelar</button>
      <button class="btn btn-primary" id="wizard-next" onclick="wizardNext()">Pr√≥ximo</button>
      <button class="btn btn-success" id="wizard-finish" style="display:none;" onclick="wizardFinish()">Finalizar</button>
    </div>
  </div>
</div>

<!-- MODAL EMPENHOS DA DISPUTA -->
<div class="modal-overlay" id="modal-empenhos-disputa">
  <div class="modal modal-emp-disp">
    <div class="modal-header">
      <div class="modal-title" id="ttl-empenhos-disputa">üìÑ Empenhos da Disputa</div>
      <button class="modal-close" onclick="closeModal('empenhos-disputa')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="disp-info-banner" id="disp-info-banner"></div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-size:12px; color:var(--text-tertiary);" id="disp-emp-count"></div>
        <button class="btn btn-primary btn-sm" onclick="novoEmpenhoDaDisputa()">Ôºã Novo Empenho Vinculado</button>
      </div>
      <div id="disp-emp-body">
        <div class="emp-disp-empty">Nenhum empenho vinculado a esta disputa.</div>
      </div>
      <div style="border-top:1px solid var(--border-light); margin-top:14px; padding-top:12px; display:flex; gap:20px; flex-wrap:wrap;" id="disp-emp-totais"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('empenhos-disputa')">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL COMPRA INDIVIDUAL -->
<div class="modal-overlay" id="modal-compra">
  <div class="modal" style="max-width:900px;">
    <div class="modal-header">
      <div class="modal-title" id="ttl-compra">Nova Compra</div>
      <button class="modal-close" onclick="closeModal('compra')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="compra-lote-selector-wrap">
        <div class="fsec">üì¶ Selecione o Item/Lote</div>
        <div id="compra-lote-selector" class="compra-lote-select"></div>
      </div>
      <div id="compra-campos" style="display:none;">
        <div class="form-grid">
          <div class="fg half">
            <label class="fl">Item/Lote</label>
            <input type="text" class="fc" id="c-lote-desc" readonly style="background:var(--bg-inset);color:var(--accent-primary);font-weight:700;">
          </div>
          <div class="fg">
            <label class="fl">Qtd Empenho (Item)</label>
            <input type="number" class="fc" id="c-qtd-empenho" readonly style="background:var(--bg-inset);color:var(--text-tertiary);">
          </div>
          <div class="fg">
            <label class="fl">Vl. Empenho do Item (total)</label>
            <input type="number" class="fc" id="c-vem-item" readonly style="background:var(--bg-inset);color:var(--accent-primary);font-weight:700;">
          </div>
          <div class="fg">
            <label class="fl">Qtd Comprando <span id="c-saldo-info" style="font-size:10px;color:var(--success);font-weight:700;"></span></label>
            <input type="number" step="1" min="1" class="fc" id="c-qtd" oninput="calcCompra()">
          </div>
          <div class="fg">
            <label class="fl">Data da Compra</label>
            <input type="date" class="fc" id="c-dcompra">
          </div>
          <div class="fg">
            <label class="fl">Plataforma</label>
            <input type="text" class="fc" id="c-plataforma" placeholder="MERCADO LIVRE, SHOPEE...">
          </div>
          <div class="fg">
            <label class="fl">Vl. Unit√°rio Compra (R$)</label>
            <input type="number" step="0.01" class="fc" id="c-vunit" oninput="calcCompra()">
          </div>
          <div class="fg">
            <label class="fl">Vl. Total Compra (R$)</label>
            <input type="number" step="0.01" class="fc" id="c-vtotal-compra" readonly style="background:var(--bg-inset);color:var(--accent-primary);font-weight:700;">
          </div>
          <div class="fg">
            <label class="fl" style="display:flex;align-items:center;justify-content:space-between;">
              <span>Custo (R$)</span>
              <button type="button" onclick="calcCustoAutomatico()" style="font-size:10px;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;border-radius:6px;padding:2px 7px;cursor:pointer;font-weight:700;">üßÆ Calcular</button>
            </label>
            <input type="number" step="0.01" class="fc" id="c-custo" oninput="calcCompra()">
          </div>
          <!-- Mini painel custo calculado -->
          <div class="fg full" id="c-custo-calc-painel" style="display:none;">
            <div style="background:var(--bg-surface-2,#f8fafc);border:1px solid var(--border-light);border-radius:10px;padding:10px;font-size:12px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
                <span style="font-weight:700;color:var(--text-primary);">‚öôÔ∏è M√©todo de c√°lculo:</span>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;"><input type="radio" name="c-calc-tipo" value="simples" id="c-calc-simples" onchange="calcCustoRecalcular()" checked> Simples (%)</label>
                <label id="c-calc-icms-lbl" style="display:flex;align-items:center;gap:4px;cursor:pointer;display:none;"><input type="radio" name="c-calc-tipo" value="icms" id="c-calc-icms" onchange="calcCustoRecalcular()"> ICMS</label>
                <span id="c-calc-empresa-info" style="font-size:11px;color:var(--text-tertiary);margin-left:auto;"></span>
              </div>
              <!-- Simples -->
              <div id="c-calc-bloco-simples" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="font-size:11px;color:var(--text-secondary);">% Custo:</span>
                <input type="number" class="fc" id="c-calc-pct" value="9" step="0.1" oninput="calcCustoRecalcular()" style="width:70px;padding:4px 8px;font-size:13px;font-weight:700;text-align:center;">
                <span style="font-size:13px;font-weight:700;color:var(--warning);">%</span>
              </div>
              <!-- ICMS -->
              <div id="c-calc-bloco-icms" style="display:none;margin-bottom:8px;">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:6px;">
                  <span id="c-calc-estado-label" style="font-size:12px;font-weight:700;color:var(--accent-primary);"></span>
                  <span id="c-calc-icms-label" style="font-size:12px;font-weight:700;color:var(--warning);"></span>
                  <label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;"><input type="checkbox" id="c-calc-custo-emp" onchange="calcCustoRecalcular()"> +Custo Empresa (3%)</label>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-size:11px;color:var(--text-secondary);">Cr√©dito ICMS (R$):</span>
                  <input type="number" class="fc" id="c-calc-credito" placeholder="0,00" step="0.01" oninput="calcCustoRecalcular()" style="width:100px;padding:4px 8px;font-size:13px;">
                </div>
              </div>
              <!-- Resultado e bot√£o aplicar -->
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <span style="font-size:11px;color:var(--text-secondary);">Custo calculado:</span>
                <span id="c-calc-resultado" style="font-size:15px;font-weight:800;color:var(--warning);font-family:'JetBrains Mono',monospace;">‚Äî</span>
                <button type="button" onclick="calcCustoAplicar()" class="btn btn-primary btn-sm" style="margin-left:auto;">‚úì Aplicar no campo</button>
                <button type="button" onclick="g('c-custo-calc-painel').style.display='none'" class="btn btn-ghost btn-sm">‚úï</button>
              </div>
            </div>
          </div>
          <div class="fg">
            <label class="fl">Lucro <button type="button" class="mtg" id="tbtn-c-luc" onclick="togCompra('luc')"><span class="dot"></span>Auto</button></label>
            <input class="fc-auto" id="c-luc-a" readonly>
            <input type="number" step="0.01" class="fc-manual" id="c-luc-m" oninput="calcCompra()">
            <div style="font-size:9px;color:var(--text-tertiary);margin-top:2px;">= Vl.Emp.Prop. ‚àí Total Compra ‚àí Custo</div>
          </div>
          <div class="fg">
            <label class="fl">% Lucro</label>
            <input class="fc" id="c-pct-lucro" readonly style="background:var(--bg-inset);color:var(--success);font-weight:700;font-family:'JetBrains Mono',monospace;">
          </div>
          <div class="fg">
            <label class="fl">Vl. Total a Receber <button type="button" class="mtg" id="tbtn-c-rec" onclick="togCompra('rec')"><span class="dot"></span>Auto</button></label>
            <input class="fc-auto" id="c-rec-a" readonly>
            <input type="number" step="0.01" class="fc-manual" id="c-rec-m" oninput="calcCompra()">
          </div>
          <div class="fsec full">üè¶ Pagamento</div>
          <div class="fg">
            <label class="fl">Data de Pagamento</label>
            <input type="date" class="fc" id="c-dpag">
          </div>
          <div class="fg">
            <label class="fl">Valor Recebido (R$)</label>
            <input type="number" step="0.01" class="fc" id="c-recebido">
          </div>
          <div class="fg full">
            <label class="fl">Observa√ß√£o</label>
            <textarea class="fc" id="c-obs" rows="2" maxlength="200" placeholder="OBSERVA√á√ïES..."></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('compra')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCompra()">üíæ Salvar Compra</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->

<!-- ======= MODAL CALCULADORA ======= -->
<div class="modal-overlay" id="modal-calc" style="z-index:3000;align-items:stretch;padding:16px;">
  <div class="modal" style="max-width:100%;width:100%;max-height:100%;height:100%;display:flex;flex-direction:column;border-radius:16px;">
    <div class="modal-header">
      <div class="modal-title">üßÆ C√°lculo R√°pido de Custos / Lucros</div>
      <button class="modal-close" onclick="closeModal('calc')">‚úï</button>
    </div>
    <div class="modal-body" style="flex:1;overflow-y:auto;padding:16px 20px;">

      <!-- PASSO 1: Sele√ß√£o da disputa -->
      <div id="calc-passo1">
        <div class="fsec" style="margin-bottom:12px;">Selecione a Disputa Vencida</div>
        <input type="text" id="calc-busca-disputa" class="fc" placeholder="Pesquisar por √≥rg√£o, processo..." oninput="calcFiltrarDisputas()" style="margin-bottom:10px;">
        <div id="calc-lista-disputas" style="display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;"></div>
      </div>

      <!-- PASSO 2: Calculadora -->
      <div id="calc-passo2" style="display:none;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <button onclick="calcVoltarPasso1()" style="background:none;border:1px solid var(--border-light);border-radius:8px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text-secondary);">‚Üê Voltar</button>
          <div id="calc-disputa-titulo" style="font-weight:700;font-size:14px;color:var(--text-primary);"></div>
          <span id="calc-empresa-badge" style="font-size:11px;padding:2px 8px;border-radius:12px;font-weight:700;"></span>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;height:100%;">

          <!-- COLUNA ESQUERDA: lista de itens + tabela -->
          <div style="display:flex;flex-direction:column;gap:12px;overflow-y:auto;">

            <!-- Sele√ß√£o do Item -->
            <div>
              <div class="fsec" style="margin-bottom:6px;">üì¶ Itens dispon√≠veis ‚Äî clique para adicionar</div>
              <div id="calc-itens-lista" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto;padding-right:4px;"></div>
            </div>

            <!-- Formul√°rio de adi√ß√£o -->
            <div id="calc-form-item" style="background:var(--bg-surface-2,#f8fafc);border:2px solid var(--accent-primary);border-radius:10px;padding:12px;display:none;">
              <div style="font-size:12px;font-weight:700;margin-bottom:8px;color:var(--accent-primary);" id="calc-form-item-titulo">Adicionar item</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="fg" style="margin:0;">
                  <label class="fl">Qtd</label>
                  <input type="number" class="fc" id="calc-form-qtd" value="1" min="1">
                </div>
                <div class="fg" style="margin:0;">
                  <label class="fl">Vl. Compra Unit. (R$)</label>
                  <input type="number" class="fc" id="calc-form-vcompra" placeholder="0,00" step="0.01" onkeydown="if(event.key==='Enter')calcAdicionarItem()">
                </div>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button onclick="calcAdicionarItem()" class="btn btn-primary btn-sm" style="flex:1;">Ôºã Adicionar</button>
                <button onclick="calcFecharFormItem()" class="btn btn-ghost btn-sm">Cancelar</button>
              </div>
            </div>

            <!-- Tabela de itens adicionados -->
            <div id="calc-itens-adicionados-wrap" style="display:none;flex:1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div class="fsec" style="margin:0;">üõí Itens no C√°lculo</div>
                <button onclick="calcLimparItens()" style="font-size:11px;background:none;border:1px solid var(--danger);color:var(--danger);border-radius:6px;padding:2px 8px;cursor:pointer;">Limpar tudo</button>
              </div>
              <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                  <thead>
                    <tr style="background:var(--bg-surface-2,#f1f5f9);">
                      <th style="padding:6px 8px;text-align:left;font-weight:700;">Item</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Qtd</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Vl.Unit Emp.</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Vl.Compra</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Base</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Custo</th>
                      <th style="padding:6px 8px;text-align:right;font-weight:700;">Lucro</th>
                      <th style="padding:6px 4px;"></th>
                    </tr>
                  </thead>
                  <tbody id="calc-itens-tbody"></tbody>
                  <tfoot id="calc-itens-tfoot" style="font-weight:700;border-top:2px solid var(--border-light);"></tfoot>
                </table>
              </div>
            </div>

          </div><!-- /coluna esquerda -->

          <!-- COLUNA DIREITA: tipo, par√¢metros, resultado -->
          <div style="display:flex;flex-direction:column;gap:12px;">

            <!-- Tipo de c√°lculo (s√≥ Gadita) -->
            <div id="calc-tipo-gadita" style="display:none;">
              <div class="fsec" style="margin-bottom:8px;">Tipo de C√°lculo</div>
              <div style="display:flex;gap:8px;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 14px;border:2px solid var(--border-light);border-radius:10px;font-size:13px;font-weight:600;flex:1;justify-content:center;">
                  <input type="radio" name="calc-tipo" value="antigo" id="calc-tipo-antigo" onchange="calcTipoChanged()" checked> C√°lculo Antigo
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 14px;border:2px solid var(--border-light);border-radius:10px;font-size:13px;font-weight:600;flex:1;justify-content:center;">
                  <input type="radio" name="calc-tipo" value="novo" id="calc-tipo-novo" onchange="calcTipoChanged()"> C√°lculo Novo (ICMS)
                </label>
              </div>
            </div>

            <!-- Par√¢metros: Simples -->
            <div id="calc-bloco-simples" style="background:var(--bg-surface-2,#f8fafc);border:1px solid var(--border-light);border-radius:10px;padding:14px;">
              <div class="fsec" style="margin-bottom:10px;">‚öôÔ∏è Par√¢metros</div>
              <div class="fg">
                <label class="fl">% Custo aplicado sobre Vl. Empenho</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="number" class="fc" id="calc-pct-simples" value="9" step="0.1" oninput="calcRecalcular()" style="flex:1;font-size:18px;font-weight:700;text-align:center;">
                  <span style="font-size:20px;font-weight:800;color:var(--warning);">%</span>
                </div>
              </div>
            </div>

            <!-- Par√¢metros: ICMS -->
            <div id="calc-bloco-icms-info" style="display:none;background:var(--bg-surface-2,#f8fafc);border:1px solid var(--border-light);border-radius:10px;padding:14px;">
              <div class="fsec" style="margin-bottom:10px;">‚öôÔ∏è Par√¢metros ICMS</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                <div style="text-align:center;padding:10px;background:var(--accent-primary)10;border:1px solid var(--border-light);border-radius:8px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;font-weight:700;margin-bottom:4px;">Estado</div>
                  <div id="calc-estado-display" style="font-size:22px;font-weight:900;color:var(--accent-primary);"></div>
                </div>
                <div style="text-align:center;padding:10px;background:#fff3cd30;border:1px solid var(--border-light);border-radius:8px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;font-weight:700;margin-bottom:4px;">ICMS</div>
                  <div id="calc-icms-display" style="font-size:22px;font-weight:900;color:var(--warning);"></div>
                </div>
              </div>
              <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:10px;text-align:center;">PIS 0,65% ¬∑ COFINS 3% ¬∑ IRPJ (Base√ó8%√ó15%) ¬∑ CSLL (Base√ó12%√ó9%)</div>
              <div id="calc-bloco-icms-opts">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border:1px solid var(--border-light);border-radius:8px;font-size:13px;margin-bottom:8px;">
                  <input type="checkbox" id="calc-custo-empresa" onchange="calcRecalcular()"> Incluir custo da empresa (+3%)
                </label>
                <div class="fg" style="margin:0;">
                  <label class="fl">Cr√©dito de ICMS a abater (R$)</label>
                  <input type="number" class="fc" id="calc-credito-icms" placeholder="0,00" step="0.01" oninput="calcRecalcular()">
                </div>
              </div>
            </div>

            <!-- RESULTADO TOTAL -->
            <div id="calc-resultado-wrap" style="display:none;background:linear-gradient(135deg,var(--success-soft),rgba(16,185,129,0.05));border:2px solid var(--success);border-radius:14px;padding:16px;flex:1;">
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--success);margin-bottom:12px;letter-spacing:1px;">üìä Resultado Total</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.5);border-radius:10px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;margin-bottom:4px;">Val. Empenho</div>
                  <div id="calc-res-vem" style="font-size:17px;font-weight:800;color:var(--accent-primary);font-family:'JetBrains Mono',monospace;">‚Äî</div>
                </div>
                <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.5);border-radius:10px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;margin-bottom:4px;">Custo Total</div>
                  <div id="calc-res-custo" style="font-size:17px;font-weight:800;color:var(--warning);font-family:'JetBrains Mono',monospace;">‚Äî</div>
                </div>
                <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.5);border-radius:10px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;margin-bottom:4px;">Lucro</div>
                  <div id="calc-res-lucro" style="font-size:17px;font-weight:800;color:var(--success);font-family:'JetBrains Mono',monospace;">‚Äî</div>
                </div>
                <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.5);border-radius:10px;">
                  <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;margin-bottom:4px;">% Margem</div>
                  <div id="calc-res-margem" style="font-size:17px;font-weight:800;color:var(--success);font-family:'JetBrains Mono',monospace;">‚Äî</div>
                </div>
              </div>
              <!-- Detalhamento ICMS -->
              <div id="calc-icms-detalhes" style="font-size:11px;color:var(--text-secondary);border-top:1px solid rgba(16,185,129,0.3);padding-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:3px 16px;"></div>
            </div>

          </div><!-- /coluna direita -->

        </div><!-- /grid 2 colunas -->

            </div><!-- /calc-passo2 -->
    </div><!-- /modal-body -->
  </div>
</div>

<div class="modal-overlay" id="modal-confirm">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">Confirmar exclus√£o</div><button class="modal-close" onclick="closeConfirm()">‚úï</button></div>
    <div class="modal-body"><p id="confirm-msg" style="color:var(--text-secondary); font-size:13px;">Tem certeza que deseja excluir este registro?</p></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDel()">üóë Excluir</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// ==================== CONFIGURA√á√ïES ====================
const KEYS={disputas:'lic_ent_d',empenhos:'lic_ent_e'};
const isElectron = false;

// ===== PERSIST√äNCIA FIREBASE FIRESTORE =====
let _ignorarProximoSnapshot = false;
let _salvarTimeout = null;

// Remove undefined/NaN de objetos antes de enviar ao Firestore
function sanitizeForFirestore(obj) {
  return JSON.parse(JSON.stringify(obj, (key, val) => {
    if (val === undefined) return null;
    if (typeof val === 'number' && isNaN(val)) return 0;
    return val;
  }));
}

const save = (k, v) => {
  if (!fbAuth.currentUser) return;
  DB[k] = v;
  _ignorarProximoSnapshot = true;
  clearTimeout(_salvarTimeout);
  _salvarTimeout = setTimeout(() => { _ignorarProximoSnapshot = false; }, 3000);
  const vClean = sanitizeForFirestore(v);
  fbDB.collection('dados').doc('principal').set(
    { [k]: vClean },
    { merge: true }
  ).catch(e => {
    console.error('Erro ao salvar no Firebase:', e);
    _ignorarProximoSnapshot = false;
  });
};

const load = k => []; // n√£o usado mais (dados v√™m do Firestore)

// ===== USU√ÅRIO LOGADO =====
let usuarioLogado = null;

function fazerLogin() {
  const email = (document.getElementById('login-email')?.value || '').trim();
  const senha = (document.getElementById('login-senha')?.value || '');
  const erroEl = document.getElementById('login-erro');
  const btnEl  = document.getElementById('login-btn');
  if (!email || !senha) { if(erroEl) erroEl.textContent = 'Preencha e-mail e senha.'; return; }
  if(erroEl) erroEl.textContent = '';
  if(btnEl) { btnEl.textContent = 'Entrando...'; btnEl.disabled = true; }
  fbAuth.signInWithEmailAndPassword(email, senha)
    .catch(err => {
      if(erroEl) erroEl.textContent = 'E-mail ou senha incorretos.';
      if(btnEl) { btnEl.textContent = 'Entrar ‚Üí'; btnEl.disabled = false; }
    });
}

function fazerLogout() {
  fbAuth.signOut();
}

// Quando o estado de autentica√ß√£o muda (login/logout)
fbAuth.onAuthStateChanged(user => {
  if (user) {
    // Usu√°rio logou ‚Äî esconde tela de login, carrega dados
    document.getElementById('login-screen').classList.remove('open');
    const email = user.email;
    const nome = email.split('@')[0];
    const nomeFormatado = nome.charAt(0).toUpperCase() + nome.slice(1);
    document.getElementById('user-nome').textContent = nomeFormatado;
    document.getElementById('user-avatar').textContent = nomeFormatado.charAt(0).toUpperCase();
    usuarioLogado = nomeFormatado;
    // Sem filtro autom√°tico por analista ‚Äî exibe todos os dados
    filtroAnalista = 'todos';
    // Carrega dados do Firestore em tempo real
    fbDB.collection('dados').doc('principal').onSnapshot(doc => {
      // Ignora snapshots disparados pela pr√≥pria grava√ß√£o local
      if (_ignorarProximoSnapshot) {
        _ignorarProximoSnapshot = false;
        return;
      }
      if (doc.exists) {
        const data = doc.data();
        DB.disputas = data.disputas || [];
        DB.empenhos = data.empenhos || [];
      } else {
        DB.disputas = [];
        DB.empenhos = [];
      }
      renderAll();
      const btn = document.getElementById('login-btn');
      if(btn) { btn.textContent = 'Entrar ‚Üí'; btn.disabled = false; }
    }, err => {
      console.error('Erro ao ouvir Firestore:', err);
      toast('Erro ao carregar dados do servidor.', 'error');
    });
  } else {
    // Usu√°rio saiu ‚Äî mostra tela de login
    usuarioLogado = null;
    filtroAnalista = 'todos';
    DB.disputas = [];
    DB.empenhos = [];
    document.getElementById('login-screen').classList.add('open');
    const emailEl = document.getElementById('login-email');
    const senhaEl = document.getElementById('login-senha');
    if(emailEl) emailEl.value = '';
    if(senhaEl) senhaEl.value = '';
    const btn = document.getElementById('login-btn');
    if(btn) { btn.textContent = 'Entrar ‚Üí'; btn.disabled = false; }
  }
});

// ===== LOTES =====
let lotesTemp = [];

function adicionarLote() {
  lotesTemp.push({ id: uid(), descricao: '', qtd: 1, vunit: 0 });
  renderLotes();
}

function removerLote(idx) {
  lotesTemp.splice(idx, 1);
  renderLotes();
}

function renderLotes() {
  const c = document.getElementById('lotes-container');
  if (!c) return;
  if (!lotesTemp.length) {
    c.innerHTML = '';
    const tot = document.getElementById('lotes-totais');
    if (tot) tot.style.display = 'none';
    const av = document.getElementById('lotes-aviso');
    if (av) av.style.display = 'none';
    sincLoteVenda(0);
    return;
  }
  const disputaId = EID.disputas;
  c.innerHTML = lotesTemp.map((l, i) => {
    const total = (l.qtd||1)*(l.vunit||0);
    const qtdEnviada = disputaId ? calcQtdEnviada(disputaId, l.id) : 0;
    const qtdRestante = Math.max(0, (l.qtd||0) - qtdEnviada);
    const vlEnviado = qtdEnviada * (l.vunit||0);
    const corRestante = qtdRestante === 0 ? 'color:var(--success);font-weight:600;' : (qtdEnviada > 0 ? 'color:var(--warning);font-weight:600;' : 'color:var(--text-secondary);');
    return '<div style="display:grid;grid-template-columns:1fr 70px 100px 100px 70px 70px 90px 30px;gap:4px;align-items:center;margin-bottom:4px;" id="lote-row-'+i+'">' +
      '<input type="text" class="fc" value="'+(l.descricao||'')+'" placeholder="Ex: Arm√°rio" style="font-size:12px;padding:5px 8px;" oninput="lotesTemp['+i+'].descricao=this.value">' +
      '<input type="number" class="fc" value="'+(l.qtd||1)+'" min="1" step="1" style="font-size:12px;padding:5px 8px;" oninput="lotesTemp['+i+'].qtd=+this.value;atualizarLoteTotais('+i+')">' +
      '<input type="number" class="fc" value="'+(l.vunit||'')+'" placeholder="0,00" step="0.01" style="font-size:12px;padding:5px 8px;" oninput="lotesTemp['+i+'].vunit=+this.value;atualizarLoteTotais('+i+')">' +
      '<input type="number" class="fc" id="lote-total-'+i+'" value="'+total.toFixed(2)+'" readonly style="font-size:12px;padding:5px 8px;background:var(--bg-inset);color:var(--accent-primary);font-weight:600;">' +
      '<div style="font-size:11px;text-align:center;color:var(--text-secondary);font-weight:600;">'+qtdEnviada+'</div>' +
      '<div style="font-size:11px;text-align:center;'+corRestante+'" id="lote-restante-'+i+'">'+( qtdRestante===0 ? '‚úì' : qtdRestante)+'</div>' +
      '<div style="font-size:11px;text-align:center;color:var(--text-secondary);">'+fmt(vlEnviado)+'</div>' +
      '<button class="btn-lote-del" onclick="removerLote('+i+')">‚úï</button>' +
    '</div>';
  }).join('');
  atualizarTotalContrato();
}

// Atualiza s√≥ os campos calculados de uma linha, SEM re-renderizar (preserva o foco)
function atualizarLoteTotais(i) {
  const l = lotesTemp[i];
  const total = (l.qtd||0) * (l.vunit||0);
  const totEl = document.getElementById('lote-total-'+i);
  if (totEl) totEl.value = total.toFixed(2);
  atualizarTotalContrato();
}

function atualizarTotalContrato() {
  const total = lotesTemp.reduce((s, l) => s + (l.qtd||0)*(l.vunit||0), 0);
  const totEl = document.getElementById('lotes-totais');
  if (totEl) { totEl.style.display = 'flex'; document.getElementById('lt-count').textContent = lotesTemp.length; document.getElementById('lt-total').textContent = fmt(total); }
  const aviso = document.getElementById('lotes-aviso');
  if (aviso) aviso.style.display = 'none';
  sincLoteVenda(total);
}

function sincLoteVenda(total) {
  // d-venda removido junto com se√ß√£o financeira ‚Äî nada a sincronizar
}

// ===== EXCEL =====
let excelDataTemp = { d: null, e: null };

function handleExcelFile(event, prefix) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => processExcel(e.target.result, prefix, file.name);
  reader.readAsArrayBuffer(file);
}

function handleExcelDrop(event, prefix) {
  event.preventDefault();
  document.getElementById(prefix + '-excel-drop').classList.remove('dragover');
  const file = event.dataTransfer.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => processExcel(e.target.result, prefix, file.name);
  reader.readAsArrayBuffer(file);
}

function processExcel(buffer, prefix, filename) {
  try {
    const wb = XLSX.read(buffer, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    excelDataTemp[prefix] = { filename, data };
    renderExcelPreview(prefix);
  } catch(e) { alert('Erro ao ler arquivo: ' + e.message); }
}

function renderExcelPreview(prefix) {
  const d = excelDataTemp[prefix];
  const el = document.getElementById(prefix + '-excel-preview');
  const drop = document.getElementById(prefix + '-excel-drop');
  if (!d || !el) return;
  const rows = d.data.slice(0, 8);
  drop.innerHTML = `üìé <strong>${d.filename}</strong> ‚Äî <span style="color:var(--text-tertiary)">${d.data.length} linhas ¬∑ clique para trocar</span>`;
  el.innerHTML = `<div class="excel-preview"><table>
    ${rows.map((r, i) => `<tr>${r.map(c => i===0 ? `<th>${c}</th>` : `<td>${c}</td>`).join('')}</tr>`).join('')}
  </table></div>`;
}

// Dias sem recebimento (desde dcomp)
function diasSemPagamento(r) {
  if (r.recebido > 0) return 0;
  if (!r.dcomp) return 0;
  const compra = new Date(r.dcomp);
  const hoje = new Date();
  return Math.floor((hoje - compra) / 86400000);
}
// Empenho pago = todos os itens t√™m ao menos uma compra com dpag preenchido
function disputaEstaFinalizada(disputaId) {
  const emps = DB.empenhos.filter(e => e.disputaId === disputaId);
  if (!emps.length) return false; // precisa ter ao menos 1 empenho
  return emps.every(e => empenhoEstaPago(e));
}

function empenhoEstaPago(r) {
  const itens = (r.itens && r.itens.length) ? r.itens : (r.loteId ? [{id:'leg1'}] : []);
  if (!itens.length) return false;
  const compras = r.compras || [];
  return itens.every(item => compras.some(c => c.itemId === item.id && c.dpag));
}
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const fmt=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtP=v=>(Number(v||0)*100).toFixed(1)+'%';
const fmtD=s=>{if(!s)return'‚Äî';const[y,m,d]=s.split('-');return`${d}/${m}/${y}`;};
const parseAliq = (v) => {
  if (!v) return 0;
  return parseFloat(v.replace(',', '.')) / 100;
};

let DB={disputas:[],empenhos:[]};
let graficos = {};

// ===== INICIALIZA√á√ÉO =====
function inicializarApp(dadosSalvos) {
  const temDados = dadosSalvos &&
    (dadosSalvos.initialized ||
     (Array.isArray(dadosSalvos.disputas) && dadosSalvos.disputas.length > 0) ||
     (Array.isArray(dadosSalvos.empenhos) && dadosSalvos.empenhos.length > 0));

  if (temDados) {
    DB.disputas = dadosSalvos.disputas || [];
    DB.empenhos = dadosSalvos.empenhos || [];
    renderAll();
  } else {
    // Nenhum dado ‚Äî mostra tela de boas-vindas
    const tela = document.getElementById('tela-boasvindas');
    if (tela) tela.style.display = 'flex';
    renderAll();
  }
}

function iniciarSemDados() {
  DB.disputas = [];
  DB.empenhos = [];
  save('disputas', DB.disputas);
  save('empenhos', DB.empenhos);
  document.getElementById('tela-boasvindas').style.display = 'none';
  renderAll();
  toast('Sistema iniciado! Cadastre sua primeira disputa.', 'info');
}

// (boot movido para o final do script)

// ========== FUN√á√ïES DE C√ÅLCULO ==========
function dVals(r){
  const M=r.M||{};
  const imp=M.imp!==undefined?M.imp:r.venda*r.aliq;
  const luc=M.luc!==undefined?M.luc:r.venda-r.compra-imp;
  const pct=M.pct!==undefined?M.pct:(r.compra>0?luc/r.compra:0);
  return{imp,luc,pct};
}
function eVals(r){
  const M=r.M||{};
  const tot=M.tot!==undefined?M.tot:r.vunit*r.qtd;
  const imp=M.imp!==undefined?M.imp:r.vem*r.aliq;
  const luc=M.luc!==undefined?M.luc:r.vem-tot-imp;
  const pct=M.pct!==undefined?M.pct:(tot>0?luc/tot:0);
  const rec=M.rec!==undefined?M.rec:tot+luc;
  return{tot,imp,luc,pct,rec};
}

// ========== TOGGLE MANUAL ==========
let MS={d:{},e:{}};

function tog(p,f){
  const on=!MS[p][f];
  setField(p,f,on);
  syncMasterCheckbox(p);
  if(p==='e') calcE(); else calcD();
}

function setField(p,f,on){
  MS[p][f]=on;
  const ai=document.getElementById(`${p}-${f}-a`);
  const mi=document.getElementById(`${p}-${f}-m`);
  const btn=document.getElementById(`tbtn-${p}-${f}`);
  if(!ai||!mi||!btn)return;
  
  if(on){
    ai.style.display='none';
    mi.style.display='block';
    btn.classList.add('on');
    btn.innerHTML='<span class="dot"></span>Manual';
  } else {
    ai.style.display='block';
    mi.style.display='none';
    btn.classList.remove('on');
    btn.innerHTML='<span class="dot"></span>Auto';
  }
}

function resetFields(p){
  MS[p]={};
  const fields=p==='d'?['imp','luc','pct']:['tot','imp','luc','pct','rec'];
  fields.forEach(f=>setField(p,f,false));
  const cb=document.getElementById(`${p}-all`); if(cb)cb.checked=false;
}

function allManual(p,on){
  const fields=p==='d'?['imp','luc','pct']:['tot','imp','luc','pct','rec'];
  fields.forEach(f=>setField(p,f,on));
  if(p==='e') calcE(); else calcD();
}

function syncMasterCheckbox(p){
  const fields=p==='d'?['imp','luc','pct']:['tot','imp','luc','pct','rec'];
  const allOn=fields.every(f=>MS[p][f]);
  const cb=document.getElementById(`${p}-all`); if(cb)cb.checked=allOn;
}

// ========== C√ÅLCULOS AUTOM√ÅTICOS ==========
function calcD(){
  // Se√ß√£o financeira removida ‚Äî fun√ß√£o mantida para compatibilidade
}

function calcE(){
  const vu=+g('e-vunit').value||0, q=+g('e-qtd').value||0, ve=+g('e-vem').value||0;
  const a = parseAliq(g('e-aliq').value);
  const tot=vu*q, imp=ve*a, luc=ve-tot-imp, pct=tot>0?luc/tot:0, rec=tot+luc;
  
  if(!MS.e.tot) g('e-tot-a').value=fmt(tot);
  if(!MS.e.imp) g('e-imp-a').value=fmt(imp);
  if(!MS.e.luc) g('e-luc-a').value=fmt(luc);
  if(!MS.e.pct) g('e-pct-a').value=fmtP(pct);
  if(!MS.e.rec) g('e-rec-a').value=fmt(rec);
  
  // Se houver valores manuais, garantir que apare√ßam
  if(MS.e.tot && g('e-tot-m').value) g('e-tot-m').value = g('e-tot-m').value;
  if(MS.e.imp && g('e-imp-m').value) g('e-imp-m').value = g('e-imp-m').value;
  if(MS.e.luc && g('e-luc-m').value) g('e-luc-m').value = g('e-luc-m').value;
  if(MS.e.pct && g('e-pct-m').value) g('e-pct-m').value = g('e-pct-m').value;
  if(MS.e.rec && g('e-rec-m').value) g('e-rec-m').value = g('e-rec-m').value;
}

const g=id=>document.getElementById(id);
const gv=id=>g(id)?g(id).value:'';
const gn=id=>parseFloat(g(id)?g(id).value:0)||0;

// ========== VARI√ÅVEIS DE FILTRO ==========
let filtroAnalista = 'todos';
let filtroAnalistaDisputas = 'todos';
let filtroEmpresaDisputas = 'todas';
let filtroTipoDisputas = 'todos';
let filtroRpDisputas = 'todos';
let filtroSistemaDisputas = 'todos';
let filtroEstadoDisputas = 'todos';
let filtroStatusEmpenhos = 'todos';
let filtroAnalistaEmpenhos = 'todos';
let filtroVinculoEmpenhos = 'todos';
let filtroEmpenhoDisputas = 'todos';
let filtroSituacaoDisputas = 'todos';
let filtroComprasEmpenhos = 'todos';

// ========== FUN√á√ïES DE FILTRO ==========
function filtrarPorAnalista() {
  filtroAnalista = g('filtro-analista').value;
  renderAll();
  atualizarDashboard();
}

function filtrarDisputas() {
  // filtro situacao removido
  filtroEmpenhoDisputas = g('filtro-empenho-disputas')?.value || 'todos';
  filtroSituacaoDisputas = g('filtro-situacao-disputas')?.value || 'todos';
  filtroEmpresaDisputas = g('filtro-empresa-disputas').value;
  filtroTipoDisputas = g('filtro-tipo-disputas').value;
  filtroRpDisputas = g('filtro-rp-disputas').value;
  filtroSistemaDisputas = g('filtro-sistema-disputas').value;
  filtroEstadoDisputas = g('filtro-estado-disputas').value;
  filtroAnalistaDisputas = g('filtro-analista-disputas')?.value || 'todos';
  renderD();
}

let filtroAtrasoEmpenhos = 'todos';

function filtrarEmpenhos() {
  filtroStatusEmpenhos = g('filtro-status-empenhos').value;
  filtroAnalistaEmpenhos = g('filtro-analista-empenhos').value;
  filtroVinculoEmpenhos = g('filtro-vinculo-empenhos').value;
  filtroComprasEmpenhos = g('filtro-compras-empenhos')?.value || 'todos';
  filtroAtrasoEmpenhos = g('filtro-atraso-empenhos')?.value || 'todos';
  renderE();
}

function limparFiltrosDisputas() {
  ['filtro-empenho-disputas','filtro-situacao-disputas','filtro-empresa-disputas','filtro-tipo-disputas','filtro-rp-disputas','filtro-sistema-disputas','filtro-estado-disputas','filtro-analista-disputas'].forEach(id => {
    const el = g(id); if(el) el.selectedIndex = 0;
  });
  filtroEmpresaDisputas = 'todas';
  filtroTipoDisputas = 'todos';
  filtroRpDisputas = 'todos';
  filtroSistemaDisputas = 'todos';
  filtroEstadoDisputas = 'todos';
  filtroAnalistaDisputas = 'todos';
  filtroEmpenhoDisputas = 'todos';
  filtroSituacaoDisputas = 'todos';
  g('search-disputas').value = '';
  FLT.disputas = '';
  renderD();
}

function limparFiltrosEmpenhos() {
  g('filtro-status-empenhos').value = 'todos';
  g('filtro-analista-empenhos').value = 'todos';
  g('filtro-vinculo-empenhos').value = 'todos';
  if(g('filtro-compras-empenhos')) g('filtro-compras-empenhos').value = 'todos';
  filtroStatusEmpenhos = 'todos';
  filtroAnalistaEmpenhos = 'todos';
  filtroVinculoEmpenhos = 'todos';
  filtroComprasEmpenhos = 'todos';
  g('search-empenhos').value = '';
  FLT.empenhos = '';
  renderE();
}

// ========== TABS ==========
function switchTab(tab,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  g('tab-'+tab).classList.add('active');
  
  if(tab === 'disputas') {
    renderD();
  } else if(tab === 'empenhos') {
    renderE();
  } else if(tab === 'finalizadas') {
    renderFinalizadas();
  }
}

// ========== SORT E FILTRO ==========
let SS={disputas:{c:'data',a:false},empenhos:{c:'data',a:false}};
let FLT={disputas:'',empenhos:''};

function sort(tab,col){
  if(SS[tab].c === col) {
    SS[tab].a = !SS[tab].a;
  } else {
    SS[tab] = {c: col, a: false};
  }
  
  // Atualizar indicadores visuais
  document.querySelectorAll(`#sort-${tab}-${SS[tab].c}`).forEach(el => {
    el.className = SS[tab].a ? 'sort-desc' : 'sort-asc';
  });
  
  if(tab === 'disputas') renderD(); else renderE();
}

function getSorted(tab){
  const{c,a}=SS[tab];
  return[...DB[tab]].sort((x,y)=>{
    let va=x[c]??'',vb=y[c]??'';
    
    // Tratamento especial para valores calculados
    if(c === 'lucro' && tab === 'disputas') {
      va = dVals(x).luc;
      vb = dVals(y).luc;
    } else if(c === 'pct' && tab === 'disputas') {
      va = dVals(x).pct;
      vb = dVals(y).pct;
    } else if(c === 'lucro' && tab === 'empenhos') {
      va = eVals(x).luc;
      vb = eVals(y).luc;
    } else if(c === 'pct' && tab === 'empenhos') {
      va = eVals(x).pct;
      vb = eVals(y).pct;
    } else if(c === 'recebido' && tab === 'empenhos') {
      va = x.recebido || 0;
      vb = y.recebido || 0;
    } else if(!isNaN(parseFloat(va)) && !isNaN(parseFloat(vb))) {
      va = parseFloat(va) || 0;
      vb = parseFloat(vb) || 0;
    }
    
    if(va < vb) return a ? 1 : -1;
    if(va > vb) return a ? -1 : 1;
    return 0;
  });
}

function filterTable(tab,v){FLT[tab]=v.toLowerCase(); if(tab==='disputas') renderD(); else renderE();}

function matches(tab,r){
  const q=FLT[tab];
  
  // Filtro por analista global
  if(filtroAnalista !== 'todos' && r.analista !== filtroAnalista) return false;
  
  if(tab === 'disputas') {
    if(filtroEmpresaDisputas !== 'todas' && r.empresa !== filtroEmpresaDisputas) return false;
    if(filtroTipoDisputas !== 'todos' && r.tipo !== filtroTipoDisputas) return false;
    if(filtroRpDisputas !== 'todos' && r.rp !== filtroRpDisputas) return false;
    if(filtroSistemaDisputas !== 'todos' && r.sistema !== filtroSistemaDisputas) return false;
    if(filtroEstadoDisputas !== 'todos' && r.estado !== filtroEstadoDisputas) return false;
    if(filtroAnalistaDisputas !== 'todos' && r.analista !== filtroAnalistaDisputas) return false;
    if(filtroEmpenhoDisputas !== 'todos') {
      const temEmpenho = DB.empenhos.some(e => e.disputaId === r.id);
      if(filtroEmpenhoDisputas === 'com-empenho' && !temEmpenho) return false;
      if(filtroEmpenhoDisputas === 'sem-empenho' && temEmpenho) return false;
    }
    if(filtroSituacaoDisputas !== 'todos') {
      const finalizada = disputaEstaFinalizada(r.id);
      if(filtroSituacaoDisputas === 'finalizada' && !finalizada) return false;
      if(filtroSituacaoDisputas === 'em-andamento' && finalizada) return false;
    }
  }
  
  if(tab === 'empenhos') {
    // Filtro de analista espec√≠fico da aba empenhos
    if(filtroAnalistaEmpenhos !== 'todos' && r.analista !== filtroAnalistaEmpenhos) return false;
    // Filtro status pagamento
    if(filtroStatusEmpenhos !== 'todos') {
      const pago = empenhoEstaPago(r);
      if(filtroStatusEmpenhos === 'pagos' && !pago) return false;
      if(filtroStatusEmpenhos === 'nao-pagos' && pago) return false;
    }
    // Filtro v√≠nculo com disputa
    if(filtroVinculoEmpenhos !== 'todos') {
      const temVinculo = !!r.disputaId;
      if(filtroVinculoEmpenhos === 'vinculados' && !temVinculo) return false;
      if(filtroVinculoEmpenhos === 'sem-vinculo' && temVinculo) return false;
    }
    // Filtro compras
    if(filtroComprasEmpenhos !== 'todos') {
      const temCompras = (r.compras || []).length > 0;
      if(filtroComprasEmpenhos === 'com-compras' && !temCompras) return false;
      if(filtroComprasEmpenhos === 'sem-compras' && temCompras) return false;
    }
    if(filtroAtrasoEmpenhos !== 'todos') {
      const pago = empenhoEstaPago(r);
      if(pago) return false; // pagos n√£o entram no filtro de atraso
      const dias = diasSemPagamento(r);
      if(filtroAtrasoEmpenhos === '30' && dias < 30) return false;
      if(filtroAtrasoEmpenhos === '60' && dias < 60) return false;
      if(filtroAtrasoEmpenhos === '90' && dias < 90) return false;
    }
  }
  
  // Filtro de pesquisa texto
  if(!q) return true;
  return Object.values(r).some(v=>String(v||'').toLowerCase().includes(q));
}

// ========== BADGES ==========
const badgeD=s=>{const m={'Em recurso':'by',Habilitado:'bb',Homologado:'bp',Contratado:'bg',Comprado:'by',Pago:'bg'}; return`<span class="badge ${m[s]||'bx'}">${s||'‚Äî'}</span>`; };
const mTag=r=>Object.keys(r.M||{}).length?`<span class="badge by" style="font-size:8px;padding:2px 4px;margin-left:2px;">M</span>`:'';

// ========== FUN√á√ïES DE DUPLICA√á√ÉO ==========
function duplicarDisputa(id){
  const original = DB.disputas.find(x => x.id === id);
  if (!original) return;
  
  const copia = JSON.parse(JSON.stringify(original));
  copia.id = uid();
  copia.compra = 0;
  copia.venda = 0;
  copia.aliq = 0.145;
  copia.M = {};
  
  DB.disputas.push(copia);
  save('disputas', DB.disputas);
  toast('Disputa duplicada com sucesso!', 'success');
  renderAll();
}

function duplicarEmpenho(id){
  const original = DB.empenhos.find(x => x.id === id);
  if (!original) return;
  
  const copia = JSON.parse(JSON.stringify(original));
  copia.id = uid();
  copia.vunit = 0;
  copia.qtd = 1;
  copia.vem = 0;
  copia.aliq = 0.13;
  copia.recebido = 0;
  copia.dreceb = '';
  copia.disputaId = null;
  copia.M = {};
  
  DB.empenhos.push(copia);
  save('empenhos', DB.empenhos);
  toast('Empenho duplicado com sucesso!', 'success');
  renderAll();
}

// ===== LOTES HELPERS =====
function calcQtdEnviada(disputaId, loteId, excludeEmpenhoId) {
  return DB.empenhos
    .filter(e => e.disputaId === disputaId && e.id !== excludeEmpenhoId)
    .reduce((s, e) => {
      // Novo formato: itens[]
      if(e.itens && e.itens.length) {
        const item = e.itens.find(i=>i.loteId===loteId);
        return s + (item ? item.qtd : 0);
      }
      // Formato legado
      if(e.loteId === loteId) return s + (e.qtdLote || 0);
      return s;
    }, 0);
}

function getValorContrato(r) {
  return (r.lotes || []).reduce((s, l) => s + (l.qtd || 0) * (l.vunit || 0), 0);
}

function getLotesComSaldo(disputaId, excludeEmpenhoId) {
  const disp = DB.disputas.find(d => d.id === disputaId);
  if (!disp) return [];
  return (disp.lotes || []).map(l => {
    const qtdEnviada = calcQtdEnviada(disputaId, l.id, excludeEmpenhoId);
    return { ...l, qtdEnviada, qtdRestante: (l.qtd || 0) - qtdEnviada };
  });
}

// ===== POPUP DETALHES =====
function abrirPopupDisputa(id) {
  const r = DB.disputas.find(x => x.id === id);
  if (!r) return;
  const { imp, luc, pct } = dVals(r);
  const contrato = getValorContrato(r);
  const lotes = getLotesComSaldo(id);
  const emps = DB.empenhos.filter(e => e.disputaId === id);
  
  // Lucro realizado = soma do lucro das compras que t√™m data de pagamento preenchida
  const lucroRealizado = emps.reduce((s,e) => {
    return s + (e.compras||[]).filter(c=>c.dpag).reduce((ss,c)=>ss+(c.luc||0),0);
  }, 0);

  const lotesHTML = lotes.length ? `
    <div class="detail-section">üì¶ ITENS / LOTES</div>
    <table class="lotes-status-table">
      <thead><tr><th>Descri√ß√£o</th><th>Qtd</th><th>Vl.Unit</th><th>Empenhado</th><th>Enviado (Compras)</th><th>Restante</th><th>Progresso</th><th>Empenhos</th><th>Pago?</th></tr></thead>
      <tbody>${lotes.map(l => {
        const pctVal = l.qtd > 0 ? Math.min(100, Math.round(l.qtdEnviada / l.qtd * 100)) : 0;
        const cls = l.qtdRestante <= 0 ? 'saldo-zero' : l.qtdEnviada > 0 ? 'saldo-parcial' : 'saldo-ok';
        const empsLote = emps.filter(e => {
          if(e.itens && e.itens.length) return e.itens.some(i=>i.loteId===l.id);
          return e.loteId === l.id;
        });
        // Calcula qtd enviada via compras registradas nos empenhos deste lote
        const qtdViaCompras = empsLote.reduce((s, e) => {
          const itensEmp = e.itens && e.itens.length ? e.itens : (e.loteId === l.id ? [{id:'leg', loteId:l.id}] : []);
          const itemEmp = itensEmp.find(i=>i.loteId===l.id);
          if(!itemEmp) return s;
          return s + (e.compras||[]).reduce((ss,c) => ss + (c.itemId === itemEmp.id ? (c.qtd||0) : 0), 0);
        }, 0);
        // Verifica se algum item deste lote tem compra com data de pagamento preenchida
        const algumPago = empsLote.some(e => {
          const itensEmp = e.itens && e.itens.length ? e.itens : (e.loteId === l.id ? [{id:'leg', loteId:l.id}] : []);
          const itemEmp = itensEmp.find(i=>i.loteId===l.id);
          if(!itemEmp) return false;
          return (e.compras||[]).some(c => c.itemId === itemEmp.id && c.dpag);
        });
        const statusPag = empsLote.length === 0 ? '‚Äî' : algumPago ? '<span class="status-pago">‚úÖ PAGO</span>' : '<span class="status-pendente">‚è≥ PENDENTE</span>';
        return '<tr>' +
          '<td><strong>' + (l.descricao||'‚Äî').toUpperCase() + '</strong></td>' +
          '<td class="mono">' + (l.qtd||0) + '</td>' +
          '<td class="mono">' + fmt(l.vunit) + '</td>' +
          '<td class="mono" style="color:var(--accent-primary);font-weight:600;">' + l.qtdEnviada + '</td>' +
          '<td class="mono" style="color:var(--success);font-weight:600;">' + qtdViaCompras + '</td>' +
          '<td class="mono ' + cls + '">' + (l.qtdRestante > 0 ? l.qtdRestante : '‚úì COMPLETO') + '</td>' +
          '<td><div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:' + pctVal + '%"></div></div></td>' +
          '<td>' + (empsLote.map(e => '<span onclick="abrirPopupEmpenho(\''+e.id+'\')" style="cursor:pointer;color:var(--accent-primary);font-size:10px;font-weight:600;margin-right:4px;">#' + e.num + '</span>').join('') || '‚Äî') + '</td>' +
          '<td>' + statusPag + '</td>' +
          '</tr>';
      }).join('')}</tbody>
    </table>` : '<p style="color:var(--text-tertiary);font-size:12px;margin-top:8px;">Nenhum item cadastrado.</p>';

  g('popup-d-title').textContent = (r.orgao || 'DISPUTA').toUpperCase();
  g('popup-d-sub').textContent = (r.processo||'') + ' ¬∑ ' + (r.sistema||'') + ' ¬∑ ' + fmtD(r.data);
  g('popup-d-body').innerHTML =
    '<div class="detail-grid-3">' +
      '<div class="detail-field"><div class="detail-field-label">EMPRESA</div><div class="detail-field-value">' + (r.empresa||'‚Äî') + '</div></div>' +
      '<div class="detail-field"><div class="detail-field-label">ANALISTA</div><div class="detail-field-value">' + (r.analista||'‚Äî') + '</div></div>' +
      '<div class="detail-field"><div class="detail-field-label">UF / TIPO / RP</div><div class="detail-field-value">' + (r.estado||'‚Äî') + ' ¬∑ ' + (r.tipo||'') + ' ¬∑ RP ' + (r.rp||'‚Äî') + '</div></div>' +

      '<div class="detail-field"><div class="detail-field-label">VALOR DO CONTRATO</div><div class="detail-field-value" style="color:var(--accent-primary)">' + fmt(contrato || r.venda) + '</div></div>' +
      '<div class="detail-field"><div class="detail-field-label">LUCRO REALIZADO</div><div class="detail-field-value" style="color:var(--success);font-weight:700;">' + fmt(lucroRealizado) + '</div></div>' +
    '</div>' +
    (r.observacao ? '<div class="detail-field" style="margin-bottom:12px;"><div class="detail-field-label">OBSERVA√á√ÉO</div><div class="detail-field-value" style="font-size:13px;font-weight:400;">' + r.observacao.toUpperCase() + '</div></div>' : '') +

    lotesHTML;

  g('popup-d-edit-btn').onclick = () => { fecharPopup('disputa'); editD(id); };
  g('popup-d-new-emp-btn').onclick = () => novoEmpenhoParaDisputa(id);
  g('popup-disputa').classList.add('open');
}

function abrirPopupEmpenho(id) {
  const r = DB.empenhos.find(x => x.id === id);
  if (!r) return;
  const { tot, imp, luc, pct, rec } = eVals(r);
  const dias = diasSemPagamento(r);
  const disp = r.disputaId ? DB.disputas.find(d => d.id === r.disputaId) : null;
  
  // Itens do empenho
  const itens = r.itens && r.itens.length ? r.itens : 
    (r.loteId ? [{ id:'leg1', loteId:r.loteId, descricao:r.produto||'', qtd:r.qtd||1, vunit:r.vunit||0 }] : []);
  
  const compras = r.compras || [];
  
  const itensHTML = itens.length ? `
    <div class="detail-section">üì¶ ITENS DO EMPENHO</div>
    <table class="lotes-status-table">
      <thead><tr><th>Item</th><th>Qtd</th><th>Vl.Unit</th><th>Vl.Total</th><th>Compras</th><th>Pago?</th></tr></thead>
      <tbody>${itens.map(item => {
        const comprasItem = compras.filter(c=>c.itemId===item.id);
        const totalPago = comprasItem.filter(c=>c.dpag).reduce((s,c)=>s+c.luc,0);
        const totalRec = comprasItem.reduce((s,c)=>s+c.rec,0);
        const pago = comprasItem.some(c=>c.dpag);
        return '<tr>' +
          '<td><strong>'+(item.descricao||'‚Äî').toUpperCase()+'</strong></td>' +
          '<td class="mono">'+(item.qtd||0)+'</td>' +
          '<td class="mono">'+fmt(item.vunit)+'</td>' +
          '<td class="mono" style="color:var(--accent-primary);font-weight:700;">'+fmt((item.qtd||0)*(item.vunit||0))+'</td>' +
          '<td class="mono">'+comprasItem.length+'</td>' +
          '<td>'+(pago ? '<span class="status-pago">‚úÖ PAGO</span>' : '<span class="status-pendente">‚è≥ PENDENTE</span>')+'</td>' +
          '</tr>';
      }).join('')}</tbody>
    </table>` : '';
  
  const comprasHTML = compras.length ? `
    <div class="detail-section">üõí COMPRAS INDIVIDUAIS</div>
    <table class="lotes-status-table">
      <thead><tr><th>Item</th><th>Plataforma</th><th>Qtd</th><th>Vl.Compra</th><th>Custo</th><th>Lucro</th><th>A Receber</th><th>Pago</th><th>Dt.Pag</th><th>A√ß√µes</th></tr></thead>
      <tbody>${compras.map(c => {
        const itemRef = itens.find(i=>i.id===c.itemId);
        const pago = c.recebido > 0;
        return '<tr>' +
          '<td style="font-size:10px;">'+((itemRef?.descricao||'‚Äî').toUpperCase())+'</td>' +
          '<td style="font-size:10px;font-weight:600;">'+(c.plataforma||'‚Äî')+'</td>' +
          '<td class="mono">'+(c.qtd||0)+'</td>' +
          '<td class="mono">'+fmt(c.vtotal||0)+'</td>' +
          '<td class="mono" style="color:var(--warning);">'+fmt(c.custo||0)+'</td>' +
          '<td class="mono" style="color:var(--success);font-weight:700;">'+fmt(c.luc||0)+'</td>' +
          '<td class="mono" style="color:var(--accent-primary);">'+fmt(c.rec||0)+'</td>' +
          '<td>'+(pago?'<span class="status-pago">‚úÖ '+fmt(c.recebido)+'</span>':'<span class="status-pendente">‚Äî</span>')+'</td>'+
          '<td class="mono">'+(fmtD(c.dpag)||'‚Äî')+'</td>' +
          '<td onclick="event.stopPropagation()">' +
            '<button class="btn btn-ghost btn-sm" onclick="fecharPopup(\'empenho\');fecharPopup(\'disputa\');abrirCompra(\''+r.id+'\',\''+c.id+'\')" title="Editar">‚úèÔ∏è</button>' +
            '<button class="btn btn-danger btn-sm" onclick="delCompra(\''+r.id+'\',\''+c.id+'\')" title="Excluir">üóë</button>' +
          '</td>' +
          '</tr>';
      }).join('')}</tbody>
    </table>` : `<div class="detail-section">üõí COMPRAS</div><div style="color:var(--text-tertiary);font-size:12px;padding:8px;">Nenhuma compra cadastrada.</div>`;

  // Impostos calculados a partir das compras realizadas (soma dos custos)
  const impRealizado = compras.reduce((s,c) => s + (c.custo||0), 0);

  g('popup-e-title').textContent = 'EMPENHO #' + (r.num || '‚Äî');
  g('popup-e-sub').textContent = (r.orgao||'').toUpperCase() + ' ¬∑ ' + fmtD(r.data);
  g('popup-e-body').innerHTML =
    '<div class="detail-grid-3">' +
      '<div class="detail-field"><div class="detail-field-label">ANALISTA</div><div class="detail-field-value">' + (r.analista||'‚Äî') + '</div></div>' +
      '<div class="detail-field"><div class="detail-field-label">STATUS</div><div class="detail-field-value">' + (empenhoEstaPago(r) ? '<span class="status-pago">‚úÖ PAGO</span>' : '<span class="status-pendente">‚è≥ PENDENTE</span>') + '</div></div>' +
    '</div>' +
    (disp ? '<div class="detail-field" style="margin-bottom:12px;"><div class="detail-field-label">DISPUTA VINCULADA</div><div class="detail-field-value" style="cursor:pointer;color:var(--accent-primary)" onclick="fecharPopup(\'empenho\');abrirPopupDisputa(\''+disp.id+'\')">üîó ' + disp.orgao.toUpperCase() + ' ¬∑ ' + disp.processo + '</div></div>' : '') +
    '<div class="detail-grid">' +
      '<div class="detail-field"><div class="detail-field-label">VAL. EMPENHO</div><div class="detail-field-value" style="color:var(--accent-primary)">' + fmt(r.vem) + '</div></div>' +
      '<div class="detail-field"><div class="detail-field-label">IMPOSTOS</div><div class="detail-field-value" style="color:var(--warning)">' + fmt(impRealizado) + (compras.length === 0 ? ' <span style="font-size:9px;color:var(--text-tertiary);">(sem compras)</span>' : '') + '</div></div>' +

      '<div class="detail-field"><div class="detail-field-label">LUCRO REALIZADO</div><div class="detail-field-value" style="color:var(--success)">' + fmt(compras.filter(c=>c.dpag).reduce((s,c)=>s+c.luc,0)) + '</div></div>' +

      '<div class="detail-field"><div class="detail-field-label">DIAS SEM PAG.</div><div class="detail-field-value">' + (r.recebido > 0 ? '‚úì PAGO' : dias + ' DIAS') + '</div></div>' +
    '</div>' +
    itensHTML +
    '<div style="margin-top:12px;">' +
      '<button class="btn btn-primary btn-sm" onclick="fecharPopup(\'empenho\');fecharPopup(\'disputa\');abrirCompra(\''+r.id+'\')" style="width:100%;">Ôºã NOVA COMPRA PARA ESTE EMPENHO</button>' +
    '</div>' +
    comprasHTML +
    (r.observacao ? '<div class="detail-field" style="margin-top:12px;"><div class="detail-field-label">OBSERVA√á√ÉO</div><div class="detail-field-value" style="font-size:13px;font-weight:400;">' + r.observacao.toUpperCase() + '</div></div>' : '');

  g('popup-e-edit-btn').onclick = () => { fecharPopup('empenho'); fecharPopup('disputa'); editE(id); };
  g('popup-empenho').classList.add('open');
}

function fecharPopup(tipo) {
  g('popup-' + tipo).classList.remove('open');
}

// ===== LOTE SELECTOR no modal empenho =====
let lotesSelecionados = {}; // loteId -> qtd
let vemManual = false;

function togVemManual() {
  vemManual = !vemManual;
  const btn = g('tbtn-e-vem');
  const ai = g('e-vem-a'); const mi = g('e-vem');
  if(vemManual) { ai.style.display='none'; mi.style.display='block'; if(btn){btn.classList.add('on');btn.innerHTML='<span class="dot"></span>Manual';} }
  else { ai.style.display='block'; mi.style.display='none'; if(btn){btn.classList.remove('on');btn.innerHTML='<span class="dot"></span>Auto';} recalcVem(); }
  calcE();
}

function recalcVem() {
  if(vemManual) return;
  // Soma vunit*qtd de todos lotes selecionados
  let total = 0;
  const disputaId = gv('e-disputa-id');
  if(disputaId) {
    const disp = DB.disputas.find(d=>d.id===disputaId);
    if(disp) {
      Object.entries(lotesSelecionados).forEach(([loteId, qtd]) => {
        const lote = (disp.lotes||[]).find(l=>l.id===loteId);
        if(lote) total += (lote.vunit||0)*qtd;
      });
    }
  }
  const ai = g('e-vem-a');
  if(ai) ai.value = fmt(total);
  // Para calcE, sincronizar no campo hidden
  const mi = g('e-vem'); if(mi && !vemManual) mi.value = total.toFixed(2);
  return total;
}

function onDisputaSelecionada(disputaId) {
  lotesSelecionados = {};
  const wrap = g('lote-selector-wrap');
  const container = g('lote-selector-container');
  if (!disputaId) { if(wrap) wrap.style.display = 'none'; return; }
  const disp = DB.disputas.find(d => d.id === disputaId);
  // Preenche analista automaticamente a partir da disputa
  const analistaEl = g('e-analista');
  if(analistaEl && disp) analistaEl.value = disp.analista || '';
  if (!disp || !(disp.lotes||[]).length) { if(wrap) wrap.style.display = 'none'; return; }
  // Ao editar, exclui o pr√≥prio empenho do c√°lculo de saldo para n√£o travar os itens
  const excludeId = EID.empenhos || null;
  const lotes = getLotesComSaldo(disputaId, excludeId);
  if(wrap) wrap.style.display = 'block';
  if(container) container.innerHTML = lotes.map(l => {
    const semSaldo = l.qtdRestante <= 0;
    const dataAttrs = semSaldo ? '' : `data-lid="${l.id}" data-maxqtd="${l.qtdRestante}" data-vunit="${l.vunit}" onclick="toggleLoteCard(this)"`;
    return `<div class="lote-selector-card${semSaldo?' sem-saldo':''}" id="lcard-${l.id}" ${dataAttrs}>`
      + `<input type="checkbox" name="lote-check" ${semSaldo?'disabled':''} style="margin:0;">`
      + `<div><div style="font-weight:700;font-size:13px;">${(l.descricao||'‚Äî').toUpperCase()}</div>`
      + `<div style="font-size:11px;color:var(--text-tertiary)">Vl.Unit: ${fmt(l.vunit)} ¬∑ Contratado: ${l.qtd||0} ¬∑ Enviado: ${l.qtdEnviada}</div></div>`
      + `<span class="lote-saldo-badge ${semSaldo?'lote-saldo-zero':'lote-saldo-ok'}">${semSaldo?'‚úì Completo':l.qtdRestante+' restantes'}</span>`
      + `<div class="lote-qtd-input-wrap" id="lqtd-wrap-${l.id}" style="display:none;">`
      + `<label style="font-size:11px;color:var(--text-tertiary);">Qtd:</label>`
      + `<input type="number" min="1" max="${l.qtdRestante}" value="1" id="lqtd-${l.id}" onclick="event.stopPropagation()" data-lid="${l.id}" data-vunit="${l.vunit}" data-maxqtd="${l.qtdRestante}" oninput="atualizarVemPorLoteEl(this)">`
      + `</div>`
      + `<div style="font-size:11px;font-weight:700;color:var(--accent-primary);min-width:80px;text-align:right;" id="lval-${l.id}"></div>`
      + `</div>`;
  }).join('');
  const tvWrap = g('lote-valor-total-wrap'); if(tvWrap) tvWrap.style.display = 'none';
}

function toggleLoteCard(el) {
  const loteId = el.dataset.lid;
  const maxQtd = +el.dataset.maxqtd;
  const vunit  = +el.dataset.vunit;
  const isSelected = el.classList.contains('selected');
  if(isSelected) {
    // Desseleciona
    el.classList.remove('selected');
    const chk = el.querySelector('input[type=checkbox]'); if(chk) chk.checked = false;
    const qtdWrap = g('lqtd-wrap-'+loteId); if(qtdWrap) qtdWrap.style.display = 'none';
    const valEl = g('lval-'+loteId); if(valEl) valEl.textContent = '';
    delete lotesSelecionados[loteId];
  } else {
    // Seleciona
    el.classList.add('selected');
    const chk = el.querySelector('input[type=checkbox]'); if(chk) chk.checked = true;
    const qtdWrap = g('lqtd-wrap-'+loteId); if(qtdWrap) qtdWrap.style.display = 'flex';
    lotesSelecionados[loteId] = 1;
    const valEl = g('lval-'+loteId); if(valEl) valEl.textContent = fmt(vunit*1);
  }
  const av = g('lote-aviso'); if(av) av.style.display = 'none';
  atualizarVemTotal();
}

function selecionarLoteCard(el) {
  // Mant√©m compatibilidade com c√≥digo antigo
  toggleLoteCard(el);
}

function atualizarVemTotal() {
  const disputaId = gv('e-disputa-id');
  const disp = disputaId ? DB.disputas.find(d=>d.id===disputaId) : null;
  let total = 0;
  Object.entries(lotesSelecionados).forEach(([loteId, qtd]) => {
    const lote = disp ? (disp.lotes||[]).find(l=>l.id===loteId) : null;
    if(lote) total += (lote.vunit||0)*qtd;
    const valEl = g('lval-'+loteId); if(valEl) valEl.textContent = fmt((lote?.vunit||0)*qtd);
  });
  const tvWrap = g('lote-valor-total-wrap');
  const tvCalc = g('lote-valor-total-calc');
  if(tvWrap) tvWrap.style.display = Object.keys(lotesSelecionados).length > 0 ? 'block' : 'none';
  if(tvCalc) tvCalc.textContent = fmt(total);
  if(!vemManual) {
    const ai = g('e-vem-a'); if(ai) ai.value = fmt(total);
    const mi = g('e-vem'); if(mi) mi.value = total.toFixed(2);
    calcE();
  }
}

function selecionarLote(loteId, maxQtd, vunit) {
  document.querySelectorAll('.lote-selector-card').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll('[id^="lqtd-wrap-"]').forEach(w => w.style.display = 'none');
  document.querySelectorAll('input[name="lote-radio"]').forEach(r => r.checked = false);
  lotesSelecionados = {};
  const card = g('lcard-' + loteId);
  if (card) { card.classList.add('selected'); const radio = card.querySelector('input[type=radio]'); if(radio) radio.checked = true; }
  const qtdWrap = g('lqtd-wrap-' + loteId);
  if (qtdWrap) qtdWrap.style.display = 'flex';
  lotesSelecionados[loteId] = 1;
  // Esconde o aviso de "selecione um lote"
  const av = g('lote-aviso'); if(av) av.style.display = 'none';
  atualizarVemPorLote(loteId, vunit, maxQtd);
}

function selecionarLote(loteId, maxQtd, vunit) {
  // Mant√©m compatibilidade - agora faz toggle
  const card = g('lcard-'+loteId);
  if(card) toggleLoteCard(card);
}

function atualizarVemPorLoteEl(input) {
  atualizarVemPorLote(input.dataset.lid, +input.dataset.vunit, +input.dataset.maxqtd);
}

function atualizarVemPorLote(loteId, vunit, maxQtd) {
  const input = g('lqtd-' + loteId);
  if (!input) return;
  let qtd = parseInt(input.value) || 1;
  if (qtd < 1) qtd = 1;
  if (qtd > maxQtd) { qtd = maxQtd; input.value = maxQtd; }
  lotesSelecionados[loteId] = qtd;
  atualizarVemTotal();
}

function renderD(){
  const rows=getSorted('disputas').filter(r=>!r.finalizada && matches('disputas',r));
  const tb=g('tbody-disputas');
  if(!rows.length){ tb.innerHTML='<tr><td colspan="5"><div class="empty-state"><div class="icon">üèÜ</div><p>Nenhuma disputa encontrada</p></div></td></tr>'; sumD(); return; }
  tb.innerHTML=rows.map(r=>{
    const{luc}=dVals(r);
    const lotes = r.lotes || [];
    const totalContratado = lotes.reduce((s,l)=>s+(l.qtd||0), 0);
    const totalEnviado = lotes.reduce((s,l)=>s+calcQtdEnviada(r.id, l.id), 0);
    const pctProg = totalContratado > 0 ? Math.round(totalEnviado/totalContratado*100) : 0;
    const contrato = getValorContrato(r);
    const lotesInfo = lotes.length
      ? '<div style="display:flex;flex-direction:column;gap:2px;">'
        + '<span style="font-size:11px;font-weight:600;color:var(--accent-primary);">' + lotes.length + ' lotes ¬∑ ' + totalContratado + ' un.</span>'
        + '<div style="height:4px;background:var(--bg-inset);border-radius:2px;width:80px;overflow:hidden;"><div style="height:100%;background:var(--accent-primary);border-radius:2px;width:'+pctProg+'%"></div></div>'
        + '<span style="font-size:9px;color:var(--text-tertiary);">' + totalEnviado + '/' + totalContratado + ' enviados</span></div>'
      : '<span style="color:var(--danger);font-size:10px;">‚ö† sem itens</span>';
    return '<tr style="cursor:pointer;" onclick="abrirPopupDisputa(\'' + r.id + '\')">' +
      '<td onclick="event.stopPropagation()" style="text-align:center;"><input type="checkbox" class="chk-row-disputas" data-id="' + r.id + '" onchange="onRowCheck(\'disputas\')" style="cursor:pointer;width:15px;height:15px;"></td>' +
      '<td class="mono" style="font-size:11px;">' + fmtD(r.data) + '</td>' +
      '<td><div style="font-weight:600;font-size:13px;line-height:1.3;">' + (r.orgao||'‚Äî') + '</div><span class="estado-badge" style="font-size:9px;">' + (r.estado||'‚Äî') + '</span></td>' +
      '<td><span class="badge ' + (r.analista==='M√°rdea'?'bp':'bb') + '" style="font-size:10px;">' + (r.analista||'‚Äî') + '</span></td>' +
      '<td onclick="event.stopPropagation()">'  +
        '<button class="btn btn-ghost btn-sm" onclick="editD(\'' + r.id + '\')" title="Editar">‚úèÔ∏è</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="duplicarDisputa(\'' + r.id + '\')" title="Duplicar">üìã</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="finalizarDisputa(\'' + r.id + '\')" title="Finalizar disputa" style="color:var(--success);border-color:var(--success);">üèÅ</button>' +
        '<button class="btn btn-danger btn-sm" onclick="delRow(\'disputas\',\'' + r.id + '\')" title="Excluir">üóë</button>' +
      '</td></tr>';
  }).join('');
  sumD();
}

function sumD(){
  const a=DB.disputas.filter(r=>matches('disputas',r));
  const tv=a.reduce((s,r)=>s+getValorContrato(r),0);
  // Lucro recebido: soma das compras pagas dos empenhos vinculados √†s disputas filtradas
  const idsDisputas = new Set(a.map(r=>r.id));
  const lucroRecebidoD = DB.empenhos
    .filter(e=>idsDisputas.has(e.disputaId))
    .reduce((s,e)=>s+(e.compras||[])
      .filter(c=>c.dpag && c.dpag!=='')
      .reduce((ss,c)=>{
        const luc=(c.luc!==undefined&&c.luc!==null)?c.luc:(c.rec||0)-(c.vtotal||0)-(c.custo||0);
        return ss+luc;
      },0),0);
  g('sum-disputas').innerHTML=`
    <div class="card"><div class="card-label">Total</div><div class="card-value cv-blue">${a.length}</div></div>
    <div class="card"><div class="card-label">Valor Contratado</div><div class="card-value cv-blue">${fmt(tv)}</div></div>
    <div class="card"><div class="card-label">Lucro Recebido</div><div class="card-value cv-green">${fmt(lucroRecebidoD)}</div></div>`;
}

function renderE(){
  const rows=getSorted('empenhos').filter(r=>matches('empenhos',r));
  const tb=g('tbody-empenhos');
  if(!rows.length){ tb.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="icon">üìÑ</div><p>Nenhum empenho</p></div></td></tr>'; sumE(); verificarAlertas(); return; }
  tb.innerHTML=rows.map(r=>{
    const{luc}=eVals(r);
    const compras = r.compras || [];
    // Pago = tem pelo menos 1 compra e todas t√™m dpag preenchido
    const todoPago = empenhoEstaPago(r);
    const naoRecebido = !todoPago;
    const dias = diasSemPagamento(r);
    let rowClass = '', diasBadge = '';
    if (naoRecebido && dias > 0) {
      if (dias >= 90)      { rowClass = 'alerta-90'; diasBadge = '<span class="dias-badge dias-90">üî¥ '+dias+'d</span>'; }
      else if (dias >= 60) { rowClass = 'alerta-60'; diasBadge = '<span class="dias-badge dias-60">üü† '+dias+'d</span>'; }
      else if (dias >= 30) { rowClass = 'alerta-30'; diasBadge = '<span class="dias-badge dias-30">üü° '+dias+'d</span>'; }
      else                 { diasBadge = '<span class="dias-badge dias-ok">'+dias+'d</span>'; }
    } else if (!naoRecebido) {
      diasBadge = '<span class="dias-badge dias-ok">‚úì pago</span>';
    } else { diasBadge = '‚Äî'; }

    // Lote vinculado
    let loteInfo = '‚Äî';
    if (r.disputaId) {
      const disp = DB.disputas.find(d => d.id === r.disputaId);
      if (disp) {
        const lote = r.loteId ? (disp.lotes||[]).find(l => l.id === r.loteId) : null;
        loteInfo = '<span style="cursor:pointer;color:var(--accent-primary);font-size:11px;font-weight:600;" onclick="event.stopPropagation();abrirPopupDisputa(\''+disp.id+'\')">üîó '+(lote ? lote.descricao.substring(0,16)+(lote.descricao.length>16?'‚Ä¶':'') : disp.orgao.substring(0,14))+'</span>';
      }
    }

    const statusBadge = todoPago
      ? '<span class="badge bg" style="font-size:10px;">‚úì Pago</span>'
      : '<span class="badge by" style="font-size:10px;">Pendente</span>';

    return '<tr class="'+rowClass+'" style="cursor:pointer;" onclick="abrirPopupEmpenho(\'' + r.id + '\')">' +
      '<td onclick="event.stopPropagation()" style="text-align:center;"><input type="checkbox" class="chk-row-empenhos" data-id="' + r.id + '" onchange="onRowCheck(\'empenhos\')" style="cursor:pointer;width:15px;height:15px;"></td>' +
      '<td class="mono hi" style="font-size:11px;font-weight:600;">' + (r.num||'‚Äî') + '</td>' +
      '<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;">' + (r.orgao||'‚Äî') + '</td>' +
      '<td><span class="badge ' + (r.analista==='M√°rdea'?'bp':'bb') + '" style="font-size:10px;">' + (r.analista||'‚Äî') + '</span></td>' +
      '<td class="mono" style="color:var(--accent-primary);font-weight:700;">' + fmt(r.vem) + '</td>' +
      '<td>' + diasBadge + '</td>' +
      '<td>' + statusBadge + '</td>' +
      '<td onclick="event.stopPropagation()">' +
        '<button class="btn btn-ghost btn-sm" onclick="editE(\'' + r.id + '\')" title="Editar">‚úèÔ∏è</button>' +
        '<button class="btn btn-primary btn-sm" onclick="abrirCompra(\'' + r.id + '\')" title="Nova Compra" style="background:var(--success);border:none;">üõí</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="duplicarEmpenho(\'' + r.id + '\')" title="Duplicar">üìã</button>' +
        '<button class="btn btn-danger btn-sm" onclick="delRow(\'empenhos\',\'' + r.id + '\')" title="Excluir">üóë</button>' +
      '</td></tr>';
  }).join('');
  sumE();
  verificarAlertas();
}
function sumE(){
  const a=DB.empenhos.filter(r=>matches('empenhos',r));
  const te=a.reduce((s,r)=>s+r.vem,0);
  const totalComprado=a.reduce((s,r)=>s+(r.compras||[]).reduce((ss,c)=>ss+(c.vtotal||0),0),0);
  // Lucro recebido = compras com dpag preenchido, usando luc salvo na compra
  const lucroRecebido=a.reduce((s,r)=>s+(r.compras||[])
    .filter(c=>c.dpag && c.dpag !== '')
    .reduce((ss,c)=>{
      // luc pode estar salvo ou precisar ser recalculado
      const luc = (c.luc !== undefined && c.luc !== null) ? c.luc
        : (c.rec||0) - (c.vtotal||0) - (c.custo||0);
      return ss + luc;
    },0),0);
  g('sum-empenhos').innerHTML=
    '<div class="card"><div class="card-label">Empenhos</div><div class="card-value cv-blue">'+a.length+'</div></div>'+
    '<div class="card"><div class="card-label">Total Empenhado</div><div class="card-value">'+fmt(te)+'</div></div>'+
    '<div class="card"><div class="card-label">Total Comprado</div><div class="card-value cv-yellow">'+fmt(totalComprado)+'</div></div>'+
    '<div class="card"><div class="card-label">Lucro Recebido</div><div class="card-value cv-green">'+fmt(lucroRecebido)+'</div></div>';
}

function renderAll(){ 
  renderD(); 
  renderE(); 
  updateBadges(); 
  updateHeader(); 
}

function updateBadges(){ 
  const _finQtd = DB.disputas.filter(d=>d.finalizada).length;
  const _ativasQtd = DB.disputas.filter(d=>!d.finalizada).length;
  g('badge-disputas').textContent = _ativasQtd;
  g('badge-empenhos').textContent=DB.empenhos.length;
  const _badgeFin = g('badge-finalizadas'); if(_badgeFin) _badgeFin.textContent = _finQtd; 
}

function updateHeader(){ /* header stats removido */ }

function verificarAlertas() {
  const empenhosSemPagamento = DB.empenhos.filter(r => {
    const compras = r.compras || [];
    const todoPago = empenhoEstaPago(r);
    if (todoPago) return false;
    const dias = diasSemPagamento(r);
    return dias >= 60;
  });
  const banner = g('alerta-empenhos-banner');
  const txt = g('alerta-empenhos-txt');
  if (banner && txt) {
    if (empenhosSemPagamento.length > 0) {
      banner.style.display = 'flex';
      txt.textContent = `${empenhosSemPagamento.length} empenho${empenhosSemPagamento.length>1?'s':''} h√° mais de 60 dias sem recebimento`;
    } else {
      banner.style.display = 'none';
    }
  }
}

function filtrarAtraso60() {
  const sel = g('filtro-atraso-empenhos');
  if (sel) sel.value = '60';
  filtrarEmpenhos();
  switchTab('empenhos', document.querySelectorAll('.tab-btn')[2]);
}

function verExcel(id, tipo) {
  const arr = tipo === 'e' ? DB.empenhos : DB.disputas;
  const r = arr.find(x => x.id === id);
  if (!r || !r.excel) return;
  const d = r.excel;
  const rows = (d.data || []).slice(0, 20);
  const html = `<div style="max-height:400px;overflow:auto;"><table style="font-size:11px;border-collapse:collapse;width:100%">
    ${rows.map((row, i) => `<tr>${row.map(c => i===0 ? `<th style="background:var(--bg-surface-soft);padding:4px 8px;border:1px solid var(--border-light);font-weight:600;">${c}</th>` : `<td style="padding:3px 8px;border:1px solid var(--border-light);">${c}</td>`).join('')}</tr>`).join('')}
  </table></div>`;
  const w = window.open('', '_blank', 'width=900,height=500');
  w.document.write(`<html><head><title>${d.filename}</title><style>body{font-family:sans-serif;padding:16px;background:#f8f9fa;}h3{margin-bottom:12px;}</style></head><body><h3>üìä ${d.filename}</h3>${html}
<!-- POPUP DETALHES DISPUTA -->
<div class="detail-popup-overlay" id="popup-disputa">
  <div class="detail-popup">
    <div class="detail-popup-header">
      <div>
        <div class="detail-popup-title" id="popup-d-title">Detalhes da Disputa</div>
        <div class="detail-popup-sub" id="popup-d-sub"></div>
      </div>
      <button class="detail-close" onclick="fecharPopup('disputa')">‚úï</button>
    </div>
    <div id="popup-d-body"></div>
    <div class="detail-actions">
      <button class="btn btn-ghost" onclick="fecharPopup('disputa')">Fechar</button>
      <button class="btn btn-success" id="popup-d-new-emp-btn" style="background:var(--success);color:#fff;border:none;">Ôºã Novo Empenho</button>
      <button class="btn btn-primary" id="popup-d-edit-btn">‚úèÔ∏è Editar</button>
    </div>
  </div>
</div>

<!-- POPUP DETALHES EMPENHO -->
<div class="detail-popup-overlay" id="popup-empenho">
  <div class="detail-popup">
    <div class="detail-popup-header">
      <div>
        <div class="detail-popup-title" id="popup-e-title">Detalhes do Empenho</div>
        <div class="detail-popup-sub" id="popup-e-sub"></div>
      </div>
      <button class="detail-close" onclick="fecharPopup('empenho')">‚úï</button>
    </div>
    <div id="popup-e-body"></div>
    <div class="detail-actions">
      <button class="btn btn-ghost" onclick="fecharPopup('empenho')">Fechar</button>
      <button class="btn btn-primary" id="popup-e-edit-btn">‚úèÔ∏è Editar</button>
    </div>
  </div>
</div>
</body></html>`);
}

// ========== DASHBOARD COMPLETO ==========
function atualizarDashboard() {
  const disputasFiltradas = DB.disputas.filter(r => filtroAnalista === 'todos' || r.analista === filtroAnalista);
  const empenhosFiltrados = DB.empenhos.filter(r => filtroAnalista === 'todos' || r.analista === filtroAnalista);
  const hoje = new Date();
  const mesAtual = hoje.toISOString().substring(0,7);
  const mesAnterior = new Date(hoje.getFullYear(), hoje.getMonth()-1, 1).toISOString().substring(0,7);

  // KPIs
  const totalRecebido = empenhosFiltrados.reduce((s,r)=>s+(r.recebido||0), 0);
  const totalLucroDisputas = disputasFiltradas.reduce((s,r)=>s+dVals(r).luc, 0);
  const totalLucroEmpenhos = empenhosFiltrados.reduce((s,r)=>s+eVals(r).luc, 0);
  const totalLucro = totalLucroDisputas + totalLucroEmpenhos;
  const totalEmpenhadoVal = empenhosFiltrados.reduce((s,r)=>s+r.vem, 0);
  const aReceber = totalEmpenhadoVal - totalRecebido;
  const emAtraso = empenhosFiltrados.filter(r=>!r.recebido&&diasSemPagamento(r)>=60).length;

  // Taxa de convers√£o
  const disputasComEmpenho = disputasFiltradas.filter(d => DB.empenhos.some(e=>e.disputaId===d.id)).length;
  const taxaConv = disputasFiltradas.length ? Math.round(disputasComEmpenho/disputasFiltradas.length*100) : 0;

  const setKpi = (id, val) => { const el = g(id); if(el) el.textContent = val; };
  setKpi('dk-disputas', disputasFiltradas.length);
  setKpi('dk-empenhos', empenhosFiltrados.length);
  setKpi('dk-recebido', fmt(totalRecebido));
  setKpi('dk-lucro', fmt(totalLucro));
  setKpi('dk-conversao', taxaConv + '%');
  setKpi('dk-areceber', fmt(aReceber));
  const atrasoEl = g('dk-atraso');
  if(atrasoEl) atrasoEl.textContent = emAtraso > 0 ? `‚ö†Ô∏è ${emAtraso} em atraso >60d` : '‚úì em dia';

  // Gr√°fico 1: Recebido + Lucro por M√™s
  const porMes = {};
  empenhosFiltrados.forEach(e => {
    const m = (e.dreceb||e.data||'').substring(0,7);
    if(!m) return;
    if(!porMes[m]) porMes[m] = { rec: 0, luc: 0 };
    porMes[m].rec += e.recebido||0;
    porMes[m].luc += eVals(e).luc;
  });
  const meses = Object.keys(porMes).sort().slice(-12);
  if(graficos.lucroMensal) graficos.lucroMensal.destroy();
  const ctx1 = document.getElementById('grafico-lucro-mensal')?.getContext('2d');
  if(ctx1) graficos.lucroMensal = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: meses.map(m => m.substring(5)+'/'+m.substring(2,4)),
      datasets: [
        { label: 'Recebido', data: meses.map(m=>porMes[m].rec), backgroundColor: 'rgba(37,99,235,0.7)', borderRadius: 4 },
        { label: 'Lucro', data: meses.map(m=>porMes[m].luc), backgroundColor: 'rgba(16,185,129,0.7)', borderRadius: 4 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels:{font:{size:10}} } }, scales: { y: { ticks: { callback: v => 'R$'+v.toLocaleString('pt-BR') } } } }
  });

  // Gr√°fico 2: Situa√ß√µes
  const situacoes = {};
  disputasFiltradas.forEach(d => { situacoes[d.situacao] = (situacoes[d.situacao]||0)+1; });
  if(graficos.situacoes) graficos.situacoes.destroy();
  const ctx2 = document.getElementById('grafico-situacoes')?.getContext('2d');
  const cores = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899'];
  if(ctx2) graficos.situacoes = new Chart(ctx2, {
    type: 'doughnut',
    data: { labels: Object.keys(situacoes), datasets: [{ data: Object.values(situacoes), backgroundColor: cores, borderWidth: 2, borderColor: 'var(--bg-surface)' }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{font:{size:10}, boxWidth:12} } } }
  });

  // Gr√°fico 3: Top 5 √≥rg√£os por lucro
  const orgaos = {};
  empenhosFiltrados.forEach(e => { orgaos[e.orgao] = (orgaos[e.orgao]||0) + eVals(e).luc; });
  const top5 = Object.entries(orgaos).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(graficos.orgaos) graficos.orgaos.destroy();
  const ctx3 = document.getElementById('grafico-orgaos')?.getContext('2d');
  if(ctx3) graficos.orgaos = new Chart(ctx3, {
    type: 'bar',
    data: { labels: top5.map(o=>o[0].substring(0,14)), datasets: [{ data: top5.map(o=>o[1]), backgroundColor: cores, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend:{display:false} }, scales: { x: { ticks: { callback: v => 'R$'+v.toLocaleString('pt-BR') } } } }
  });

  // Gr√°fico 4: Performance por analista
  const analistas = {};
  empenhosFiltrados.forEach(e => { analistas[e.analista] = (analistas[e.analista]||0) + eVals(e).luc; });
  if(graficos.analistas) graficos.analistas.destroy();
  const ctx4 = document.getElementById('grafico-analistas')?.getContext('2d');
  if(ctx4) graficos.analistas = new Chart(ctx4, {
    type: 'pie',
    data: { labels: Object.keys(analistas), datasets: [{ data: Object.values(analistas), backgroundColor: ['#2563eb','#10b981','#f59e0b','#8b5cf6'], borderWidth: 2, borderColor: 'var(--bg-surface)' }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{font:{size:10}} } } }
  });

  // Gr√°fico 5: Velocidade de pagamento (dias m√©dios por √≥rg√£o)
  const velOrgao = {};
  empenhosFiltrados.filter(e=>e.recebido>0&&e.dcomp&&e.dreceb).forEach(e => {
    const dias = Math.floor((new Date(e.dreceb)-new Date(e.dcomp))/86400000);
    if(!velOrgao[e.orgao]) velOrgao[e.orgao] = [];
    velOrgao[e.orgao].push(dias);
  });
  const velMedia = Object.entries(velOrgao).map(([o,ds])=>([o, Math.round(ds.reduce((a,b)=>a+b,0)/ds.length)])).sort((a,b)=>a[1]-b[1]).slice(0,6);
  if(graficos.velocidade) graficos.velocidade.destroy();
  const ctx5 = document.getElementById('grafico-velocidade')?.getContext('2d');
  if(ctx5) graficos.velocidade = new Chart(ctx5, {
    type: 'bar',
    data: { labels: velMedia.map(v=>v[0].substring(0,12)), datasets: [{ label: 'Dias m√©dios', data: velMedia.map(v=>v[1]), backgroundColor: velMedia.map(v=>v[1]<=30?'#10b981':v[1]<=60?'#f59e0b':'#ef4444'), borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{ y:{title:{display:true,text:'dias'}} } }
  });

  // Gr√°fico 6: Comparativo m√™s atual vs anterior
  const rec = (m) => empenhosFiltrados.filter(e=>((e.dreceb||'').substring(0,7))===m).reduce((s,e)=>s+(e.recebido||0),0);
  const luc = (m) => empenhosFiltrados.filter(e=>((e.dreceb||e.data||'').substring(0,7))===m).reduce((s,e)=>s+eVals(e).luc,0);
  if(graficos.comparativo) graficos.comparativo.destroy();
  const ctx6 = document.getElementById('grafico-comparativo')?.getContext('2d');
  const lblMesAt = mesAtual.substring(5)+'/'+mesAtual.substring(2,4);
  const lblMesAnt = mesAnterior.substring(5)+'/'+mesAnterior.substring(2,4);
  if(ctx6) graficos.comparativo = new Chart(ctx6, {
    type: 'bar',
    data: {
      labels: ['Recebido', 'Lucro'],
      datasets: [
        { label: lblMesAnt, data: [rec(mesAnterior), luc(mesAnterior)], backgroundColor: 'rgba(37,99,235,0.4)', borderRadius: 4 },
        { label: lblMesAt, data: [rec(mesAtual), luc(mesAtual)], backgroundColor: 'rgba(16,185,129,0.8)', borderRadius: 4 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{position:'top',labels:{font:{size:10}}}}, scales:{y:{ticks:{callback:v=>'R$'+v.toLocaleString('pt-BR')}}} }
  });
}

let disputaAtiva = null;

function verEmpenhosDisputa(disputaId) {
  const disp = DB.disputas.find(d => d.id === disputaId);
  if(!disp) return;
  
  disputaAtiva = disputaId;
  
  // Banner de info da disputa
  const {luc, pct} = dVals(disp);
  g('disp-info-banner').innerHTML = `
    <span>üè¢ √ìrg√£o:<strong>${disp.orgao||'‚Äî'}</strong></span>
    <span>üìã Processo:<strong>${disp.processo||'‚Äî'}</strong></span>
    <span>üè∑Ô∏è Situa√ß√£o:<strong>${disp.situacao||'‚Äî'}</strong></span>
    <span>üí∞ Prev.Lucro:<strong style="color:var(--success)">${fmt(luc)}</strong></span>
    <span>üìÖ Data:<strong>${fmtD(disp.data)}</strong></span>
  `;
  
  g('ttl-empenhos-disputa').textContent = `üìÑ Empenhos ¬∑ ${disp.orgao||'?'}`;
  
  const emps = DB.empenhos.filter(e => e.disputaId === disputaId);
  g('disp-emp-count').textContent = `${emps.length} empenho(s) vinculado(s)`;
  
  if(!emps.length) {
    g('disp-emp-body').innerHTML = '<div class="emp-disp-empty">Nenhum empenho vinculado a esta disputa.<br><small>Clique em "Ôºã Novo Empenho Vinculado" para adicionar.</small></div>';
    g('disp-emp-totais').innerHTML = '';
  } else {
    g('disp-emp-body').innerHTML = `
      <table class="emp-disp-table">
        <thead><tr>
          <th>N¬∫ Empenho</th>
          <th>Data</th>
          <th>Produto</th>
          <th>Val. Empenho</th>
          <th>Compra Total</th>
          <th>Lucro</th>
          <th>%</th>
          <th>A Receber</th>
          <th>Recebido</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr></thead>
        <tbody>
        ${emps.map(e => {
          const v = eVals(e);
          const pago = e.recebido > 0;
          return `<tr class="${pago?'pago':''}">
            <td class="mono" style="font-weight:600;">${e.num||'‚Äî'}</td>
            <td class="mono">${fmtD(e.data)}</td>
            <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;" title="${e.produto||''}">${e.produto||'‚Äî'}</td>
            <td class="mono" style="color:var(--accent-primary)">${fmt(e.vem)}</td>
            <td class="mono">${fmt(v.tot)}</td>
            <td class="mono" style="color:${v.luc>=0?'var(--success)':'var(--danger)'}">${fmt(v.luc)}</td>
            <td class="mono">${fmtP(v.pct)}</td>
            <td class="mono">${fmt(v.rec)}</td>
            <td class="mono" style="color:var(--success)">${e.recebido>0?fmt(e.recebido):'‚Äî'}</td>
            <td><span class="${pago?'status-pago':'status-pendente'}">${pago?'‚úÖ Pago':'‚è≥ Pendente'}</span></td>
            <td>
              <button class="btn btn-ghost btn-sm" onclick="closeModal('empenhos-disputa');editE('${e.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-danger btn-sm" onclick="delEmpenhoDisputa('${e.id}')" title="Excluir">üóë</button>
            </td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>`;
    
    // Totais
    const totalVem = emps.reduce((s,e) => s + e.vem, 0);
    const totalRec = emps.reduce((s,e) => s + (e.recebido||0), 0);
    const totalLuc = emps.reduce((s,e) => s + eVals(e).luc, 0);
    const aReceber = emps.filter(e => !e.recebido || e.recebido===0).reduce((s,e) => s + eVals(e).rec, 0);
    g('disp-emp-totais').innerHTML = `
      <div><div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;">Total Empenhado</div><div style="font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent-primary)">${fmt(totalVem)}</div></div>
      <div><div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;">Lucro Total</div><div style="font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--success)">${fmt(totalLuc)}</div></div>
      <div><div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;">Recebido</div><div style="font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--success)">${fmt(totalRec)}</div></div>
      <div><div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;">A Receber</div><div style="font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--warning)">${fmt(aReceber)}</div></div>
    `;
  }
  
  g('modal-empenhos-disputa').classList.add('open');
}

function delEmpenhoDisputa(id) {
  DB.empenhos = DB.empenhos.filter(r => r.id !== id);
  save('empenhos', DB.empenhos);
  toast('Empenho exclu√≠do', 'info');
  renderAll();
  if(disputaAtiva) verEmpenhosDisputa(disputaAtiva);
}

function novoEmpenhoDaDisputa() {
  closeModal('empenhos-disputa');
  openModal('empenhos');
  // Pr√©-seleciona a disputa no select
  setTimeout(() => {
    if(disputaAtiva) {
      populateDisputaSelect(disputaAtiva);
    }
  }, 50);
}

function populateDisputaSelect(preSelectId) {
  const sel = g('e-disputa-id');
  if(!sel) return;
  sel.innerHTML = '<option value="">‚Äî Selecione o √≥rg√£o ‚Äî</option>';

  // S√≥ lista disputas com saldo (ou a pr√©-selecionada em modo edi√ß√£o)
  const comSaldo = DB.disputas
    .map(d => {
      const lotes = d.lotes || [];
      const saldoTotal = lotes.reduce((s, l) => s + Math.max(0, (l.qtd||0) - calcQtdEnviada(d.id, l.id)), 0);
      return { d, saldoTotal };
    })
    .filter(x => x.saldoTotal > 0 || x.d.id === preSelectId)
    .sort((a, b) => a.d.orgao.localeCompare(b.d.orgao));

  if (comSaldo.length === 0) {
    const opt = document.createElement('option');
    opt.disabled = true;
    opt.textContent = '‚Äî Nenhuma disputa com saldo dispon√≠vel ‚Äî';
    sel.appendChild(opt);
  }

  comSaldo.forEach(({ d, saldoTotal }) => {
    const opt = document.createElement('option');
    opt.value = d.id;
    const editando = d.id === preSelectId && saldoTotal === 0;
    opt.textContent = `${d.orgao}${d.estado ? ' ¬∑ ' + d.estado : ''} ¬∑ ${fmtD(d.data)} ¬∑ ${editando ? '(editando)' : saldoTotal + ' un. restantes'}`;
    if (d.id === preSelectId) opt.selected = true;
    sel.appendChild(opt);
  });

  if (preSelectId) onDisputaSelecionada(preSelectId);
}

// ========== MODAL ==========
let EID={};
function openModal(tab){
  EID[tab]=null;
  if(tab==='disputas'){
    clearD();
    lotesTemp = []; renderLotes();
    g('ttl-disputas').textContent='Nova Disputa Vencida'; g('d-data').value=today();
  } else if(tab==='empenhos') {
    clearE();
    lotesSelecionados = {};
    const wrap = g('lote-selector-wrap'); if(wrap) wrap.style.display = 'none';
    g('ttl-empenhos').textContent='Novo Empenho'; g('e-data').value=today(); populateDisputaSelect(null);
  }
  if(tab!=='empenhos-disputa') g('modal-'+tab).classList.add('open');
}
function closeModal(tab){ g('modal-'+tab).classList.remove('open'); }
const today=()=>new Date().toISOString().slice(0,10);

function novoEmpenhoParaDisputa(disputaId) {
  fecharPopup('disputa');
  EID['empenhos'] = null;
  clearE();
  lotesSelecionados = {};
  const wrap = g('lote-selector-wrap'); if(wrap) wrap.style.display = 'none';
  g('ttl-empenhos').textContent = 'Novo Empenho';
  g('e-data').value = today();
  populateDisputaSelect(disputaId);
  g('modal-empenhos').classList.add('open');
}

// ========== WIZARD R√ÅPIDO ==========
let wizardStep = 1;
let wizardData = {};

function openQuickWizard(tipo) {
  wizardStep = 1;
  wizardData = { tipo };
  g('wizard-tipo').value = tipo;
  atualizarWizard();
  g('wizard-quick').classList.add('open');
}

function closeWizard() {
  g('wizard-quick').classList.remove('open');
}

function atualizarWizard() {
  g('wizard-step-1').style.display = wizardStep === 1 ? 'block' : 'none';
  g('wizard-step-2').style.display = wizardStep === 2 ? 'block' : 'none';
  g('wizard-step-3').style.display = wizardStep === 3 ? 'block' : 'none';
  
  g('wiz-step1').className = wizardStep >= 1 ? 'step active' : 'step';
  g('wiz-step2').className = wizardStep >= 2 ? 'step active' : 'step';
  g('wiz-step3').className = wizardStep >= 3 ? 'step active' : 'step';
  
  g('wizard-next').style.display = wizardStep < 3 ? 'inline-flex' : 'none';
  g('wizard-finish').style.display = wizardStep === 3 ? 'inline-flex' : 'none';
}

function wizardNext() {
  if(wizardStep === 1) {
    wizardData.tipo = g('wizard-tipo').value;
  } else if(wizardStep === 2) {
    wizardData.orgao = g('wizard-orgao').value;
  }
  wizardStep++;
  atualizarWizard();
}

function wizardFinish() {
  wizardData.processo = g('wizard-processo').value;
  
  // Criar registro r√°pido
  if(wizardData.tipo === 'disputas') {
    const novaDisputa = {
      id: uid(),
      data: today(),
      orgao: wizardData.orgao || '',
      estado: '',
      empresa: '',
      tipo: '',
      rp: '',
      processo: wizardData.processo || '',
      sistema: '',
      analista: '',
      linkSistema: '',
      linkProposta: '',
      compra: 0,
      venda: 0,
      aliq: 0.145,
      situacao: 'Em recurso',
      observacao: '',
      M: {}
    };
    DB.disputas.push(novaDisputa);
    save('disputas', DB.disputas);
    toast('Disputa criada com sucesso!', 'success');
  } else {
    const novoEmpenho = {
      id: uid(),
      num: wizardData.processo || '',
      data: today(),
      orgao: wizardData.orgao || '',
      analista: 'M√°rdea',
      produto: '',
      plataforma: '',
      dcomp: today(),
      vunit: 0,
      qtd: 1,
      vem: 0,
      aliq: 0.13,
      recebido: 0,
      dreceb: '',
      observacao: '',
      M: {}
    };
    DB.empenhos.push(novoEmpenho);
    save('empenhos', DB.empenhos);
    toast('Empenho criado com sucesso!', 'success');
  }
  
  closeWizard();
  renderAll();
}

function mudarTema() { /* removido */ }

// ========== ATALHOS DE TECLADO ==========
document.addEventListener('keydown', (e) => {
  // Ctrl+N = Nova disputa/empenho (dependendo da aba ativa)
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    const activeTab = document.querySelector('.tab-btn.active');
    if(activeTab.textContent.includes('Disputas')) {
      openModal('disputas');
    } else if(activeTab.textContent.includes('Empenhos')) {
      openModal('empenhos');
    }
  }
  
  // Ctrl+K = Focar na busca
  if (e.ctrlKey && e.key === 'k') {
    e.preventDefault();
    const activeTab = document.querySelector('.tab-pane.active');
    if(activeTab.id === 'tab-disputas') {
      g('search-disputas').focus();
    } else if(activeTab.id === 'tab-empenhos') {
      g('search-empenhos').focus();
    }
  }
  
  // Ctrl+Q = Abrir wizard r√°pido
  if (e.ctrlKey && e.key === 'q') {
    e.preventDefault();
    const activeTab = document.querySelector('.tab-btn.active');
    if(activeTab.textContent.includes('Disputas')) {
      openQuickWizard('disputas');
    } else if(activeTab.textContent.includes('Empenhos')) {
      openQuickWizard('empenhos');
    }
  }
  
  // Esc = Fechar modais
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.open, .wizard-overlay.open').forEach(el => {
      el.classList.remove('open');
    });
  }
});

// ========== DISPUTAS ==========
function clearD(){
  resetFields('d');
  ['d-data','d-orgao','d-estado','d-empresa','d-tipo','d-processo','d-sistema','d-analista','d-observacao'].forEach(id=>{const e=g(id);if(e)e.value='';});
  g('d-empresa').value='Hamate'; g('d-tipo').value='Preg√£o Eletr√¥nico'; g('d-rp').value='N√ÉO'; g('d-sistema').value='Licitanet'; g('d-analista').value='M√°rdea';
  calcD();
}
function saveD(){
  // Valida√ß√£o: lotes obrigat√≥rios
  const lotesValidos = lotesTemp.filter(l => l.descricao && l.vunit > 0);
  if (!lotesValidos.length) {
    const aviso = g('lotes-aviso');
    if (aviso) { aviso.style.display = 'block'; aviso.scrollIntoView({behavior:'smooth',block:'center'}); }
    toast('Adicione pelo menos 1 item/lote com descri√ß√£o e valor', 'error');
    return;
  }
  const M={};
  // Calcula valor do contrato a partir dos lotes
  const valorContrato = lotesValidos.reduce((s,l)=>s+(l.qtd||1)*(l.vunit||0),0);
  const row={
    id: EID.disputas||uid(),
    data: gv('d-data'),
    orgao: gv('d-orgao').toUpperCase(),
    estado: gv('d-estado'),
    empresa: gv('d-empresa'),
    tipo: gv('d-tipo'),
    rp: gv('d-rp'),
    processo: gv('d-processo').toUpperCase(),
    sistema: gv('d-sistema'),
    analista: gv('d-analista'),
    linkSistema: '',
    linkProposta: '',
    compra: 0,
    venda: valorContrato, // sempre = soma dos lotes
    aliq: 0,
    situacao: '',
    observacao: gv('d-observacao').toUpperCase(),
    lotes: lotesValidos.map(l => ({ id: l.id || uid(), descricao: (l.descricao||'').toUpperCase(), qtd: l.qtd||1, vunit: l.vunit||0 })),
    M
  };
  upsert('disputas',row);
  toast(EID.disputas?'Disputa atualizada':'Disputa salva','success');
  closeModal('disputas'); renderAll();
}
function editD(id){
  const r=DB.disputas.find(x=>x.id===id); if(!r) return;
  EID.disputas=id; clearD();
  g('d-data').value=r.data||''; g('d-orgao').value=r.orgao||''; g('d-estado').value=r.estado||'';
  g('d-empresa').value=r.empresa||''; g('d-tipo').value=r.tipo||''; g('d-rp').value=r.rp||'';
  g('d-processo').value=r.processo||''; g('d-sistema').value=r.sistema||''; g('d-analista').value=r.analista||'';

  g('d-observacao').value=r.observacao||'';

  // Carrega lotes (garante que todos tenham ID)
  lotesTemp = (r.lotes || []).map(l => ({ id: l.id || uid(), descricao: l.descricao||'', qtd: l.qtd||1, vunit: l.vunit||0 }));
  renderLotes();
  calcD();
  syncMasterCheckbox('d');
  g('ttl-disputas').textContent='Editar Disputa'; g('modal-disputas').classList.add('open');
}

// ========== EMPENHOS ==========
function clearE(){
  resetFields('e');
  vemManual = false;
  const aiVem = g('e-vem-a'); const miVem = g('e-vem');
  if(aiVem) { aiVem.style.display='block'; aiVem.value=''; }
  if(miVem) { miVem.style.display='none'; miVem.value=''; }
  const btnVem = g('tbtn-e-vem'); if(btnVem){ btnVem.classList.remove('on'); btnVem.innerHTML='<span class="dot"></span>Auto'; }
  ['e-num','e-data','e-analista','e-dcomp','e-vunit','e-qtd','e-vem','e-recebido','e-dreceb','e-tot-m','e-imp-m','e-luc-m','e-pct-m','e-rec-m','e-observacao'].forEach(id=>{const e=g(id);if(e)e.value='';});
  g('e-aliq').value='13'; g('e-qtd').value='1'; 
  calcE();
}
function saveE(){
  const disputaId = gv('e-disputa-id');
  if (!disputaId) {
    toast('SELECIONE A DISPUTA VINCULADA (OBRIGAT√ìRIO)', 'error');
    g('e-disputa-id').focus();
    return;
  }
  // Pega todos os lotes selecionados
  const lotesKeys = Object.keys(lotesSelecionados);
  const disp = DB.disputas.find(d => d.id === disputaId);
  if (disp && (disp.lotes||[]).length > 0 && !lotesKeys.length) {
    const aviso = g('lote-aviso');
    if (aviso) { aviso.style.display = 'block'; }
    toast('SELECIONE PELO MENOS UM ITEM/LOTE DO EMPENHO', 'error');
    return;
  }
  
  // Monta itens do empenho
  const itens = lotesKeys.map(loteId => {
    const qtd = lotesSelecionados[loteId] || 1;
    const lote = disp ? (disp.lotes||[]).find(l=>l.id===loteId) : null;
    return {
      id: uid(),
      loteId: loteId,
      descricao: lote ? lote.descricao : '',
      qtd: qtd,
      vunit: lote ? lote.vunit : 0
    };
  });
  
  const M={};
  if(MS.e.tot) M.tot=gn('e-tot-m');
  if(MS.e.imp) M.imp=gn('e-imp-m');
  if(MS.e.luc) M.luc=gn('e-luc-m');
  if(MS.e.pct) M.pct=gn('e-pct-m');
  if(MS.e.rec) M.rec=gn('e-rec-m');
  
  // vem: auto-calculado ou manual
  const vemVal = vemManual ? gn('e-vem') : (itens.reduce((s,i)=>s+(i.qtd||0)*(i.vunit||0),0));
  
  // Compatibilidade retroativa: loteId e qtdLote para empenhos com 1 lote
  const primeiroItem = itens[0] || null;
  
  const row={
    id: EID.empenhos||uid(),
    num: gv('e-num').toUpperCase(),
    data: gv('e-data'),
    orgao: disp ? disp.orgao : '',
    analista: gv('e-analista'),
    produto: itens.map(i=>i.descricao).join(' / ') || '',
    plataforma: '',
    dcomp: gv('e-dcomp'),
    vunit: primeiroItem ? primeiroItem.vunit : 0,
    qtd: primeiroItem ? primeiroItem.qtd : 1,
    qtdLote: primeiroItem ? primeiroItem.qtd : null,
    loteId: primeiroItem ? primeiroItem.loteId : null,
    itens: itens, // NOVO: array de itens
    vem: vemVal,
    aliq: parseAliq(gv('e-aliq')),
    recebido: gn('e-recebido'),
    dreceb: gv('e-dreceb'),
    observacao: gv('e-observacao').toUpperCase(),
    disputaId: disputaId,
    compras: (EID.empenhos ? (DB.empenhos.find(x=>x.id===EID.empenhos)?.compras || []) : []), // preserva compras
    M
  };
  upsert('empenhos',row);
  const _isNew = !EID.empenhos;
  toast(_isNew ? 'EMPENHO SALVO' : 'EMPENHO ATUALIZADO', 'success');
  closeModal('empenhos');
  renderAll();
  // Ap√≥s salvar, abre o popup de detalhe do empenho
  setTimeout(() => abrirPopupEmpenho(row.id), 150);
}
function editE(id){
  const r=DB.empenhos.find(x=>x.id===id); if(!r) return;
  EID.empenhos=id; clearE();
  g('e-num').value=r.num||''; g('e-data').value=r.data||'';
  g('e-analista').value=r.analista||'M√°rdea'; 
  g('e-observacao').value=r.observacao||'';
  g('e-dcomp').value=r.dcomp||''; 
  g('e-aliq').value= (r.aliq*100).toFixed(1).replace('.',',');
  g('e-recebido').value=r.recebido||''; g('e-dreceb').value=r.dreceb||''; 
  
  // vemManual
  vemManual = false;
  const aiVem = g('e-vem-a'); const miVem = g('e-vem');
  if(aiVem) aiVem.style.display = 'block';
  if(miVem) { miVem.style.display = 'none'; miVem.value = r.vem||''; }
  const btnVem = g('tbtn-e-vem'); if(btnVem){ btnVem.classList.remove('on'); btnVem.innerHTML='<span class="dot"></span>Auto'; }
  
  // Restaura sele√ß√£o de lotes
  lotesSelecionados = {};
  populateDisputaSelect(r.disputaId || null);
  if (r.disputaId) {
    setTimeout(() => {
      // Suporte a m√∫ltiplos itens
      if(r.itens && r.itens.length > 0) {
        r.itens.forEach(item => {
          const lotes = getLotesComSaldo(r.disputaId, r.id);
          const lote = lotes.find(l=>l.id===item.loteId);
          if(lote) {
            const saldoMaisEste = lote.qtdRestante + item.qtd;
            lotesSelecionados[item.loteId] = item.qtd;
            const card = g('lcard-'+item.loteId);
            if(card) { card.classList.add('selected'); const chk=card.querySelector('input[type=checkbox]'); if(chk) chk.checked=true; }
            const qtdWrap = g('lqtd-wrap-'+item.loteId); if(qtdWrap) qtdWrap.style.display = 'flex';
            const input = g('lqtd-'+item.loteId); if(input) { input.value = item.qtd; input.max = saldoMaisEste; }
            const valEl = g('lval-'+item.loteId); if(valEl) valEl.textContent = fmt(item.qtd*(lote.vunit||0));
          }
        });
      } else if (r.loteId) {
        // compatibilidade com formato antigo (1 lote)
        const lotes = getLotesComSaldo(r.disputaId, r.id);
        const lote = lotes.find(l => l.id === r.loteId);
        if (lote) {
          const saldoMaisEste = lote.qtdRestante + (r.qtdLote || 0);
          lotesSelecionados[r.loteId] = r.qtdLote || 1;
          const card = g('lcard-'+r.loteId);
          if(card) { card.classList.add('selected'); const chk=card.querySelector('input[type=checkbox]'); if(chk) chk.checked=true; }
          const qtdWrap = g('lqtd-wrap-'+r.loteId); if(qtdWrap) qtdWrap.style.display = 'flex';
          const input = g('lqtd-'+r.loteId); if(input) { input.value = r.qtdLote||1; input.max = saldoMaisEste; }
        }
      }
      atualizarVemTotal();
    }, 50);
  }
  const M=r.M||{};
  if(M.tot!==undefined){ g('e-tot-m').value=M.tot; setField('e','tot',true); }
  if(M.imp!==undefined){ g('e-imp-m').value=M.imp; setField('e','imp',true); }
  if(M.luc!==undefined){ g('e-luc-m').value=M.luc; setField('e','luc',true); }
  if(M.pct!==undefined){ g('e-pct-m').value=M.pct; setField('e','pct',true); }
  if(M.rec!==undefined){ g('e-rec-m').value=M.rec; setField('e','rec',true); }
  calcE();
  syncMasterCheckbox('e');
  g('ttl-empenhos').textContent='EDITAR EMPENHO'; g('modal-empenhos').classList.add('open');
}

// ========== CRUD ==========
function upsert(tab,row){ const idx=DB[tab].findIndex(r=>r.id===row.id); if(idx!==-1) DB[tab][idx]=row; else DB[tab].push(row); save(tab,DB[tab]); }
let PDel=null;
function delRow(tab,id){
  PDel={tab,id};
  let msg = 'Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.';
  if(tab === 'disputas') {
    const disp = DB.disputas.find(r=>r.id===id);
    const empsVinculados = DB.empenhos.filter(e=>e.disputaId===id);
    const totalCompras = empsVinculados.reduce((s,e)=>s+(e.compras||[]).length,0);
    const nome = disp ? disp.orgao : 'esta disputa';
    if(empsVinculados.length > 0) {
      msg = `‚ö†Ô∏è Ao excluir a disputa <strong>${nome}</strong>, ser√£o exclu√≠dos tamb√©m:<br><br>`
          + `‚Ä¢ <strong>${empsVinculados.length} empenho(s)</strong> vinculado(s)<br>`
          + (totalCompras > 0 ? `‚Ä¢ <strong>${totalCompras} compra(s)</strong> registrada(s)<br>` : '')
          + `<br>Esta a√ß√£o n√£o pode ser desfeita.`;
    } else {
      msg = `Tem certeza que deseja excluir a disputa <strong>${nome}</strong>? Esta a√ß√£o n√£o pode ser desfeita.`;
    }
  }
  const el = g('confirm-msg'); if(el) el.innerHTML = msg;
  g('modal-confirm').classList.add('open');
}
function closeConfirm(){ PDel=null; g('modal-confirm').classList.remove('open'); }
function confirmDel(){
  if(!PDel) return;
  if(PDel.tab === 'disputas') {
    // Exclui em cascata: empenhos e compras vinculados
    DB.empenhos = DB.empenhos.filter(e => e.disputaId !== PDel.id);
    save('empenhos', DB.empenhos);
  }
  DB[PDel.tab] = DB[PDel.tab].filter(r=>r.id!==PDel.id);
  save(PDel.tab, DB[PDel.tab]);
  closeConfirm();
  renderAll();
  toast('Exclu√≠do com sucesso','info');
}

// ========== EXCLUS√ÉO EM LOTE ==========
function toggleSelectAll(tab, checked) {
  document.querySelectorAll('.chk-row-' + tab).forEach(chk => { chk.checked = checked; });
  atualizarBotaoLote(tab);
}
function onRowCheck(tab) {
  const all = document.querySelectorAll('.chk-row-' + tab);
  const checked = document.querySelectorAll('.chk-row-' + tab + ':checked');
  const chkAll = g('chk-all-' + tab);
  if (chkAll) { chkAll.checked = all.length > 0 && checked.length === all.length; chkAll.indeterminate = checked.length > 0 && checked.length < all.length; }
  atualizarBotaoLote(tab);
}
function atualizarBotaoLote(tab) {
  const cnt = document.querySelectorAll('.chk-row-' + tab + ':checked').length;
  const btn = g('btn-del-lote-' + tab);
  const span = g('cnt-sel-' + tab);
  if (btn) btn.style.display = cnt > 0 ? '' : 'none';
  if (span) span.textContent = cnt;
}
function deletarSelecionados(tab) {
  const ids = Array.from(document.querySelectorAll('.chk-row-' + tab + ':checked')).map(c => c.dataset.id);
  if (!ids.length) return;
  if (!confirm('Excluir ' + ids.length + ' registro(s) selecionado(s)? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  if (tab === 'disputas') {
    // Cascata: remove empenhos (e compras dentro deles) vinculados √†s disputas exclu√≠das
    DB.empenhos = DB.empenhos.filter(e => !ids.includes(e.disputaId));
    save('empenhos', DB.empenhos);
  }
  DB[tab] = DB[tab].filter(r => !ids.includes(r.id));
  save(tab, DB[tab]);
  renderAll();
  const chkAll = g('chk-all-' + tab);
  if (chkAll) { chkAll.checked = false; chkAll.indeterminate = false; }
  atualizarBotaoLote(tab);
  toast(ids.length + ' registro(s) exclu√≠do(s)', 'info');
}

// ========== EXPORT ==========
function exportCSV(tab){
  const H={ 
    disputas:['Data','√ìrg√£o','Estado','Empresa','Tipo','RP','Processo','Sistema','Analista','LinkSistema','LinkProposta','PrevCompra','PrevVenda','Al√≠quota','Impostos','PrevLucro','%Lucro','Situa√ß√£o','Observa√ß√£o'], 
    empenhos:['Empenho','Data','√ìrg√£o','Analista','Produto','Plataforma','DataCompra','ValUnit','Qtd','Total','ValEmpenho','Al√≠quota','Imposto','Lucro','%Lucro','AReceber','Recebido','DataReceb','Observa√ß√£o'] 
  };
  const R={ 
    disputas:DB.disputas.map(r=>{const v=dVals(r); return[r.data,r.orgao,r.estado,r.empresa,r.tipo,r.rp,r.processo,r.sistema,r.analista,r.linkSistema,r.linkProposta,r.compra,r.venda,r.aliq,v.imp,v.luc,v.pct,r.situacao,r.observacao||'']; }), 
    empenhos:DB.empenhos.map(r=>{const v=eVals(r); return[r.num,r.data,r.orgao,r.analista,r.produto,r.plataforma,r.dcomp,r.vunit,r.qtd,v.tot,r.vem,r.aliq,v.imp,v.luc,v.pct,v.rec,r.recebido,r.dreceb,r.observacao||'']; }) 
  };
  const csv=[H[tab],...R[tab]].map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'})); a.download=`${tab}_${today()}.csv`; a.click(); toast('CSV exportado','success');
}

// ========== BACKUP / RESTAURAR ==========
function exportarBackup() {
  try {
    const dados = {
      disputas: DB.disputas,
      empenhos: DB.empenhos,
      initialized: true,
      exportadoEm: new Date().toLocaleString('pt-BR'),
      versao: '1.0'
    };
    const json = JSON.stringify(dados, null, 2);
    const blob = new Blob(['\ufeff' + json], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'licitacoes_backup_' + today() + '.json';
    a.style.display = 'none';
    document.body.appendChild(a);  // necess√°rio para Edge/Firefox
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
    toast('Backup exportado! ' + DB.disputas.length + ' disputas e ' + DB.empenhos.length + ' empenhos.', 'success');
  } catch(err) {
    alert('Erro ao exportar: ' + err.message);
  }
}

function importarBackup(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.disputas || !data.empenhos) { toast('Arquivo inv√°lido','error'); return; }
      DB.disputas = data.disputas;
      DB.empenhos = data.empenhos;
      save('disputas', DB.disputas);
      save('empenhos', DB.empenhos);
      renderAll();
      toast('Backup importado com sucesso!', 'success');
    } catch(err) { toast('Erro ao importar backup','error'); }
  };
  reader.readAsText(file);
}

function toast(msg,type='info'){ const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'}; const el=document.createElement('div'); el.className=`toast ${type}`; el.innerHTML=`<span>${icons[type]}</span> ${msg}`; g('toasts').appendChild(el); setTimeout(()=>el.remove(),3000); }

document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o){o.classList.remove('open');PDel=null;disputaAtiva=null;}}));

// ========== COMPRAS INDIVIDUAIS ==========
let compraEmpenhoId = null;
let compraEditId = null;
let compraMSLuc = false;
let compraMSRec = false;
let compraLoteSelecionado = null;

function togCompra(f) {
  if(f === 'luc') { compraMSLuc = !compraMSLuc; setCompraField('luc', compraMSLuc); }
  if(f === 'rec') { compraMSRec = !compraMSRec; setCompraField('rec', compraMSRec); }
  calcCompra();
}

function setCompraField(f, on) {
  const ai = g('c-'+f+'-a'); const mi = g('c-'+f+'-m'); const btn = g('tbtn-c-'+f);
  if(!ai||!mi||!btn) return;
  if(on) { ai.style.display='none'; mi.style.display='block'; btn.classList.add('on'); btn.innerHTML='<span class="dot"></span>Manual'; }
  else { ai.style.display='block'; mi.style.display='none'; btn.classList.remove('on'); btn.innerHTML='<span class="dot"></span>Auto'; }
}

function calcCompra() {
  const qtd = +gv('c-qtd') || 0;
  const vunit = +gv('c-vunit') || 0;
  const custo = +gv('c-custo') || 0;
  // Calcula total da compra: qtd comprada * valor unit√°rio
  const vtotal = qtd * vunit;
  // Atualiza campo total (readonly)
  const vtotalEl = g('c-vtotal-compra');
  if(vtotalEl) vtotalEl.value = vtotal > 0 ? vtotal.toFixed(2) : '';
  // Lucro = valor empenho proporcional √† qtd comprada - total compra - custo
  // O valor do empenho por unidade √©: vemItem / qtdEmpenho
  const vemItem = +gv('c-vem-item') || 0;
  const qtdEmpenho = +gv('c-qtd-empenho') || 1;
  const vemUnitario = qtdEmpenho > 0 ? vemItem / qtdEmpenho : 0;
  const vemProporcional = vemUnitario * qtd; // valor do empenho para a qtd comprada
  const luc = vemProporcional - vtotal - custo;
  const rec = vtotal + luc; // = vemProporcional - custo
  if(!compraMSLuc) g('c-luc-a').value = fmt(luc);
  if(!compraMSRec) g('c-rec-a').value = fmt(rec);
  // % Lucro = lucro / valor total compra
  const lucroReal = compraMSLuc ? (+gv('c-luc-m') || 0) : luc;
  const pctLucro = vtotal > 0 ? (lucroReal / vtotal * 100) : 0;
  const pctEl = g('c-pct-lucro');
  if (pctEl) pctEl.value = vtotal > 0 ? pctLucro.toFixed(1) + '%' : '‚Äî';
}

function abrirCompra(empenhoId, compraId) {
  compraEmpenhoId = empenhoId;
  compraEditId = compraId || null;
  compraMSLuc = false; compraMSRec = false;
  setCompraField('luc', false); setCompraField('rec', false);
  compraLoteSelecionado = null;
  ['c-lote-desc','c-qtd-empenho','c-vem-item','c-qtd','c-dcompra','c-plataforma','c-vunit','c-vtotal-compra','c-custo','c-dpag','c-recebido','c-obs','c-luc-m','c-rec-m'].forEach(id=>{const el=g(id);if(el)el.value='';});
  g('compra-campos').style.display = 'none';
  // Reseta painel de c√°lculo de custo
  const _painel = g('c-custo-calc-painel');
  if (_painel) _painel.style.display = 'none';
  const _calcSimples = g('c-calc-simples');
  if (_calcSimples) _calcSimples.checked = true;
  const _calcIcms = g('c-calc-icms');
  if (_calcIcms) _calcIcms.checked = false;
  const _calcCredito = g('c-calc-credito');
  if (_calcCredito) _calcCredito.value = '';
  const _calcCustoEmp = g('c-calc-custo-emp');
  if (_calcCustoEmp) _calcCustoEmp.checked = false;
  const _calcRes = g('c-calc-resultado');
  if (_calcRes) { _calcRes.textContent = '‚Äî'; _calcRes._valor = undefined; }
  
  const emp = DB.empenhos.find(x=>x.id===empenhoId); if(!emp) return;
  const disp = emp.disputaId ? DB.disputas.find(d=>d.id===emp.disputaId) : null;
  const lotes = disp ? (disp.lotes||[]) : [];
  
  // Filtra itens do empenho
  const itensEmp = (emp.itens||[]);
  
  if(!itensEmp.length) {
    g('compra-lote-selector-wrap').innerHTML = '<div style="color:var(--danger);padding:12px;">Este empenho n√£o tem itens cadastrados. Edite o empenho primeiro.</div>';
    g('modal-compra').classList.add('open');
    g('ttl-compra').textContent = compraEditId ? 'EDITAR COMPRA' : 'NOVA COMPRA';
    return;
  }
  
  g('compra-lote-selector').innerHTML = itensEmp.map(item => {
    const lote = lotes.find(l=>l.id===item.loteId) || {};
    const qtdJaComprada = (emp.compras||[]).filter(c=>c.itemId===item.id).reduce((s,c)=>s+(c.qtd||0),0);
    const saldo = Math.max(0, (item.qtd||0) - qtdJaComprada);
    const semSaldo = saldo === 0;
    return `<div class="compra-lote-btn${semSaldo?' sem-saldo':''}" onclick="${semSaldo?'':'selecionarCompraLote(\''+empenhoId+'\',\''+item.id+'\')'}" id="clote-${item.id}">
      <div style="font-weight:700;font-size:12px;">${item.descricao||lote.descricao||'‚Äî'}</div>
      <div style="font-size:10px;color:var(--text-tertiary);">${item.qtd} un ¬∑ ${fmt(item.vunit)}/un</div>
      <div style="font-size:10px;font-weight:700;color:${semSaldo?'var(--danger)':'var(--success)'};">${semSaldo?'‚úì Completo':saldo+' un. dispon√≠veis'}</div>
    </div>`;
  }).join('');
  
  g('compra-lote-selector-wrap').style.display = 'block';
  
  // Se editando, pr√©-seleciona
  if(compraEditId) {
    const compraExist = (emp.compras||[]).find(c=>c.id===compraEditId);
    if(compraExist) selecionarCompraLote(empenhoId, compraExist.itemId, compraExist);
  }
  
  g('ttl-compra').textContent = compraEditId ? 'EDITAR COMPRA' : 'NOVA COMPRA';
  g('modal-compra').classList.add('open');
}

function selecionarCompraLote(empenhoId, itemId, dadosExist) {
  compraLoteSelecionado = itemId;
  document.querySelectorAll('.compra-lote-btn').forEach(b=>b.classList.remove('selected'));
  const btn = g('clote-'+itemId); if(btn) btn.classList.add('selected');
  
  const emp = DB.empenhos.find(x=>x.id===empenhoId); if(!emp) return;
  const item = (emp.itens||[]).find(i=>i.id===itemId); if(!item) return;
  
  // Calcula qtd j√° comprada para este item (excluindo a compra em edi√ß√£o)
  const qtdJaComprada = (emp.compras||[])
    .filter(c => c.itemId === itemId && c.id !== (dadosExist?.id || null))
    .reduce((s,c) => s + (c.qtd||0), 0);
  const saldoDisponivel = Math.max(0, (item.qtd||0) - qtdJaComprada);
  
  g('c-lote-desc').value = item.descricao || '';
  g('c-qtd-empenho').value = item.qtd || 1;
  g('c-vem-item').value = ((item.qtd||1)*(item.vunit||0)).toFixed(2);
  
  // Atualiza saldo info e limite do campo qtd
  const saldoInfo = g('c-saldo-info');
  if(saldoInfo) saldoInfo.textContent = saldoDisponivel > 0 ? `¬∑ saldo: ${saldoDisponivel} un.` : '¬∑ sem saldo';
  const qtdField = g('c-qtd');
  if(qtdField) { qtdField.max = saldoDisponivel; qtdField.value = dadosExist ? dadosExist.qtd : Math.min(saldoDisponivel, item.qtd || 1); }
  
  if(dadosExist) {
    g('c-dcompra').value = dadosExist.dcompra||'';
    g('c-plataforma').value = dadosExist.plataforma||'';
    g('c-vunit').value = dadosExist.vunit||'';
    g('c-vtotal-compra').value = dadosExist.vtotal||'';
    g('c-custo').value = dadosExist.custo||'';
    g('c-dpag').value = dadosExist.dpag||'';
    g('c-recebido').value = dadosExist.recebido||'';
    g('c-obs').value = dadosExist.obs||'';
    // S√≥ ativa manual se tiver valor real (n√£o null, n√£o undefined, n√£o zero)
    if(dadosExist.lucManual !== undefined && dadosExist.lucManual !== null) { compraMSLuc = true; setCompraField('luc',true); g('c-luc-m').value = dadosExist.lucManual; }
    if(dadosExist.recManual !== undefined && dadosExist.recManual !== null) { compraMSRec = true; setCompraField('rec',true); g('c-rec-m').value = dadosExist.recManual; }
  }
  
  g('compra-campos').style.display = saldoDisponivel > 0 || dadosExist ? 'block' : 'none';
  if(saldoDisponivel === 0 && !dadosExist) {
    toast('Este item j√° est√° completamente comprado.', 'error');
    return;
  }
  calcCompra();
}

function saveCompra() {
  if(!compraLoteSelecionado) { toast('SELECIONE UM ITEM/LOTE', 'error'); return; }
  const emp = DB.empenhos.find(x=>x.id===compraEmpenhoId); if(!emp) return;
  const item = (emp.itens||[]).find(i=>i.id===compraLoteSelecionado); if(!item) return;
  
  const qtdCompra = +gv('c-qtd')||1;

  // Valida saldo usando qtd do campo QTD EMPENHO (ITEM) vis√≠vel no form
  const qtdEmpenhoItem = +gv('c-qtd-empenho') || 1;
  const qtdJaComprada = (emp.compras||[])
    .filter(c => c.itemId === compraLoteSelecionado && c.id !== (compraEditId || null))
    .reduce((s,c) => s + (c.qtd||0), 0);
  const saldoDisponivel = qtdEmpenhoItem - qtdJaComprada;
  if (qtdCompra > saldoDisponivel) {
    toast(`Saldo insuficiente: apenas ${saldoDisponivel} un. dispon√≠veis para este item.`, 'error');
    return;
  }

  const vtotal = (+gv('c-vunit')||0) * qtdCompra;
  const vemItem = +gv('c-vem-item')||0;
  const qtdEmpenho = +gv('c-qtd-empenho')||1;
  const vemUnitario = qtdEmpenho > 0 ? vemItem / qtdEmpenho : 0;
  const vemProporcional = vemUnitario * qtdCompra;
  const custo = +gv('c-custo')||0;
  const lucCalc = vemProporcional - vtotal - custo;
  const recCalc = vtotal + lucCalc;
  
  const compra = {
    id: compraEditId || uid(),
    itemId: compraLoteSelecionado,
    qtd: +gv('c-qtd')||1,
    dcompra: gv('c-dcompra') || '',
    plataforma: gv('c-plataforma').toUpperCase(),
    vunit: +gv('c-vunit')||0,
    vtotal: vtotal,
    custo: custo,
    luc: compraMSLuc ? (+gv('c-luc-m')||0) : lucCalc,
    lucManual: compraMSLuc ? (+gv('c-luc-m')||0) : null,
    rec: compraMSRec ? (+gv('c-rec-m')||0) : recCalc,
    recManual: compraMSRec ? (+gv('c-rec-m')||0) : null,
    dpag: gv('c-dpag') || '',
    recebido: +gv('c-recebido')||0,
    obs: gv('c-obs').toUpperCase()
  };
  
  if(!emp.compras) emp.compras = [];
  const idx = emp.compras.findIndex(c=>c.id===compra.id);
  if(idx !== -1) emp.compras[idx] = compra; else emp.compras.push(compra);
  // Fecha modal ANTES de salvar (evita race condition com onSnapshot do Firebase)
  const _empId = compraEmpenhoId;
  closeModal('compra');
  save('empenhos', DB.empenhos);
  toast(compraEditId ? 'COMPRA ATUALIZADA ‚úì' : 'COMPRA SALVA ‚úì', 'success');
  renderAll();
  setTimeout(()=>abrirPopupEmpenho(_empId), 150);
}

function delCompra(empenhoId, compraId) {
  const emp = DB.empenhos.find(x=>x.id===empenhoId); if(!emp) return;
  emp.compras = (emp.compras||[]).filter(c=>c.id!==compraId);
  save('empenhos', DB.empenhos);
  toast('COMPRA EXCLU√çDA', 'info');
  renderAll();
  setTimeout(()=>abrirPopupEmpenho(empenhoId), 100);
}

// ========== M√öLTIPLOS ITENS NO EMPENHO ==========
// Os itens do empenho s√£o refer√™ncias aos lotes da disputa com quantidade e valor espec√≠ficos
// J√° implementado via lotesSelecionados - mas precisamos permitir m√∫ltiplos


// ========== CALCULADORA R√ÅPIDA ==========
const ICMS_ESTADOS = {
  AC:7,AL:7,AM:7,AP:7,BA:7,CE:7,DF:7,ES:7,GO:7,MA:7,MT:7,
  MG:18,PA:7,PB:7,PR:12,PE:7,PI:7,RN:7,RS:12,RJ:12,
  RO:7,RR:7,SC:12,SP:12,SE:7,TO:7
};

let calcDisputaSelecionada = null;
let calcItemParaAdicionar = null; // item clicado aguardando qtd/vcompra
let calcItensCalculo = [];        // array de {item, qtd, vcompra}

function abrirCalculadora() {
  calcDisputaSelecionada = null;
  calcItemParaAdicionar = null;
  calcItensCalculo = [];
  g('calc-passo1').style.display = '';
  g('calc-passo2').style.display = 'none';
  g('calc-busca-disputa').value = '';
  calcFiltrarDisputas();
  g('modal-calc').classList.add('open');
}

function calcFiltrarDisputas() {
  const q = (g('calc-busca-disputa').value || '').toLowerCase();
  const lista = g('calc-lista-disputas');
  const disputas = DB.disputas.filter(d => {
    if (!q) return true;
    return (d.orgao||'').toLowerCase().includes(q) ||
           (d.processo||'').toLowerCase().includes(q) ||
           (d.estado||'').toLowerCase().includes(q);
  });
  if (!disputas.length) {
    lista.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px;font-size:13px;">Nenhuma disputa encontrada</div>';
    return;
  }
  lista.innerHTML = disputas.map(d => {
    const empCount = DB.empenhos.filter(e => e.disputaId === d.id).length;
    const cor = d.empresa === 'Hamate' ? '#7c3aed' : '#2563eb';
    return `<div onclick="calcSelecionarDisputa('${d.id}')" style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:2px solid var(--border-light);border-radius:10px;cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='${cor}'" onmouseout="this.style.borderColor='var(--border-light)'">
      <div>
        <div style="font-weight:700;font-size:13px;">${d.orgao} ¬∑ ${d.estado}</div>
        <div style="font-size:11px;color:var(--text-secondary);">${d.processo||'‚Äî'} ¬∑ ${d.tipo||''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center;">
        <span style="font-size:11px;padding:2px 8px;border-radius:12px;background:${cor}20;color:${cor};font-weight:700;">${d.empresa}</span>
        <span style="font-size:10px;color:var(--text-tertiary);">${empCount} empenho(s)</span>
      </div>
    </div>`;
  }).join('');
}

function calcSelecionarDisputa(id) {
  const d = DB.disputas.find(x => x.id === id);
  if (!d) return;
  calcDisputaSelecionada = d;
  calcItemParaAdicionar = null;
  calcItensCalculo = [];

  g('calc-disputa-titulo').textContent = d.orgao + ' ¬∑ ' + d.processo;
  const badge = g('calc-empresa-badge');
  if (d.empresa === 'Hamate') {
    badge.textContent = 'Hamate';
    badge.style.cssText = 'font-size:11px;padding:2px 8px;border-radius:12px;background:#7c3aed20;color:#7c3aed;font-weight:700;';
  } else {
    badge.textContent = 'Gadita';
    badge.style.cssText = 'font-size:11px;padding:2px 8px;border-radius:12px;background:#2563eb20;color:#2563eb;font-weight:700;';
  }

  g('calc-tipo-gadita').style.display = d.empresa === 'Gadita' ? '' : 'none';
  g('calc-pct-simples').value = d.empresa === 'Hamate' ? 9 : 13.5;
  g('calc-estado-display').textContent = (d.estado || '‚Äî');
  const icms = ICMS_ESTADOS[d.estado] || 7;
  g('calc-icms-display').textContent = icms + '%';
  g('calc-credito-icms').value = '';
  g('calc-custo-empresa').checked = false;

  // Montar lista de itens
  const empenhos = DB.empenhos.filter(e => e.disputaId === id);
  let itens = [];
  empenhos.forEach(emp => {
    (emp.itens || []).forEach(item => {
      if (!itens.find(x => x.itemId === item.id)) {
        const _vu = item.vunit || (item.vtotal && item.qtd ? item.vtotal/item.qtd : 0) || emp.vunit || 0;
        itens.push({ itemId: item.id, empId: emp.id, descricao: item.descricao||item.loteDesc||'Item', qtd: item.qtd||1, vunit: _vu });
      }
    });
    if (!(emp.itens||[]).length) {
      const _vu = emp.vunit || (emp.qtd ? emp.vem/emp.qtd : emp.vem) || 0;
      itens.push({ itemId: emp.id, empId: emp.id, descricao: emp.produto||'Empenho #'+emp.num, qtd: emp.qtd||1, vunit: _vu });
    }
  });
  calcItensDisputa = itens;

  const listaEl = g('calc-itens-lista');
  if (!itens.length) {
    listaEl.innerHTML = '<div style="color:var(--text-tertiary);font-size:12px;">Nenhum item encontrado nos empenhos desta disputa.</div>';
  } else {
    listaEl.innerHTML = itens.map(it =>
      `<div onclick="calcAbrirFormItem('${it.itemId}')" id="calc-item-${it.itemId}" style="padding:8px 12px;border:2px solid var(--border-light);border-radius:8px;cursor:pointer;font-size:12px;transition:all .15s;min-width:180px;flex:1;">
        <div style="font-weight:700;">${it.descricao}</div>
        <div style="color:var(--text-secondary);font-size:11px;">Qtd: ${it.qtd} ¬∑ R$ ${it.vunit.toFixed(2).replace('.',',')} /un</div>
      </div>`
    ).join('');
  }

  g('calc-form-item').style.display = 'none';
  g('calc-itens-adicionados-wrap').style.display = 'none';
  g('calc-resultado-wrap').style.display = 'none';
  g('calc-icms-detalhes').innerHTML = '';
  g('calc-passo1').style.display = 'none';
  g('calc-passo2').style.display = '';
  calcTipoChanged();
}

let calcItensDisputa = [];

function calcAbrirFormItem(itemId) {
  const it = calcItensDisputa.find(x => x.itemId === itemId);
  if (!it) return;
  calcItemParaAdicionar = it;

  // Highlight
  document.querySelectorAll('[id^="calc-item-"]').forEach(el => {
    el.style.borderColor = 'var(--border-light)'; el.style.background = '';
  });
  const el = g('calc-item-' + itemId);
  if (el) { el.style.borderColor = '#2563eb'; el.style.background = '#2563eb10'; }

  g('calc-form-item-titulo').textContent = 'Ôºã ' + it.descricao;
  g('calc-form-qtd').value = it.qtd;
  g('calc-form-vcompra').value = '';
  g('calc-form-item').style.display = '';
  g('calc-form-vcompra').focus();
}

function calcFecharFormItem() {
  g('calc-form-item').style.display = 'none';
  calcItemParaAdicionar = null;
  document.querySelectorAll('[id^="calc-item-"]').forEach(el => {
    el.style.borderColor = 'var(--border-light)'; el.style.background = '';
  });
}

function calcAdicionarItem() {
  const it = calcItemParaAdicionar;
  if (!it) return;
  const qtd = +g('calc-form-qtd').value || 1;
  const vcompra = +g('calc-form-vcompra').value || 0;

  // Se j√° existe o mesmo item, atualiza
  const existing = calcItensCalculo.findIndex(x => x.item.itemId === it.itemId);
  if (existing !== -1) {
    calcItensCalculo[existing] = { item: it, qtd, vcompra };
  } else {
    calcItensCalculo.push({ item: it, qtd, vcompra });
  }

  calcFecharFormItem();
  calcRenderTabela();
  calcRecalcular();
}

function calcRemoverItemCalculo(itemId) {
  calcItensCalculo = calcItensCalculo.filter(x => x.item.itemId !== itemId);
  calcRenderTabela();
  calcRecalcular();
}

function calcLimparItens() {
  calcItensCalculo = [];
  calcRenderTabela();
  calcRecalcular();
}

function calcGetTipo() {
  const d = calcDisputaSelecionada;
  if (!d) return 'simples';
  if (d.empresa !== 'Gadita') return 'simples';
  const radio = document.querySelector('input[name="calc-tipo"]:checked');
  return (radio && radio.value === 'novo') ? 'icms' : 'simples';
}

function calcCustoItem(vemTotal, tipo, d) {
  const pct = (+g('calc-pct-simples').value || 0) / 100;
  if (tipo === 'simples') return vemTotal * pct;
  // ICMS
  const icmsPct = (ICMS_ESTADOS[d.estado] || 7) / 100;
  const icmsVal   = vemTotal * icmsPct;
  const pisVal    = vemTotal * 0.0065;
  const cofinsVal = vemTotal * 0.03;
  const irpjVal   = vemTotal * 0.08 * 0.15;
  const csllVal   = (vemTotal * 0.12) * 0.09;   // ‚Üê (base√ó12%)√ó9%
  const empVal    = g('calc-custo-empresa').checked ? vemTotal * 0.03 : 0;
  return icmsVal + pisVal + cofinsVal + irpjVal + csllVal + empVal;
  // cr√©dito ICMS √© abatido no total, n√£o por item
}

function calcRenderTabela() {
  const wrap = g('calc-itens-adicionados-wrap');
  if (!calcItensCalculo.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = '';
  const d = calcDisputaSelecionada;
  const tipo = calcGetTipo();

  let rows = '';
  calcItensCalculo.forEach(({ item, qtd, vcompra }) => {
    const vemTotal = item.vunit * qtd;
    const vcompraTotal = vcompra * qtd;
    const custo = calcCustoItem(vemTotal, tipo, d);
    const lucro = vemTotal - vcompraTotal - custo;
    rows += `<tr style="border-bottom:1px solid var(--border-light);">
      <td style="padding:6px 8px;font-weight:600;">${item.descricao}</td>
      <td style="padding:6px 8px;text-align:right;">${qtd}</td>
      <td style="padding:6px 8px;text-align:right;font-family:monospace;">${fmt(item.vunit)}</td>
      <td style="padding:6px 8px;text-align:right;font-family:monospace;">${vcompra ? fmt(vcompra) : '‚Äî'}</td>
      <td style="padding:6px 8px;text-align:right;font-family:monospace;color:var(--accent-primary);">${fmt(vemTotal)}</td>
      <td style="padding:6px 8px;text-align:right;font-family:monospace;color:var(--warning);">${fmt(custo)}</td>
      <td style="padding:6px 8px;text-align:right;font-family:monospace;color:${lucro>=0?'var(--success)':'var(--danger)'};">${fmt(lucro)}</td>
      <td style="padding:6px 4px;text-align:center;"><button onclick="calcRemoverItemCalculo('${item.itemId}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;" title="Remover">üóë</button></td>
    </tr>`;
  });
  g('calc-itens-tbody').innerHTML = rows;
}

function calcTipoChanged() {
  const tipo = calcGetTipo();
  g('calc-bloco-simples').style.display = tipo === 'simples' ? '' : 'none';
  g('calc-bloco-icms-info').style.display = tipo === 'icms' ? '' : 'none';
  g('calc-bloco-icms-opts').style.display = tipo === 'icms' ? '' : 'none';
  if (tipo === 'simples') {
    const d = calcDisputaSelecionada;
    g('calc-pct-simples').value = d ? (d.empresa === 'Hamate' ? 9 : 13.5) : 9;
  }
  calcRenderTabela();
  calcRecalcular();
}

function calcVoltarPasso1() {
  g('calc-passo1').style.display = '';
  g('calc-passo2').style.display = 'none';
  calcDisputaSelecionada = null;
  calcItemParaAdicionar = null;
  calcItensCalculo = [];
}

function calcLimparResultado() {
  ['calc-res-vem','calc-res-custo','calc-res-lucro','calc-res-margem'].forEach(id => { g(id).textContent = '‚Äî'; });
  g('calc-resultado-wrap').style.display = 'none';
}

function calcRecalcular() {
  const d = calcDisputaSelecionada;
  if (!d || !calcItensCalculo.length) { calcLimparResultado(); return; }

  const tipo = calcGetTipo();
  const creditoICMS = tipo === 'icms' ? (+g('calc-credito-icms').value || 0) : 0;

  let totalVem = 0, totalCusto = 0, totalCompra = 0;
  calcItensCalculo.forEach(({ item, qtd, vcompra }) => {
    const vemTotal = item.vunit * qtd;
    totalVem += vemTotal;
    totalCompra += vcompra * qtd;
    totalCusto += calcCustoItem(vemTotal, tipo, d);
  });
  totalCusto -= creditoICMS;

  const lucro = totalVem - totalCompra - totalCusto;
  const margem = totalCompra > 0 ? (lucro / totalCompra * 100) : 0;

  g('calc-resultado-wrap').style.display = '';
  g('calc-res-vem').textContent = fmt(totalVem);
  g('calc-res-custo').textContent = fmt(totalCusto);
  g('calc-res-lucro').textContent = fmt(lucro);
  g('calc-res-lucro').style.color = lucro >= 0 ? 'var(--success)' : 'var(--danger)';
  g('calc-res-margem').textContent = margem.toFixed(1) + '%';
  g('calc-res-margem').style.color = margem >= 0 ? 'var(--success)' : 'var(--danger)';

  // Detalhamento ICMS (sobre total)
  if (tipo === 'icms') {
    const icmsPct = ICMS_ESTADOS[d.estado] || 7;
    const icmsVal   = totalVem * (icmsPct/100);
    const pisVal    = totalVem * 0.0065;
    const cofinsVal = totalVem * 0.03;
    const irpjVal   = totalVem * 0.08 * 0.15;
    const csllVal   = (totalVem * 0.12) * 0.09;
    const empVal    = g('calc-custo-empresa').checked ? totalVem * 0.03 : 0;
    let linhas = [
      [`ICMS (${icmsPct}%)`, icmsVal],
      ['PIS (0,65%)', pisVal],
      ['COFINS (3%)', cofinsVal],
      ['IRPJ (Base√ó8%√ó15%)', irpjVal],
      ['CSLL (Base√ó12%√ó9%)', csllVal],
    ];
    if (empVal) linhas.push(['Custo Empresa (3%)', empVal]);
    if (creditoICMS) linhas.push(['(-) Cr√©dito ICMS', -creditoICMS]);
    g('calc-icms-detalhes').innerHTML = linhas.map(([label, val]) =>
      `<div style="display:flex;justify-content:space-between;padding:2px 0;"><span>${label}</span><span style="font-weight:600;color:${val<0?'var(--success)':'var(--warning)'};">${val<0?'- ':''}R$ ${Math.abs(val).toFixed(2).replace('.',',')}</span></div>`
    ).join('');
  } else {
    g('calc-icms-detalhes').innerHTML = '';
  }

  // Atualiza tabela com novos custos calculados
  calcRenderTabela();
}


// ========== C√ÅLCULO DE CUSTO NO MODAL DE COMPRA ==========
function calcCustoAutomatico() {
  const emp = DB.empenhos.find(x => x.id === compraEmpenhoId);
  if (!emp) return;
  const disp = emp.disputaId ? DB.disputas.find(d => d.id === emp.disputaId) : null;
  const painel = g('c-custo-calc-painel');
  painel.style.display = '';

  // Define empresa e ajusta op√ß√µes
  const empresa = disp ? disp.empresa : 'Hamate';
  const estado  = disp ? (disp.estado || '') : '';
  const icmsLbl = g('c-calc-icms-lbl');

  // Mostra op√ß√£o ICMS s√≥ para Gadita
  if (empresa === 'Gadita') {
    icmsLbl.style.display = '';
    g('c-calc-empresa-info').textContent = 'Gadita ¬∑ ' + estado;
    g('c-calc-estado-label').textContent = 'Estado: ' + estado;
    const icmsPct = ICMS_ESTADOS[estado] || 7;
    g('c-calc-icms-label').textContent = 'ICMS: ' + icmsPct + '%';
    // Padr√£o: antigo (simples 13,5%)
    g('c-calc-simples').checked = true;
    g('c-calc-pct').value = 13.5;
  } else {
    icmsLbl.style.display = 'none';
    g('c-calc-simples').checked = true;
    g('c-calc-empresa-info').textContent = 'Hamate';
    g('c-calc-pct').value = 9;
  }
  g('c-calc-credito').value = '';
  g('c-calc-custo-emp').checked = false;
  calcCustoRecalcular();
}

function calcCustoRecalcular() {
  const tipo = document.querySelector('input[name="c-calc-tipo"]:checked')?.value || 'simples';
  g('c-calc-bloco-simples').style.display = tipo === 'simples' ? '' : 'none';
  g('c-calc-bloco-icms').style.display  = tipo === 'icms'    ? '' : 'none';

  // Base = vl empenho do item √ó qtd comprando
  const vemItem   = +gv('c-vem-item') || 0;
  const qtdEmp    = +gv('c-qtd-empenho') || 1;
  const qtdCompra = +gv('c-qtd') || 1;
  const vunitEmp  = qtdEmp > 0 ? vemItem / qtdEmp : 0;
  const base      = vunitEmp * qtdCompra;

  if (base <= 0) { g('c-calc-resultado').textContent = '‚Äî'; return; }

  let custo = 0;
  if (tipo === 'simples') {
    const pct = (+g('c-calc-pct').value || 0) / 100;
    custo = base * pct;
  } else {
    const emp  = DB.empenhos.find(x => x.id === compraEmpenhoId);
    const disp = emp?.disputaId ? DB.disputas.find(d => d.id === emp.disputaId) : null;
    const estado = disp?.estado || '';
    const icmsPct    = (ICMS_ESTADOS[estado] || 7) / 100;
    const icmsVal    = base * icmsPct;
    const pisVal     = base * 0.0065;
    const cofinsVal  = base * 0.03;
    const irpjVal    = base * 0.08 * 0.15;
    const csllVal    = (base * 0.12) * 0.09;
    const empVal     = g('c-calc-custo-emp').checked ? base * 0.03 : 0;
    const credito    = +g('c-calc-credito').value || 0;
    custo = icmsVal + pisVal + cofinsVal + irpjVal + csllVal + empVal - credito;
  }

  g('c-calc-resultado').textContent = 'R$ ' + custo.toFixed(2).replace('.', ',');
  g('c-calc-resultado')._valor = custo;
}

function calcCustoAplicar() {
  const custo = g('c-calc-resultado')._valor;
  if (custo === undefined || custo === null) return;
  g('c-custo').value = custo.toFixed(2);
  g('c-custo-calc-painel').style.display = 'none';
  calcCompra(); // recalcula lucro com novo custo
}


// ========== DISPUTAS FINALIZADAS ==========
function finalizarDisputa(id) {
  const d = DB.disputas.find(x => x.id === id);
  if (!d) return;
  if (!confirm('Finalizar a disputa "' + (d.orgao||id) + '"?\nEla ser√° movida para a aba Finalizadas.')) return;
  d.finalizada = true;
  d.dataFinalizacao = new Date().toISOString().slice(0,10);
  save('disputas', DB.disputas);
  renderAll();
  toast('Disputa finalizada! ‚úÖ', 'success');
}

function reabrirDisputa(id) {
  const d = DB.disputas.find(x => x.id === id);
  if (!d) return;
  if (!confirm('Reabrir a disputa "' + (d.orgao||id) + '"?\nEla voltar√° para Disputas Vencidas.')) return;
  d.finalizada = false;
  d.dataFinalizacao = null;
  save('disputas', DB.disputas);
  renderAll();
  toast('Disputa reaberta!', 'info');
}

function renderFinalizadas() {
  const q = (g('search-finalizadas')?.value || '').toLowerCase();
  const rows = DB.disputas.filter(d => {
    if (!d.finalizada) return false;
    if (!q) return true;
    return (d.orgao||'').toLowerCase().includes(q) || (d.processo||'').toLowerCase().includes(q) || (d.estado||'').toLowerCase().includes(q);
  }).sort((a,b) => (b.dataFinalizacao||'').localeCompare(a.dataFinalizacao||''));

  const tb = g('tbody-finalizadas');
  if (!rows.length) {
    tb.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="icon">‚úÖ</div><p>Nenhuma disputa finalizada</p></div></td></tr>';
    sumFinalizadas(rows);
    return;
  }
  tb.innerHTML = rows.map(r => {
    const contrato = getValorContrato(r);
    const emps = DB.empenhos.filter(e => e.disputaId === r.id);
    const lucroRec = emps.reduce((s,e) =>
      s + (e.compras||[]).filter(c=>c.dpag&&c.dpag!=='').reduce((ss,c)=> {
        const luc = (c.luc!==undefined&&c.luc!==null) ? c.luc : (c.rec||0)-(c.vtotal||0)-(c.custo||0);
        return ss+luc;
      },0), 0);
    return '<tr style="cursor:pointer;" onclick="abrirPopupDisputa(\'' + r.id + '\')">' +
      '<td class="mono" style="font-size:11px;">' + fmtD(r.data) + '</td>' +
      '<td><div style="font-weight:600;font-size:13px;">' + (r.orgao||'‚Äî') + '</div><span class="estado-badge" style="font-size:9px;">' + (r.estado||'‚Äî') + '</span></td>' +
      '<td><span class="badge ' + (r.analista==='M√°rdea'?'bp':'bb') + '" style="font-size:10px;">' + (r.analista||'‚Äî') + '</span></td>' +
      '<td><span style="font-size:11px;padding:2px 7px;border-radius:10px;font-weight:700;background:' + (r.empresa==='Hamate'?'#7c3aed20':'#2563eb20') + ';color:' + (r.empresa==='Hamate'?'#7c3aed':'#2563eb') + ';">' + (r.empresa||'‚Äî') + '</span></td>' +
      '<td class="mono" style="color:var(--accent-primary);font-weight:600;">' + fmt(contrato) + '</td>' +
      '<td class="mono" style="color:var(--success);font-weight:600;">' + fmt(lucroRec) + '</td>' +
      '<td class="mono" style="font-size:11px;color:var(--text-tertiary);">' + fmtD(r.dataFinalizacao) + '</td>' +
      '<td onclick="event.stopPropagation()">' +
        '<button class="btn btn-ghost btn-sm" onclick="abrirPopupDisputa(\'' + r.id + '\')" title="Ver detalhes">üîç</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="reabrirDisputa(\'' + r.id + '\')" title="Reabrir disputa" style="color:var(--warning);border-color:var(--warning);">‚Ü©Ô∏è Reabrir</button>' +
      '</td></tr>';
  }).join('');
  sumFinalizadas(rows);
}

function sumFinalizadas(rows) {
  const tv = rows.reduce((s,r) => s + getValorContrato(r), 0);
  const lucroTotal = rows.reduce((s,r) => {
    const emps = DB.empenhos.filter(e => e.disputaId === r.id);
    return s + emps.reduce((s2,e) =>
      s2 + (e.compras||[]).filter(c=>c.dpag&&c.dpag!=='').reduce((ss,c)=>{
        const luc = (c.luc!==undefined&&c.luc!==null)?c.luc:(c.rec||0)-(c.vtotal||0)-(c.custo||0);
        return ss+luc;
      },0), 0);
  }, 0);
  const el = g('sum-finalizadas');
  if (el) el.innerHTML =
    '<div class="card"><div class="card-label">Finalizadas</div><div class="card-value cv-green">' + rows.length + '</div></div>' +
    '<div class="card"><div class="card-label">Valor Contratado</div><div class="card-value cv-blue">' + fmt(tv) + '</div></div>' +
    '<div class="card"><div class="card-label">Lucro Recebido</div><div class="card-value cv-green">' + fmt(lucroTotal) + '</div></div>';
}


// ===== BOOT =====
// Com Firebase, o boot √© feito pelo onAuthStateChanged acima.
// Apenas inicializa o app com dados vazios (ser√£o carregados ap√≥s login).
function boot() {
  inicializarApp({ disputas: [], empenhos: [], initialized: true });
}

boot();

</script>

<!-- POPUP DETALHES DISPUTA -->
<div class="detail-popup-overlay" id="popup-disputa">
  <div class="detail-popup">
    <div class="detail-popup-header">
      <div>
        <div class="detail-popup-title" id="popup-d-title">Detalhes da Disputa</div>
        <div class="detail-popup-sub" id="popup-d-sub"></div>
      </div>
      <button class="detail-close" onclick="fecharPopup('disputa')">‚úï</button>
    </div>
    <div id="popup-d-body"></div>
    <div class="detail-actions">
      <button class="btn btn-ghost" onclick="fecharPopup('disputa')">Fechar</button>
      <button class="btn btn-success" id="popup-d-new-emp-btn" style="background:var(--success);color:#fff;border:none;">Ôºã Novo Empenho</button>
      <button class="btn btn-primary" id="popup-d-edit-btn">‚úèÔ∏è Editar</button>
    </div>
  </div>
</div>

<!-- POPUP DETALHES EMPENHO -->
<div class="detail-popup-overlay" id="popup-empenho">
  <div class="detail-popup">
    <div class="detail-popup-header">
      <div>
        <div class="detail-popup-title" id="popup-e-title">Detalhes do Empenho</div>
        <div class="detail-popup-sub" id="popup-e-sub"></div>
      </div>
      <button class="detail-close" onclick="fecharPopup('empenho')">‚úï</button>
    </div>
    <div id="popup-e-body"></div>
    <div class="detail-actions">
      <button class="btn btn-ghost" onclick="fecharPopup('empenho')">Fechar</button>
      <button class="btn btn-primary" id="popup-e-edit-btn">‚úèÔ∏è Editar</button>
    </div>
  </div>
</div>
</body>
</html>